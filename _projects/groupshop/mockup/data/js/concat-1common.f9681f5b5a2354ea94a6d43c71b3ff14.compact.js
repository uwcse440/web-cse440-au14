var project={isInitialized:false,isModified:false,activeProjectTooltip:"",autoPreviewTimeout:300000,inactiveProjectTooltip:"This project is inactive. Editing is disabled.",colors:{hStart:5,hEnd:210,s:"90%",l:"50%"},unloadedProps:["name","created","updated","active","preview"],recentProjectDays:15,lastProjectClosed:false,orient:function(h,b){var b=h!=undefined?$(h.target).attr("data-for"):b;var c=project.get("pageWH");var k=parseInt(c[0],10);var j=parseInt(c[1],10);var d=Math.min(k,j);var l=Math.max(k,j);c=b=="Portrait"?[d,l]:[l,d];project.set({orientation:b});project.set({pageWH:c});var a=project.get("pages");for(var f in a){page.update({orientation:b,width:c[1],height:c[0]},a[f])}$(".screen").each(page.resizeAfterOrient);hint.show("library");page.updateOptionsMenu()},isMultiOrientation:function(){var d=project.get("pages");var f=project.get("orientation");var c=false;if(d){for(var b=0,a=d.length;b<a;b++){var e=page.get(d[b],"orientation");if(e!=f){c=true;break}}}return c},setNumber:function(b,d){var c=fluid.main.projects.filter(function(f,e,h){if(f.get("removed")){return false}return true}).length;var a="All Projects ("+c+")";$(".projectSettingsButton").removeClass("buttonDisabled").find("span").text(a);$("#logout").removeClass("hidden")},hoverIn:function(){$(this).children(".foreground").addClass("projectHover");$(this).children(".popOutPage").addClass("popOutPageHover")},hoverOut:function(){$(this).children(".foreground").removeClass("projectHover");$(this).children(".popOutPage").removeClass("popOutPageHover")},_template:function(a,c){a["id"]=c;a["name"]=a.name||"New Project";a["date"]=fluid.i18n.formatDate(a.created);a["dateCreate"]=moment(a.created).format("YYYY/MM/DD HH:mm:ss");a["dateUpdate"]=moment(a.updated).format("YYYY/MM/DD HH:mm:ss");a["tooltip"]=a.active===false?project.inactiveProjectTooltip:project.activeProjectTooltip;a["nameLower"]=a.name.toLowerCase();var b=$("#tmplProjectThumb").tmpl(a);if(a.active===false){b.addClass("inactivePrj")}else{b.addClass("activePrj")}b.insertAfter("#projectAdd");projectSettings.updateThumbnail(c);delete a["dateCreate"];delete a["dateUpdate"];delete a["nameLower"];return b},hasWidgets:function(){var b=account.get("lastOpenProject");var c=storage.get(b);var a=false;if((c)&&(c.pages)){$.each(c.pages,function(d,f){var e=page.get(f,"widgets");if((e)&&(e.length>0)){a=true;return false}})}return a},hasLinks:function(){return(fluid.main.project&&fluid.main.project.links&&fluid.main.project.links.length)?true:false},get:function(b){var a=(typeof account!=="undefined")&&account.get("lastOpenProject");if(b=="id"){return a}var c=storage.get(a);if(!c){if(b=="pages"){return[]}return null}return c[b]},set:function(a){var b=account.get("lastOpenProject");project.loadIfUnloaded(b,function(){var c=storage.get(b);if(!c){return}for(var d in a){c[d]=a[d]}storage.set(b,c)})},changeScreenSize:function(j,b){if(typeof b==="object"){var h=b[0];var a=b[1]}else{var h=parseInt($(".screenSize").filter(".width").val());var a=parseInt($(".screenSize").filter(".height").val())}var f=50;var i=50;if((isNaN(h))||(isNaN(a))){h=project.get("pageWH")[0];a=project.get("pageWH")[1];$(".screenSize").filter(".width").val(h);$(".screenSize").filter(".height").val(a)}else{h=h<f?f:h;a=a<i?i:a;h=parseInt(h,10);a=parseInt(a,10);project.set({"pageWH":[h,a]});var c=a>=h?"Portrait":"Landscape";project.orient(null,c)}hint.show("library");staticWidgets.zoomInBoundary();var d=$("#canvasPages .screen.active").attr("id");if(d){fluid.zoom.zoomToPage({pageId:d})}else{fluid.zoom.zoomToAllPages()}},save:function(){var b=project.get("id");var a=storage.get(b);a.updated=new Date().getTime();storage.set(b,a)},dragStart:function(o,j){var d=$(this).hasClass("inactiveProject");var c=$("#projects").outerHeight();var a=$("#projects").closest(".viewport").height();var m=$("#projects").parent().position().top;var e=d?$("#projectList"):$("#inactiveProjectList");var p=e.outerHeight();var k=e.children("h2, h3, h4, h5");var l=k.outerHeight(true)||50;var n=d?m+p:p-c+a-m;var s=n<l;var f=0;if(s){var q=d?-1:1;f=q*(n-l-k.position().top);if(d){f+=2;k.css({"-webkit-transform":"translate(0, "+(p-l-8)+"px)","-moz-transform":"translate(0, "+(p-l-8)+"px)"});e.children(".addProject, .project").css({"-webkit-transform":"translate(0, -"+(k.outerHeight()||0)+"px)","-moz-transform":"translate(0, -"+(k.outerHeight()||0)+"px)"})}e.removeClass("bouncing").css({"top":n<0?n+4+"px":"","z-index":1}).addClass("bouncing scrolledIntoView");var b=parseInt(e.css("-webkit-transition-duration"));var i=n>=0?n/l:1;b=b*i+(b>1?"ms":"s");e.css({"top":f+"px","-webkit-transition-duration":b,"-moz-transition-duration":b,"-webkit-animation-delay":b,"-moz-animation-delay":b});var h=$("#projects .project").first().outerHeight(true)||0;var r=f-q*h;$("#projects").data("popoutAreaHeight",h).data("popoutTranslateTop",r)}$("#projects").data("showDest",s)},drag:function(b,j){var i=$(this);var h=$("#fluidDropdown .viewport");if($("#projects").is(":visible")&&utils.isMouseOver(b,h)){var a=$(this).hasClass("inactiveProject");var f=a?$("#projectList"):$("#inactiveProjectList");var e=$("#projects");var k=e.data("popoutAreaHeight");var d=e.data("popoutTranslateTop");var c=utils.relativeMousePos(b,h).top;if(e.data("showDest")&&((a&&c<k)||(!a&&h.height()-c<k))){f.removeClass("bouncing").css({"top":d+"px","-webkit-transition":"top 0.2s ease-in-out","-moz-transition":"top 0.2s ease-in-out"}).bind("webkitTransitionEnd",function(){f.unbind("webkitTransitionEnd")})}project._updateDroppables(b,i)}else{$("#projectList, #inactiveProjectList").removeClass("hover")}if(intersectTrash(i.data().draggable.helper)==true){$("#trash").addClass("droppableStyle")}else{$("#trash").removeClass("droppableStyle")}},_updateDroppables:function(c,b){var a=[{elem:$("#projectList"),accept:".inactiveProject"},{elem:$("#inactiveProjectList"),accept:".project:not(.inactiveProject)"}];$.each(a,function(d,f){var e=f.elem;if(utils.isMouseOver(c,e)&&b&&b.is(f.accept)){if(!e.hasClass("hover")){e.addClass("hover")}}else{if(e.hasClass("hover")){e.removeClass("hover")}}})},dragStop:function(a){$("#projectList, #inactiveProjectList").removeClass("hover");$("#projects").data("showDest",false);var b=$(this).hasClass("inactiveProject")?$("#projectList"):$("#inactiveProjectList");b.removeClass("bouncing").animate({"top":"0px"},200,function(){b.removeClass("scrolledIntoView").children("h2, h3, h4, h5, .addProject, .project").removeAttr("style")});$("#trash").removeClass("droppableStyle")},dropToActive:function(b,a){var a=a==undefined?false:true;var c=false;if(fluid.main.fire("project.beforeActivate")&&!a){if(project.isOpen(b)){notification.removeAll("alert","projectInactive")}notification.removeAll("alert","projectLimit");project._handleActiveInactiveDrop(b,false);tracker.record("dropActive",1);projectSettings.getItemById(b).removeClass("inactivePrj").addClass("activePrj");projectSettings.displayStatus(true);projectSettings.applyFilter();projectSettings.actionLoadVersions();$("#canvasPages .pageWidget").draggable("option","disabled",false);c=true}page.displayMenu();setTimeout(hint.restart,600);$("#projectList, #inactiveProjectList").removeClass("hover");return c},dropToInactive:function(a){var b=false;project._handleActiveInactiveDrop(a,true);notification.removeAll("alert","projectLimit");tracker.record("dropInactive",1);hint.cleanup();page.displayMenu(false);$("#projectList, #inactiveProjectList").removeClass("hover");projectSettings.getItemById(a).addClass("inactivePrj").removeClass("activePrj");projectSettings.applyFilter();$("#canvasPages .pageWidget").draggable("option","disabled",true);b=true;return b},_handleActiveInactiveDrop:function(b,a){project.loadIfUnloaded(b,function(){var c=storage.get(b);c.active=!a;c.updated=new Date().getTime();storage.set(b,c);if(b==account.get("lastOpenProject")){project.isModified=true}project.sync(b);project.setNumber()})},updateInactiveProjectList:function(){var h=$("#inactiveProjectList");var f=h.find(".inactiveProject");var b=h.children(".promptContainer");var a=b.css("display")!="none";var e=b.is(":visible");if(f.size()==0){if(!a){if(e){b.fadeIn(300)}else{b.show()}}}else{if(a){if(e){b.fadeOut(300)}else{b.hide()}}}var c=h.find(".projectPlaceholder");var d=c.size();c.hide().slice(-1*(d-f.size()%d)).fadeIn(300);h.removeWhitespace()},isEmpty:function(b){if(b===undefined||b===null){b=account.get("lastOpenProject")}var a=storage.get(b);return !a||!a.pages||a.pages.length==0},unbundle:function(a,b){b(a)},checkIntegrity:function(b){var e=storage.get(b);if(e.unloaded){delete e.unloaded}project.save();if(!e){account.logout();localStorage.setItem("postloadMessage","loginAgain");location.reload()}if(!project.get("canvasWidth")){project.set({canvasWidth:24004})}if(!project.get("canvasHeight")){project.set({canvasHeight:16004})}if(!project.get("canvasPosX")&&project.get("canvasPosX")!==0){project.set({canvasPosX:1000})}if(!project.get("canvasPosY")&&project.get("canvasPosY")!==0){project.set({canvasPosY:1000})}if(typeof project.get("lastTransition")==="undefined"){project.set({"lastTransition":"pop"})}if(typeof project.get("pageWH")==="undefined"){project.set({"pageWH":[320,480]})}if(typeof project.get("orientation")==="undefined"){project.set({"orientation":"Portrait"})}if(typeof project.get("defaultTransition")==="undefined"){project.set({"defaultTransition":"slide"})}if(typeof project.get("defaultGesture")==="undefined"){project.set({"defaultGesture":"tap"})}if(typeof project.get("widgetGroups")==="undefined"){project.set({"widgetGroups":{}})}if(!e.pages){e.pages=[]}if(!storage.get(e.homepage)&&e.pages.length){project.set({"homepage":e.pages[0]})}for(var k=0;k<e.pages.length;k++){var c=storage.get(e.pages[k]);if(!c){e.pages.splice(k,1);k--;continue}if(c.x>e.canvasWidth){page.update({x:c.x/4},e.pages[k])}if(c.y>e.canvasHeight){page.update({y:c.y/4},e.pages[k])}if(!c.height){page.update({height:480},e.pages[k])}if(!c.width){page.update({width:320},e.pages[k])}if(!c.orientation){page.update({orientation:"Portrait"},e.pages[k])}if(c.width!==~~c.width){page.update({width:~~c.width},e.pages[k])}if(c.height!==~~c.height){page.update({height:~~c.height},e.pages[k])}var h,a;if(!c.widgets){page.update({widgets:[]},e.pages[k]);c.widgets=[]}for(var f=0;f<c.widgets.length;f++){h=storage.get(c.widgets[f]);if(!h){page.removeWidget(e.pages[k],c.widgets[f]);continue}else{if(h.upload&&h.upload==="y"){a=storage.get(h.data);if(!a&&account.syncedUploads){storage.remove(c.widgets[f]);page.removeWidget(e.pages[k],c.widgets[f]);continue}}}}}var m=fluid.main.project.links.toJSON();if(!m){m={linkCanvId:[],linkDest:[],linkOrigin:[],linkType:[],transType:[],triggerType:[]};e.links=m}if(typeof m.transType==="undefined"){m.transType=(m.linkType).slice(0);for(var k in m.transType){m.transType[k]=(m.linkType[k]=="ahref")?project.get("defaultTransition"):null}}if(typeof m.triggerType==="undefined"){m.triggerType=(m.linkType).slice(0);for(var k in m.triggerType){m.triggerType[k]=(m.linkType[k]=="ahref")?project.get("defaultGesture"):null}}var l=false;var d;for(var k=0;k<m.linkDest.length;k++){l=false;if(!storage.get(m.linkDest[k])){m.linkCanvId.splice(k,1);m.linkDest.splice(k,1);m.linkOrigin.splice(k,1);m.linkType.splice(k,1);m.transType.splice(k,1);m.triggerType.splice(k,1);k--}else{if(!storage.get(m.linkOrigin[k])){m.linkCanvId.splice(k,1);m.linkDest.splice(k,1);m.linkOrigin.splice(k,1);m.linkType.splice(k,1);m.transType.splice(k,1);m.triggerType.splice(k,1);k--}}}project.save()},bundle:function(b){if(fluid.main.project&&fluid.main.project.id===b){return fluid.main.project.bundle()}else{var a=fluid.main.projects.get(b);return a.bundle()}},notifySyncAttempt:function(a,b){},sync:function(d,c){if(account.get("accType")=="New"){return}var b=account.get("lastOpenProject");if(d===undefined||d===null){d=b}function a(e){if($.isFunction(c)){c.call(null,e)}}project.loadIfUnloaded(d,function(){var f=d==b?project.isModified:true;project.notifySyncAttempt(f,d);if(f){var e=storage.get(d);e["saved"]=new Date().getTime();storage.set(d,e,false);var h=project.bundle(d);setTimeout(function(){ajax.syncUp(h,"projectSync",d,function(i){a({data:i,synced:true})})},2000)}else{a({synced:false})}if(d==b){project.setModified(false)}})},setName:function(b){var a=storage.get(b.id);if(!a){return}a.name=b.name;storage.set(b.id,a);if(account.get("lastOpenProject")==b.id){account.set({"name":b.name})}},deletePage:function(d){var c=null;var a=project.get("pages");for(var b=0;b<a.length;b++){if(a[b]==d){c=b;break}}a.splice(c,1);project.set({"pages":a});project._deletePageWidgets(d)},_deletePageWidgets:function(d){var c=storage.get(d);if(c){for(var b=0,a=c.widgets.length;b<a;b++){storage.remove(c.widgets[b])}}},sort:function(){var a=account.get("projectIds");var b=$.merge([],a);b.sort(function(d,c){var f=storage.get(d)?storage.get(d).created:0;var e=storage.get(c)?storage.get(c).created:0;return f-e});account.set({"projectIds":b})},load:function(){account.setLoadingStep(2);if($(".submenuLink .fluidSubmenuActive").length==0){$("#fluidDropdownSubmenu a:first").addClass("fluidSubmenuActive")}project.sort();var d=account.get("accType");var c=account.get("projectIds");var i=account.get("maxActiveProjects");var j=0;if(i!=0&&project.activeProjectCount()>i){j=project.activeProjectCount()-i}projectSettings.displayFrame();$("#fluidDropdown .project").not(".addProject").remove();$(".projectThumb").not("#projectAdd").remove();projectSettings.resetFilter();for(var e=0,h=c.length;e<h;e++){var f=c[e];var b=storage.get(f);if(b){b=project.ensureHeaderIntegrity(b);var a=b.active!==undefined?b.active:true;if(j>0&&a){b.active=false;storage.set(f,b);j--;(function(k){project.loadIfUnloaded(k,function(l){if(l[k]){l[k].active=false;delete l[k].unloaded}ajax.syncUp(l,"projectSync",k);fluid.main.projects.get(k).set({active:false})},{setAsMain:false})})(c[e])}b=project.ensureHeaderIntegrity(b);project._template(b,c[e])}}project.setNumber();this.updateInactiveProjectList()},ensureHeaderIntegrity:function(a){if(!a.name){a.name="New Project"}return a},windowClose:function(){storage.commitCache();if(project.isEmpty()==false){project.sync()}},windowClose2:function(){alert("Close!");storage.commitCache();if(project.isEmpty()==false){project.sync()}},close:function(b){fluid.command.history.reset();fluid.command.create("hideButton").dispatchTo("fluid.controllers.timeline");page.detachFrame();var a=account.get("lastOpenProject");$("#canvas").removeClass("loaded");$(".project").removeClass("open");$(".projectThumb").removeClass("open");$(".screen").remove();$("#canvasLinks").empty();if($("#dragCanvas").length==0){$("#tmplDragCanv").tmpl({}).appendTo($("#canvas"))}hint.hide();if(a&&storage.get(a)&&!project.isEmpty(a)&&!project.lastProjectClosed){project.sync(null,b)}project.lastProjectClosed=true},open:function(a,c){$("#canvas").removeClass("loaded");project.afterOpenedCallback=c;project.openStartTime=new Date().getTime();project.uploadPreload=true;project.useLocalDb=true;fluid.command.history.reset();account.setLoadingStep(3);if($("#previewHolder").is(":visible")){preview.close()}$("#pagePreview",page.frame||document).stop(true).css("opacity",0);notification.removeAll("alert",["projectInactive","projectLimit"]);if(!project.lastProjectClosed){project.close()}if(a=="last"){a=account.get("lastOpenProject");var b=storage.get(a);if(!a||!b){a=project.add("","New Project")}}account.set({lastOpenProject:a});project.lastProjectClosed=false;project.loadIfUnloaded(a,project.afterLoaded.bind(this,a),{buildModel:true,setAsMain:true})},drawThumbnail:function(e){var d=$("#profile");d.find(".projectThumb").remove();var b={id:"opened_"+e,name:project.get("name")};var f=$("#tmplProjectThumb").tmpl(b);f.addClass(project.get("active")===false?"inactivePrj":"activePrj");var c=project.get("preview");if(!project.get("pages")||project.get("pages").length===0){f.append('<div class="project-thumb">Project empty</div>')}else{if(c&&c.src){f.append('<img class="project-thumb" src="'+c.src+'">')}}var a=$("#tmplProjectSettingsFrame").tmpl();$(".selectedProjectName",a).text(f.attr("title"));$(a).click(fluid.util.debounce(function(){projectSettings.lastSelectedId=project.get("id");project.sync();projectSettings.goToSettingsUpdate();userSettings.open(null,$("#projectSettingsPanelSettings"))},500));a.css({opacity:0.75,display:"block"}).appendTo(f);f.addClass("selectedPrj");d.prepend(f)},adjustViewport:function(){var a=24004;var n=16004;var e=$("#viewport");var l=fluid.zoom.getPagesBounding();var m={width:a,height:a*e.height()/e.width()};if(m.height<l.maxY-l.minY){m={height:l.maxY-l.minY+1000,width:e.width()*(l.maxY-l.minY+1000)/e.height()}}project.set({canvasWidth:m.width,canvasHeight:m.height});var h=l.minX+(l.maxX-l.minX)/2;var f=l.minY+(l.maxY-l.minY)/2;var c=m.width/2-h;var b=m.height/2-f;var d=project.get("pages");if(d.length){var k;for(var j=0;j<d.length;j++){k=storage.get(d[j]);k.x=k.x+c;k.y=k.y+b;storage.set(d[j],k)}}else{e.get(0).scrollTop=m.height/2*fluid.zoom.getFitParams().newScale*0.25;e.get(0).scrollLeft=m.width/2*fluid.zoom.getFitParams().newScale*0.25}},afterLoaded:function(a){if(storage.get(account.get("id")).email.indexOf("@")===-1){$("#profile .projectThumb").remove()}else{project.drawThumbnail(a)}project.checkIntegrity(a);project.adjustViewport();$("#zoomedOutPages").get(0).innerHTML="";fluid.zoom.zoomToAllPages({instantSwitch:true,finishedCallback:function(b){project.preparePages(a)}})},preparePages:function(c){link.newLinks=true;function b(){var e=project.getPagesInViewport("init");if(e==0){project.centerOnHomepage();e=project.getPagesInViewport("init")}return e}var d=b();for(var a=0;a<d.length;a++){page.draw(d[a],"init")}project.onPagesPrepared(c)},onPagesPrepared:function(b){canvas2.updatePages(canvas2.updateLinks);projectSettings.getItemById(b).addClass("open");document.title=project.get("name")+" :: Fluidui.com";$(".pageWidget").draggable("disable");$("#startMenu").delay(300).fadeIn(300);project.isInitialized=true;if(project.readOnly()){fluid.command.create("hideButton").dispatchTo("fluid.controllers.timeline");account.alertEditInactive();$("#canvasPages .pageWidget").draggable("option","disabled",true);fluidMenu.setCanvasFirstPage()}else{if(project.get("pages").length>0){fluidMenu.setCanvasFirstPage()}else{fluidMenu.setCanvasNoPages()}}if(!project.previewRenderer){project.previewRenderer=new fluid.wdgRenderer()}project.previewRenderer.renderProjectPreview(project.bundle(b),function(d,c){project.onPreviewReady(d,c,"projectopen")});if(account.get("loggedIn")=="yes"){$("#projectName").hide().text(project.get("name")).fadeIn(1000).delay(1000).fadeOut(500)}var a=project.get("pages");if(!a||a.length==0){fluidMenu.setCanvasNoPages(false)}project.setModified(false);if($.isFunction(project.afterOpenedCallback)){project.afterOpenedCallback.call(null);project.afterOpenedCallback=null}$("#zoomedOutPages").fadeIn(300);$("#canvas").addClass("loaded");$("#scaled-"+project.get("homepage")).addClass("homePage");if(!project.readOnly()){hint.restart()}fluid.main.fire("projectopened")},onPreviewReady:function(h,b,e){$("#profile .projectThumb .loader-wrap").remove();var d=b.get(0).toDataURL();var a=storage.get(h);if(!a||a.unloaded){return}a.preview={src:d};storage.set(h,a,false);projectSettings.updateThumbnail(h);if(project.get("id")===h){var c=project.get("pages");if(!c||c.length===0){$("#profile .project-thumb").remove();$("#profile .projectThumb").prepend('<div class="project-thumb">Project empty</div>')}else{$("#profile div.project-thumb").remove();var f=$("#opened_"+h+"Thumb img.project-thumb");if(f.length){f.attr("src",d)}else{$("#profile .projectThumb").prepend('<img class="project-thumb" src="'+d+'">')}}}if(e!=="autopreviewgen"){project.renderMissingPreviews(e!=="projectopen"?h:null)}if(e==="projectopen"){setTimeout(project.initAutoPreviewGen.bind(this,h),project.autoPreviewTimeout)}},initAutoPreviewGen:function(a){if(account.get("lastOpenProject")!==a){return}project.previewRenderer.renderProjectPreview(project.bundle(account.get("lastOpenProject")),function(c,b){project.onPreviewReady(c,b,"autopreviewgen")});setTimeout(project.initAutoPreviewGen.bind(this,a),project.autoPreviewTimeout)},renderMissingPreviews:function(c){var a=$(".projectThumb div.preview").not(".empty");var b;if(a.length>0){b=projectSettings.getSelectedId(a.eq(0).parents(".projectThumb").attr("id"));project.renderPreview(b)}},renderPreview:function(a,c){if(a===fluid.main.project.id&&!fluid.main.project.modifiedSinceThumb){return}var b=c||"missingpreview";if(a===project.get("id")){$('<div class="loader-wrap"><img class="ajax-loader" src="img/ajax-loader.gif"/></div>').insertAfter("#profile .project-thumb")}project.loadIfUnloaded(a,function(){if(!project.previewRenderer){project.previewRenderer=new fluid.wdgRenderer()}project.previewRenderer.renderProjectPreview(project.bundle(a),function(e,d){project.onPreviewReady(e,d,b);if(!project.isOpen(e)){project.sync(e,function(){project.unload(e)})}})})},isOpen:function(a){if(!a){a=this.id}return a==account.get("lastOpenProject")},addWithoutLimit:function(a){project._freeSlotForProject();project.add(a,null,true)},add:function(k,a,m,l){var m=m==undefined?false:true;if((!account.canAddProjects())&&(!m)){notification.removeAll("alert","projectLimit");var n;if(account.get("maxActiveProjects")<=1){n=account.alerts.projectLimitHit.onAddActive}else{n=account.alerts.projectLimitHit.onNeedHigherThanStandard}notification.add("alert",n,{scope:"projectLimit","stopBuggingCallBack":project.addWithoutLimit});return false}var c;if(a==undefined){var a="";var i=storage.get("projectsCount");var d=account.get("projectIds");if(!i){i=d.length+1}else{i+=1}function j(e){d.forEach(function(o){if(storage.get(o).name===e){i+=1;e=j("Project "+i)}});return e}storage.set("projectsCount",i);a=j("Project "+i)}var f=new Date().getTime();c=utils.guid("p");var h={name:a,created:f,updated:f,canvasWidth:24004,canvasHeight:16004,canvasPosX:-2000*0.5,canvasPosY:-2000*0.5,orientation:"Portrait",pages:[],pageWH:[320,568],deviceModel:"iPhone5",lastTransition:"pop",defaultTransition:"pop",defaultGesture:"tap",links:{linkOrigin:[],linkDest:[],linkCanvId:[],linkType:[],transType:[],triggerType:[]}};if(!fluid.main.project){fluid.main.project=new fluid.models.project(h,{projectId:c});fluid.main.newProjectModel=fluid.main.project}else{fluid.main.newProjectModel=new fluid.models.project(h,{projectId:c})}fluid.main.projects.add(fluid.main.newProjectModel);account.addProjectId(c);storage.set(c,h);fluid.main.newProjectModel.save(function(){if(l){l(c)}});var b=project._template(h,c);project.setNumber();projectSettings.applyFilter();project.sync(c,false);return c},addPage:function(b){var a=project.get("pages")||[];a.push(b);project.set({"pages":a})},del:function(e,d){function c(){lib.handleUploadsRemovedFromPage(Object.keys(project.bundle(e).uploads),e,$("#project-"+e));function f(){$("#fluidDropdown #"+e).draggable("destroy").fadeOut(300,function(){var j=$(this).hasClass("inactiveProject");$(this).remove();if(j){project.updateInactiveProjectList()}});var h=account.get("projectIds");h=fluid.util._.without(h,e);account.set({"projectIds":h});var i=project.unload(e);storage.remove(e);project.setNumber();projectSettings.displayFrame();projectSettings.getItemById(e).remove();projectSettings.refreshListHeader();if(d){d.call(null,i)}}ajax.remove(e,f)}var b=project.isOpen(e);if(b){project.close()}var a=storage.get(e);a.removed=true;a.updated=new Date().getTime();storage.set(e,a);if(project.isEmpty(e)){c()}else{project.sync(e,c)}notification.removeAll("alert","projectAction");notification.add("alert","Your project has been deleted.  In case you want to restore, please open the bin...",{scope:"projectAction"});fluid.controllers.bin.show()},_deleteProjectPages:function(e){var d=storage.get(e);if((d)&&(d.pages!=undefined)&&!d.unloaded){for(var b=0,a=d.pages.length;b<a;b++){var c=d.pages[b];project._deletePageWidgets(c);storage.remove(c)}}},rename:function(b){var c=userSettings.isOpen?projectSettings.lastSelectedId:$(b.target).closest(".project").attr("id");var a=$(b.target).val();project.setName({name:a,id:c});project.sync(c,false);if(project.isOpen(c)){document.title=project.get("name")+" :: Fluidui.com"}$(".title","#"+c).val(a);$(".selectedProjectName").text(a);projectSettings.getItemById(c).attr({"data-name":a.toLowerCase(),title:a,alt:a});fluid.main.trigger("projectNameChanged");return false},activeProjectCount:function(){var a=fluid.main.projects.filter(function(c,b,d){if(c.get("active")===false||c.get("removed")===true){return false}return true});return a.length},getLatestActiveProject:function(){var c;var b=account.get("projectIds");for(var a=b.length-1;a>=0;a--){if(storage.get(b[a]).active!==false){c=b[a];break}}return c},readOnly:function(){return project.get("active")===false},setModified:function(a){if(!project.readOnly()){var b=a===false?false:true;project.isModified=b}else{project.isModified=false}},storageChangeProjectHandler:function(b,a){if((!a)||(!a.timeUpdated)){return}if(/^[xwp]/.test(a.id)){if(/^p/.test(a.id)&&(a.id!=account.get("lastOpenProject"))){return}project.setModified(true)}},unload:function(c,a){return storage.get(c);if(!a){a=storage.get(c)}if(this.previewRenderer){this.previewRenderer.onProjectUnloaded(c)}if(!a.unloaded){project._deleteProjectPages(c);for(var b in a){if(a.hasOwnProperty(b)&&$.inArray(b,project.unloadedProps)==-1){delete a[b]}}a.unloaded=true;storage.set(c,a)}return a},unloadOldest:function(){var i,d,c;var e=account.get("projectIds");for(var b=0,a=e.length;b<a;b++){var h=e[b];if(h!=account.get("lastOpenProject")){var f=storage.get(h);if(!f.unloaded&&(!c||c>f.updated)){c=f.updated;i=h;d=f}}}if(d){project.unload(i,d)}else{throw"Could not find a project to unload"}},loadIfUnloaded:function(e,d,a){function b(){if($.isFunction(d)){d.apply(this,arguments)}}var c=storage.get(e);if(c&&c.unloaded){ajax.syncDown(e,function(i,f,n){var h=JSON.parse(n.responseText);if(h.r==="f"){var k=storage.get(e,{returnModel:true});if(k){k.set({unloaded:false})}b();return}var m=h.t;if(m.length){m=m[0].replace(/[\r\n]/g,"\\n")}else{m=m.replace(/[\r\n]/g,"\\n")}var j=JSON.parse(m);var k=fluid.main.projects.get(e);var o=fluid.main.projects.indexOf(k);j[e].unloaded=false;var l=new fluid.models.project(j,{parse:true,projectId:e});if(!a||a.setAsMain!==false){fluid.main.project=l}if(k&&k.get("active")===false){l.set({active:false})}fluid.main.projects.remove(k);fluid.main.projects.add(l,{at:o});b(l.bundle())})}else{if(a&&a.setAsMain){fluid.main.project=fluid.main.projects.get(e);b()}else{b(project.bundle(e));return}}},resetCanvas:function(){var a=-1000,b=-1000;project.set({canvasPosY:b,canvasPosX:a});$("#viewport").get(0).scrollLeft=a;$("#viewport").get(0).scrollTop=b},centerOnHomepage:function(){var a=project.get("homepage");if(a){var h=storage.get(a),d=utils.getTLWH("#canvas"),c=utils.getTLWH("#viewport");var b=fluid.zoom.getCurrentScale(),f=Math.max((h.x*b+(h.width*b-c.width)/2),10),e=Math.max((h.y*b+(h.height*b-c.height)/2),10);if(f+c.width-10>d.width){f=d.width-c.width-10}if(e+c.height-10>d.height){e=d.height-c.height-10}$("#viewport").get(0).scrollLeft=f;$("#viewport").get(0).scrollTop=e;project.set({canvasPosY:-e,canvasPosX:-f})}},updateOnSignup:function(){project.setNumber();project.previewRenderer.renderProjectPreview(project.bundle(account.get("lastOpenProject")),function(b,a){project.onPreviewReady(b,a,"projectopen")})},_freeSlotForProject:function(){var f=false;if(!account.canAddProjects()){var b=account.get("projectIds");for(var a in b){var e=b[a];var d=storage.get(e);if(d){var c=d.active!==undefined?d.active:true;if(c){if(!project.isOpen(e)){project.dropToInactive($("#"+e));f=true;break}}}}}if(!f){project.dropToInactive($("#"+account.get("lastOpenProject")))}},getPagesInViewport:function(f){var k=[];var j=document.getElementById("viewport");var a=$.extend([],project.get("pages"));var o=fluid.zoom.getCurrentScale();var m={left:f==="init"?-project.get("canvasPosX")/o:j.scrollLeft/o,top:f==="init"?-project.get("canvasPosY")/o:j.scrollTop/o,width:window.innerWidth/o,height:window.innerHeight/o};m.right=m.left+m.width;m.bottom=m.top+m.height;var p,h,n,e,l,c;var b;for(var d=0;d<a.length;d++){b=a[d];a[d]=$.extend({},storage.get(a[d]));p=a[d].x;h=a[d].x+a[d].width;n=a[d].y;e=a[d].y+a[d].height;l=a[d].width;c=a[d].height;if(f!=="strict"&&((p<=m.right)&&(m.left<=h)&&(n<=m.bottom)&&(m.top<=e))){k.push(b)}else{if(f==="strict"&&((h<=m.right)&&(m.left<=p)&&(e<=m.bottom)&&(m.top<=n))){k.push(b)}}}fluid.main.project.set({visiblePages:k});return k},getLinksInViewport:function(f){var d=project.getPagesInViewport(f);var c=fluid.main.project.links.toJSON();var e={linkCanvId:[],linkDest:[],linkOrigin:[],linkType:[],transType:[],triggerType:[]};var a;for(var b=0;b<c.linkCanvId.length;b++){a=storage.get(c.linkOrigin[b],{returnModel:true});if(d.indexOf(c.linkDest[b])!==-1||(a&&d.indexOf(a.getPage().id)!==-1)){e.linkCanvId.push(c.linkCanvId[b]);e.linkDest.push(c.linkDest[b]);e.linkOrigin.push(c.linkOrigin[b]);e.linkType.push(c.linkType[b]);e.transType.push(c.transType[b]);e.triggerType.push(c.triggerType[b])}}return e},getActivePage:function(){return $("#canvasPages > .screen.active").first()},getActivePageId:function(){return project.getActivePage().attr("id")},updateThumbsActiveStatus:function(){$("#projectSettingsPanelMain .projectThumb").each(function(){var c=$(this);var a=c.attr("id");if(a.indexOf("Thumb")!==-1){a=a.substring(0,a.indexOf("Thumb"));var b=fluid.main.projects.get(a);if(b&&b.get("active")===false){c.removeClass("activePrj").addClass("inactivePrj")}else{c.removeClass("inactivePrj").addClass("activePrj")}}})},lastProjectClosed:true};if(!window.fluid){window.fluid={}}fluid.projectPreloader=function(){this.firstPreload=function(a,b){this.projectId=a;this._projectLoaded=false;this.firstPreloadSuccess;if(storage.get(a)){this.projectSource="localstorage"}else{this.projectSource="localDB"}this.projectBundle="loading";if(this._projectLoaded){this.afterPagesDone()}};this.secondPreload=function(){var d=project.get("pages");var c=[],b,h;for(var f=0;f<d.length;f++){b=storage.get(d[f],{returnModel:true});h=b?b.get("imgData"):null;if(!b&&h){c.push(d[f])}}var e=project.bundle(this.projectId).uploads;var a=[];for(var j in e){if(e.hasOwnProperty(j)){a.push(j)}}this.dbGetUploads(a)};this.projectLoaded=function(a){this.afterPagesDone=a;this._projectLoaded=true;if(this.projectSource==="localstorage"||(this.projectSource==="localDB"&&this.pagesValid())){this.afterPagesDone();this.secondPreload()}else{this.afterPagesDone()}};this.dbGetUploads=function(a){dbStorage.get("uploads",a,function(d){for(var c=0;c<d.fetched.length;c++){var b=storage.get(d.fetched[c],{returnModel:true});if(b){b.set({imgData:d.resultsObj[d.fetched[c]].data},{silent:true})}}}.bind(this))};this.pagesValid=function(){if(this.projectBundle&&this.projectBundle!=="notFound"){var a=project.bundle(this.projectId);var b=this.projectBundle;for(var c in a){if(a.hasOwnProperty(c)&&!b[c]&&c!=="uploads"){return false}}for(c in b){if(b.hasOwnProperty(c)&&!a[c]&&c!=="uploads"){return false}}return true}else{return false}}};var locStorage=(function(){var a={tempStorage:{},cachedUpdates:{},caching:false,lastUpdate:new Date().getTime(),get:function(c){if(a.tempStorage[c]){return a.tempStorage[c]}if(localStorage){var b=localStorage.getItem(c);if(b){a.tempStorage[c]=JSON.parse(b);return a.tempStorage[c]}}return null},tabSynchronisationCheckInterval:3000,lastTabSynchronisationCheck:null,set:function(k,h,b){if(!k||!h){return}var j=b==undefined?true:b;if(this.lastTabSynchronisationCheck+this.tabSynchronisationCheckInterval<new Date().getTime()){var d=localStorage.getItem("instanceId");if(d&&parseInt(d)!=g_instanceId){var i=localStorage.getItem("restoreMyInstanceId");if(i){a._setItem("instanceId",g_instanceId);localStorage.removeItem("restoreMyInstanceId");return}a._setItem("postloadMessage","tab");location.reload();return}}if(typeof(h)=="string"){h=JSON.parse(h)}a.lastUpdate=this.lastTabSynchronisationCheck=new Date().getTime();if((h)&&(j)){h.updated=a.lastUpdate}var c=JSON.stringify(h);try{if(this.caching){this.cachedUpdates[k]=h}else{a._setItem(k,c)}this.tempStorage[k]=h}catch(f){}fluidEvent.triggerEditor("storageChanged",{id:k,obj:h,timeUpdated:j})},remove:function(b){delete this.tempStorage[b];delete this.cachedUpdates[b];localStorage.removeItem(b)},cacheStart:function(){this.caching=true},commitCache:function(){if(!this.caching){return}this.caching=false;for(var b in this.cachedUpdates){this.set(b,this.cachedUpdates[b]);delete (this.cachedUpdates[b])}},setTempItem:function(c,b){this.tempStorage[c]=b},removeItem:function(b){localStorage.removeItem(b)},clear:function(){tempStorage={};cachedUpdates={};localStorage.clear()},_setItem:function(f,b){var d=false;while(!d){try{localStorage.setItem(f,b);d=true}catch(c){if(c&&(c.name=="QUOTA_EXCEEDED_ERR"||c.name=="NS_ERROR_DOM_QUOTA_REACHED"||c.code===22)){project.unloadOldest()}else{throw c}}}}};return a})();var storage={get:function(h,c){var e=h&&h.substr?h.substr(1,1):"";var b,f,a;if(!h){return false}if(h[0]==="p"&&(!fluid.main.project||fluid.main.project.id!==h)&&fluid.main.projects){b=fluid.main.projects.get(h,c);f=b?b.toJSON(c):null;return f}else{if(fluid.main&&fluid.main.project&&((e==="_"&&(h[0]==="p"||h[0]==="x"||h[0]==="w"||h[0]==="l"))||((h[0]==="p"||h[0]==="x"||h[0]==="w"||h[0]==="l")&&h.length===33))){f=fluid.main.project.get(h,c);if(f){return f}else{fluid.util._.each(fluid.main.projects,function(k,i,l){var j=l.models[i].get(h,c);if(j){f=j}});return f}}else{if(fluid.main&&fluid.main.account&&((e==="_"&&h[0]==="u")||(h[0]==="u"&&h.length===33))){f=fluid.main.account.toJSON();return f}else{if(fluid.main&&fluid.main.uploads&&((e==="_"&&h[0]==="i")||(h[0]==="i")||h.length===33)){b=fluid.main.uploads.get(h);if(c&&c.returnModel){return b}else{return b?b.toJSON():false}}else{if(window.g_preview&&preview.parentWindow&&window.top.storage){var d=window.top.storage.get(h,c);return d}}}}}a=locStorage.get(h);if(h!=="accounts"&&h!=="bin"&&a){}if(a){return $.extend({},a)}else{return false}},set:function(h,f,b){f=fluid.util._.clone(f);var e=h&&h.substr?h.substr(1,1):"";if(e==="_"||((h.length===33)&&(h[0]==="p"||h[0]==="x"||h[0]==="w"||h[0]==="i"||h[0]==="u"))){if(h[0]==="p"&&fluid.main.project){if(fluid.main.project.id===h){fluid.main.project.set(f);return true}else{var d=fluid.main.projects.get(h);if(d){d.set(f);return true}else{return false}}}else{if(h[0]==="u"){if(fluid.main.account&&fluid.main.account.id===h){fluid.main.account.set(f);return true}else{return false}}else{if(h[0]==="i"){if(!f.id){f.id=h}var a=fluid.main.uploads.get(h);if(a){a.set(f)}else{fluid.main.uploads.add(f)}delete f.id;return true}else{if(h[0]==="b"){var c=fluid.main.account.customwidgets.get(h);if(c){c.set(f)}else{fluid.main.account.customwidgets.add(f)}}else{if(fluid.main.project){fluid.main.project.setChild(h,f);return true}}}}}}locStorage.set(h,f,b);return true},remove:function(b){var a=b.substr(0,2);if(a==="w_"){fluid.main.project.widgets.remove(b)}else{if(a==="x_"){fluid.main.project.pages.remove(b)}}return locStorage.remove(b)},cacheStart:function(){return locStorage.cacheStart()},commitCache:function(){return locStorage.commitCache()},setTempItem:function(b,a){return locStorage.setTempItem(b,a)},removeItem:function(a){return locStorage.removeItem(a)},clear:function(){return locStorage.clear()},_setItem:function(b,a){return locStorage._setItem(b,a)},init:function(a){if(window.g_preview){a();return}fluid.main.projects=new fluid.Projects();fluid.main.uploads=new fluid.Uploads();dbStorage.onReady(function(){var b=storage.get("accounts");if(b&&b.last){dbStorage.get("accounts",b.last,function(c){if(c.fetched.length){fluid.main.account=new fluid.models.Account(c.resultsObj[c.fetched[0]].data);dbStorage.get("uploadHeaders",fluid.main.account.id,function(f){if(f.fetched.length){var e=fluid.util._.toArray(f.resultsArr[0].data);fluid.main.uploads=new fluid.Uploads(e)}var i=fluid.main.account.get("lastOpenProject");var h=false;var d=fluid.main.account.get("projectIds");if(d.length){dbStorage.get("projects",d,function(m){if(m.fetched.length){for(var l=0;l<m.resultsArr.length;l++){if(m.resultsArr[l]){var j=m.resultsArr[l].id,o=m.resultsArr[l].data,n=m.resultsArr[l].data[m.resultsArr[l].id];if(!n.id){n.id=j}if(j===i){h=true;fluid.main.project=new fluid.models.project(o,{parse:true,projectId:i});fluid.main.projects.add(fluid.main.project,{silent:true});if(o[i].unloaded){project.loadIfUnloaded(i,function(){a()},{buildModel:true})}else{dbStorage.get("uploads",fluid.util._.keys(o.uploads),function(r){if(r.fetched.length){var p;for(var q=0;q<r.resultsArr.length;q++){p=false;if(r.resultsArr[q].id){p=storage.get(r.resultsArr[q].id,{returnModel:true})}if(p&&r.resultsArr[q].data){p.set({"imgData":r.resultsArr[q].data},{})}}}a()})}}else{if(n.unloaded){fluid.main.projects.add(n,{silent:true})}else{var k=new fluid.models.project(o,{parse:true,projectId:j});fluid.main.projects.add(k,{silent:true})}}}}if(!h){a()}}})}else{if(!(localStorage.getItem("badinit")==="true")){localStorage.clear();localStorage.setItem("badinit",true);dbStorage.clear();setTimeout(function(){location.reload()},200)}}})}else{a()}})}else{a()}})},tempStorage:locStorage.tempStorage};var ajax={maxSyncRetryCount:2,submit:function(i){var h=$(this);var j=h.attr("id");var c=h.hasClass("createForm");var f=h.hasClass("shareSendMail");if(j!="feedbackForm"&&!c&&!(f&&$(".shareSend").attr("disabled")===undefined)&&j!=="upgradeForm"&&j!=="errorContact"){return false}if(h.find(":submit").hasClass("inactive")){return false}var b=h.find("input").not(":hidden, :submit").length;var a=h.find(".formCorrect").length;if(f){fluid.main.fire("beforeShareMail")}if(b==a){h.find(":submit").val("Sending...").removeClass("accept").addClass("inactive")}else{h.find(":submit").removeClass("accept").addClass("inactive")}try{tracker.record("Submitting Form",1,j,i)}catch(i){}var d=h.serialize();$.ajax({url:"./index.php",type:"POST",data:d,complete:ajax.complete,error:ajax.error});return false},syncUp:function(d,c,a,h,b){if(a){account.syncPending[a]=c}var f=JSON.stringify(d);var e={t:c,data:f,objectId:a};$.ajax({url:"./index.php",type:"POST",data:e,success:function(i,l,k){var j=JSON.parse(i);if(j.r=="f"&&j.t=="retry"){if(b===undefined){b=ajax.maxSyncRetryCount}if(b>0){ajax.syncUp(d,c,a,h,--b);return}}else{if(j.r=="f"&&j.t=="forceSyncDown"&&c==="projectSync"){fluid.main.project.set({unloaded:true});if(fluid.main.project.get("id")===a){project.open(a);return}else{project.loadIfUnloaded(a,function(){if($.isFunction(h)){h(i)}});return}}}ajax.syncSuccess(i,l,k,c,a);if($.isFunction(h)){h(i)}},error:function(i,k,j){ajax.syncError(i,k,j,c,a)},complete:function(i,j){ajax.syncComplete(i,j,c,a)}})},syncDown:function(b,d,f,c){if($.isFunction(d)){c=arguments[2];f=arguments[1];d=false}var a=$.isArray(b);var e={t:"syncDown",objectId:a?b.join(","):b,multiple:a};if(d){e.unloaded=true}$.ajax({url:"./index.php",type:"POST",data:e,success:f,error:c||ajax.syncError})},snapshot:function(a,b,d){var c={t:"snapshot",objectId:a,type:b};$.ajax({url:"./index.php",type:"POST",data:c,success:d,error:ajax.snapshotError})},remove:function(a,c){var b={t:"remove",objectId:a};$.ajax({url:"./index.php",type:"POST",data:b,success:c,error:ajax.syncError})},restore:function(a,c){var b={t:"restore",objectId:a};$.ajax({url:"./index.php",type:"POST",data:b,success:c,error:ajax.syncError})},syncSuccess:function(h,i,f,e,b){switch(e){case"imageSync":var d=account.findUpload(b);if(d){tracker.record("ImageUploaded",1);d.upload.s=true}break;case"emailRegd":account.emailChecked(h);break;case"accountState":var a=$.parseJSON(f.responseText);if(a.r==="s"){var c=account.get("status");account.set({status:a.status});account.doAccountStatusAction(c);$("body").addClass("signed-in")}else{$("body").removeClass("signed-in")}account.requireRefresh(a);break}},syncError:function(c,e,d,b,a){},syncComplete:function(c,d,b,a){if(a){delete account.syncPending[a]}},complete:function(b,d){var a;try{a=$.parseJSON(b.responseText)}catch(c){return false}switch(a.a){case"contact":upgrade.errorSubmitted(a);break;case"feedback":fluidMenu.feedbackAjaxResponse(a);break;case"login":account.login(a);break;case"previewMail":share.actionMailSent(a);break}return false},apiCall:function(c,h,a,e,d,f){var i={},j=e;if(e instanceof Blob){var b=new FormData();b.append("file",e);e=b;h="post";i={processData:false,contentType:false};account.syncPending[a]=c}$.ajax($.extend(i,{url:this.apiObjectUrl(c,a),type:h?h.toUpperCase():"POST",data:e,success:function(m,n,l){if(h=="post"){var k=account.findUpload(a);if(k){k.upload.s=true;account.uploadSynced(a,true)}}if($.isFunction(d)){d(m,a,j)}},error:function(k,m,l){ajax.syncError(k,m,l,c,a);if($.isFunction(f)){f(e,a,j)}},complete:function(k,l){delete account.syncPending[a]}}))},apiObjectUrl:function(b,c){var a="data/"+b+(c?"/"+c:"");return a},sendMessage:function(h,a,c,f,e){var d={from:h,subject:a,message:c};var b={t:"contact",data:JSON.stringify(d)};$.ajax({url:"index.php",type:"POST",data:b,success:function(j,k,i){if($.isFunction(f)){f()}},error:function(i,k,j){if($.isFunction(e)){e()}else{if($.isFunction(f)){f()}}}})},generalRequest:function(c,b,e,d){var a=d?$.extend({t:b},c):{t:b,data:JSON.stringify(c)};$.ajax({url:"index.php",type:"POST",data:a,success:function(h,i,f){if($.isFunction(e)){e(h)}},error:function(f,i,h){if($.isFunction(e)){e(null,h)}}})},userSettingsRequest:function(b,a,d,c){return ajax.generalRequest(b,a,d,c)}};var widget={editing:false,widgetOffset:null,locked:null,currSelection:null,useCanvas:false,get:function(b){var a;if(typeof widgets!=="undefined"){a=widgets.summary&&widgets.summary[b]&&$.extend(true,{id:b},widgets.summary[b])}if(a==undefined){a=storage.get(b)}return a||false},set:function(b,d){var a=storage.get(d,{getAll:true});if(!a){return false}for(var c in b){a[c]=b[c]}storage.set(d,a)},containsText:function(d){var b,a;for(var c=0;c<d.length;c++){b=d.eq(c).attr("id");a=storage.get(b,{returnModel:true}).containsText();if(a){return true}}return false},getSubTextElements:function(e){var c,b,d=[],a;a=e.id;c=storage.get(a,{returnModel:true}).getSubTextElements();c.forEach(function(f){d.push(f.id)});b=$("#"+d.join(", #"));return b},getRoots:function(h){var f=[],d,b,c,e,a;$(h).each(function(){d=storage.get(this.id,{returnModel:true});b=d.getRoot();if(b){f.push(d.getRoot().id)}else{c=d.collection.where({lockTo:d.get("lockTo")});c=_.reject(c,function(i){return !i.getParent()});for(e=0;a=c.length,e<a;e++){f.push(c[e].id)}}});f=$("#"+f.join(", #"));return f},getLockTos:function(c){var a=widget.getRoots(c);var b=Array.prototype.reduce.call(a,function(e,d){fluid.util._.forEach(document.querySelectorAll('[data-lockto="'+d.id+'"]'),function(f){if(e.indexOf(f)===-1){e.push(f)}});return e},[]);return $(b)},getSelectedOnly:function(c){function a(d){c.each(function(){if($(this).attr("data-segment")==$(this).attr("id")){if($(this).attr("data-lockto")==d){b=b.add($(this))}else{return}}})}var b=$([]);c.each(function(){if($(this).hasClass("ui-selected")){var d=widget.get($(this).attr("id"));if(d.sc&&!d.bg){var e=$(this).attr("id");a(e)}else{b=b.add($(this))}}});return b},getDependentsCache:[],getDependents:function(b,j,c){var d=[],h,f=[];if(c&&widget.getDependentsCache[b]){return widget.getDependentsCache[b]}if(!c){widget.getDependentsCache=[]}if(j){j.each(function(){f.push(storage.get(this.id,{returnModel:true}))});j=f}else{j=storage.get(b,{returnModel:true}).getLockTos()}for(var e=0,a=j.length;e<a;e++){if(j[e].get("of")===b){d.push(j[e].id)}}h=$("#"+d.join(", #"));widget.getDependentsCache[b]=h;return h},getAbsDimension:function(b,a){if(typeof b=="string"){if(b=="a"){return a||0}else{return(parseFloat(b||0)/100)*(a||0)}}else{return b}},getPagePos:function(b,h,d){if(!h){h={top:0,left:0}}var j=widget.get(b),e=j.ca,f=(j.tlwh||j.dp).slice(),i=j.tlwh?j.tlwh.slice(2):widget.wh.slice(),k=d.slice(),a=j.of&&j.of!=b;if(a){var c=widget.getBoxSize(j.of);k[0]=widget.getAbsDimension(c.width,d[0]);k[1]=widget.getAbsDimension(c.height,d[1])}f[0]=widget.getAbsDimension(f[0],k[1]);f[1]=widget.getAbsDimension(f[1],k[0]);i[0]=widget.getAbsDimension(i[0],k[0]);i[1]=widget.getAbsDimension(i[1],k[1]);if(e[0]=="b"){f[0]=k[1]-f[0]-i[1]}else{if(e[0]=="c"){f[0]=k[1]/2+f[0]-i[1]/2}}if(e[1]=="r"){f[1]=k[0]-f[1]-i[0]}else{if(e[1]=="c"){f[1]=k[0]/2+f[1]-i[0]/2}}h.top+=f[0];h.left+=f[1];if(a){widget.getPagePos(j.of,h,d)}return h},getBoxSize:function(c){var b={};var a=widget.get(c),d=[a.tlwh[2],a.tlwh[3]]||a.wh;b.width=d[0];b.height=d[1];return b},saveTempFile:function(b,a){storage.setTempItem(b+"_file",a)},getTempFile:function(a){return storage.get(a+"_file")},removeTempFile:function(a){storage.remove(a+"_file")},verticalAlign:function(c){var f=c.find(".widgetText");if(f.length==0){return}var k=parseInt(c.css("height"));var j=f.css("font-size");var a=f.css("font-family");f.contents().wrapAll("<span></span>");var e=f.find("span").eq(0);e.css("font-size",j);e.css("font-family",a);var d=parseFloat(e.css("height"));e.contents().eq(0).unwrap();var i=(parseFloat(f.css("top"))/k)*100;var b=(k-d)*i;b=(b<=0)?0:b;f.css("padding-top",b+"px");updateTLWH();var h=widget.get(c.attr("id"));h.ts=f.attr("style");if(h.id){widget.set(h,h.id)}},autoWidth:function(c,d){var a=[c.tlwh[2],c.tlwh[3]];var b=d!="library"?project.getActivePage().find(".widgetHolder").width():320;if(b==null&&a[0]=="a"){a[0]=320}else{if(a[0]=="a"){a[0]=b}}return a},addUploads:function(){var a=account.get("uploads");for(var b in a){var c=storage.get(a[b].id);widgets.summary[a[b].id]=c}},_redraw:function(f,d,c){if(d.segment){var e=widget.get(d.lockTo);var a=widget._setupSegments(e);widget._updateSegments(e,a,c)}var b=$(".screen.active").attr("id");var h=widget._setTMPLVars(f.attr("id"),d,[0,0,parseInt(page.get(b,"width")),parseInt(page.get(b,"height"))]);widget._drawCanvasOrImage(f,h)},hasOwnColorProperties:function(a){if(typeof a=="string"){a=widget.get(a)}return !a.srps&&Boolean(a.bg||a.bgc||a.b)},serialize:function(d){function c(f,e){widget.getDependents(f).each(function(){var h=$(this).attr("id");e[h]=storage.get(h);c(h,e)})}function b(h){var f=fluid.util._.clone(storage.get(h));if(!f){return}var e={id:h};f.insertAfterId=$("#"+h).prev().attr("id");e[h]=f;storage.set(h,f);if($("#"+h).prev().length==0){e[h].insertAfterId="first"}c(h,e);return e}var a;if($.isArray(d)){a=$.map(d,function(e){return b(e)})}else{a=b(d)}return JSON.stringify(a)},deserialize:function(d,f,e,c){function b(i){var n=i.id;var l=i[n];var k=$("#"+f);var h=k.find(".widgetHolder");var m=[0,0,h.outerWidth(),h.outerHeight()];var o=l.insertAfterId;widget._save(n,l,k);widget._draw(n,h,m,false,false,o);var j=e&&storage.get(e);if(j&&j.seg&&"segment" in l&&l.segment==n){widget._insertSegmentObj(j,n,l,c)}o=n;delete i.id;delete i[n];for(n in i){l=i[n];if(l){widget._save(n,l,k);widget._draw(n,h,m,false,false,o);o=n}}}if(d){var a=JSON.parse(d);if(a){if($.isArray(a)){$.each(a,function(h,i){b(i)})}else{b(a)}}}},checkIntegrity:function(d,b){var c=widget.get(d);if(!c){return true}if(c.name){var a={"blackSearch":"widget201010120","tablerowsliderlongblank":"widget201010120","pROGRESSBAR":"widget893","iconStatusBarDark":"widget730","iconStatusBarLight":"widget729","iconStatusBarTrans":"widget731","webLoading":"widget615","webUrlEntry":"widget613","webShortcuts":" widget614","barmapbottomwithtext":"widget910","iPHONEMENUSDARK1":"widget917","rOWCONTENTX1SELECTED":"widget926","spinner":"widget308","dIALINGPAD":"widget908","mEDIAPLAYER":"widget3071","buttonbackandnext":"widget919","switchonwithtext":"widget309","iconLibrary":"widget137","iconAdd":"widget127","iconNext":"widget133","iconRemove":"widget135","sortAlpha":"widget788","iconsorthandles":"widget789","iconAttach":"widget128","iconBack":"widget129","iconForward":"widget130","iconForward1":"widget1301293847","iconInfo":"widget131","'iconTick":"widget136","iconTick1":"widget1342343236","iconWorking":"widget132"};if(a[c.name]){widget.replace(d,a[c.name])}}if(!c.tlwh){widget.fixTLWH(d,c,b)}return true},load:function(b,c,h){var l=$("#"+b).find(".widgetHolder");var a=[0,0,l.outerWidth(),l.outerHeight()];if(h==true){var f=$("#"+b).find(".fixedWidgetHolderFront");var e=l}for(var d=0;d<c.length;d++){if(h==true){var k=widget.get(c[d]);l=e;var i=false;if(k.st=="f"){i=staticWidgets.findPositionOnScreen($([]),c[d],h);if(i==true){l=f}}}widget._draw(c[d],l,a,false,false,c[d].insertAfterId)}},fixTLWH:function(i,f,c){if(!f.wh){return false}var b=f.top.toString();var d=f.left.toString();if(b.indexOf("%")>-1){b=b.substring(0,b.indexOf("%")+1)}if(d.indexOf("%")>-1){d=d.substring(0,d.indexOf("%")+1)}if((f.lockTo!=i)&&(b.indexOf("%")==-1)){var a=widget.get(f.lockTo);var h=(!a||isNaN(a.tlwh[0]))?0:a.tlwh[0];b=f.top-h}if((f.lockTo!=i)&&(d.indexOf("%")==-1)){var a=widget.get(f.lockTo);var h=(!a||isNaN(a.tlwh[1]))?0:a.tlwh[1];d=f.left-h}if(b.toString().indexOf("%")==-1){b=parseFloat(b)}if(d.toString().indexOf("%")==-1){d=parseFloat(d)}if((f.wh[0]).toString().indexOf("%")==-1){f.wh[0]=parseFloat(f.wh[0])}if((f.wh[1]).toString().indexOf("%")==-1){f.wh[1]=parseFloat(f.wh[1])}if(f.st!="b"){var e=[b,d,f.wh[0],f.wh[1]];f.tlwh=e}f.ca="tl";delete f.top;delete f.left;delete f.wh;delete f.id;delete f.title;delete f.dp;delete f.x;storage.set(i,f)}};var staticWidgets={initMenus:function(){staticWidgets.fixedWidget=$("#fixedWidget");staticWidgets.unfixedWidget=$("#unfixedWidget");staticWidgets.fixedWidgetMenu=$("#fixedWidgetMenu");staticWidgets.fixedWidgetsEditor=$("#contextMenuItems .fixedWidgetsEditor");staticWidgets.pinnedBtn=$("#pinnedBtn");staticWidgets.unpinnedBtn=$("#unpinnedBtn")},changeContextMenuIndicators:function(b){var a=staticWidgets.determineStatic(b);staticWidgets.unfixedWidget.hide();staticWidgets.fixedWidget.hide();(a==false)?staticWidgets.unfixedWidget.show():staticWidgets.fixedWidget.show()},updateMenu:function(){propInspectorCtrl.saveSelection();var c=propInspectorCtrl.currentSelection.not(".backgroundWidget");staticWidgets.changeContextMenuIndicators(c);var a=staticWidgets.staticMenuOpen;staticWidgets.hideMenu();if(a==true){var b=staticWidgets.findPositionOnScreen(c);if(c.length>0&&b==true){staticWidgets.showMenu(c)}}},hideMenu:function(){staticWidgets.staticMenuOpen=false;staticWidgets.fixedWidgetsEditor.hide()},positionMenu:function(){var b=$("#staticWidgetBtn");var a=parseInt(b.css("left"));var d=parseInt(b.css("width"));var e=parseInt($("#fixedWidgMenuHolder").css("width"))+(2*(parseInt($("#fixedWidgMenuHolder").css("padding-left"))));var c=a+d-e;staticWidgets.fixedWidgetMenu.css("left",(c)).css("top",45)},showMenu:function(b){staticWidgets.positionMenu();staticWidgets.staticMenuOpen=true;if(!b){propInspectorCtrl.saveSelection();b=propInspectorCtrl.currentSelection}staticWidgets.fixedWidgetsEditor.show();var a=staticWidgets.determineStatic(b);staticWidgets.updateButtonStates(a,b)},updateButtonStates:function(a,c){function b(){staticWidgets.pinnedBtn.hide().removeClass("pinBtnActivated");staticWidgets.unpinnedBtn.removeClass("pinBtnActivated singlePinnedBtn");$("#fixedWidgMenuHolder").removeClass("smallFixedWidgMenu")}b();var d=staticWidgets.findPositionOnScreen(c);if(d==true){switch(a){case (false):staticWidgets.pinnedBtn.show();staticWidgets.unpinnedBtn.addClass("pinBtnActivated");break;case ("front"):staticWidgets.pinnedBtn.show().addClass("pinBtnActivated");break;case ("back"):staticWidgets.pinnedBtn.show().addClass("pinBtnActivated");break}}else{if(a=="front"||a=="back"){staticWidgets.pinnedBtn.show().addClass("pinBtnActivated")}else{$("#fixedWidgMenuHolder").addClass("smallFixedWidgMenu");staticWidgets.unpinnedBtn.addClass("pinBtnActivated singlePinnedBtn");staticWidgets.positionMenu()}}},staticMenuOpen:false,toggleStaticWidgetMenu:function(){if(staticWidgets.staticMenuOpen==true){staticWidgets.hideMenu()}else{staticWidgets.showMenu();contextMenu.removeOtherCmMenus(["propertyInspector"])}},findPositionOnScreen:function(j,m,f){function h(o,u,q){u=$.extend(true,[],u);var s=widget.get(o);var t=20;var p=s.tlwh[2];var w=s.tlwh[3];var v=(u[0]<u[1])?"Portrait":"Landscape";var r=u[0]+t;var n=u[1]+t;if(q!==v){r=u[1]+t;n=u[0]+t}i=((s.tlwh[0]>(n-t-5))||(s.tlwh[1]>(r-t-5)))?false:true}var i=false;if(f==true){var d=$(".page").attr("id");var e=fluid.main.project?fluid.main.project.toJSON():window.top.fluid.main.project.toJSON();var k=e["pageWH"];var c=fluid.main.project?fluid.main.project.pages.get(d).toJSON():window.top.fluid.main.project.pages.get(d).toJSON();if(k){var b=m;var a=c.orientation;h(b,k,a)}}else{var d=project.getActivePageId();var l=widget.getRoots(j);l.each(function(){var p=$(this).attr("id");var n=project.get("pageWH");var o=page.get(d,"orientation");h(p,n,o)})}return i},hideStaticBoundary:function(){$("#staticBoundary1, #staticBoundary2").remove()},drawBoundaries:function(e){var d=$("#staticBoundary1, #staticBoundary2, #staticBoundary3, #staticBoundary4");d.remove();$staticBoundary1=$('<div id="staticBoundary1"></div>');$staticBoundary2=$('<div id="staticBoundary2"></div>');$staticBoundary3=$('<div id="staticBoundary3"></div>');$staticBoundary4=$('<div id="staticBoundary4"></div>');project.getActivePage().append($staticBoundary1,$staticBoundary2,$staticBoundary3,$staticBoundary4);var b=e.pageId,h=e.pageHeight,a=e.pageWidth,c=e.deviceWidth,i=e.deviceHeight,f=1/fluid.zoom.getCurrentScale()*2;if(f<1){f=1}if(h!==i){$staticBoundary1.css({width:c,height:i,background:"linear-gradient(to right, #3FA9F5 0%, #3FA9F5 40.70588%, transparent 40.70588%)",backgroundPosition:"0 bottom",backgroundSize:"30px "+f+"px",backgroundRepeat:"repeat-x"});$staticBoundary2.css({left:15,width:c-15,height:i,background:"linear-gradient(to right, #FFFFFF 0%, #FFFFFF 40.70588%, transparent 40.70588%)",backgroundPosition:"0 bottom",backgroundSize:"30px "+f+"px",backgroundRepeat:"repeat-x"})}if(a!==c){$staticBoundary3.css({width:c,height:i,background:"linear-gradient(to bottom, #3FA9F5 0%, #3FA9F5 40.70588%, transparent 40.70588%)",backgroundPosition:"right 0",backgroundSize:f+"px 30px",backgroundRepeat:"repeat-y"});$staticBoundary4.css({top:15,width:c,height:i-15,background:"linear-gradient(to bottom, #FFFFFF 0%, #FFFFFF 40.70588%, transparent 40.70588%)",backgroundPosition:"right 0",backgroundSize:f+"px 30px",backgroundRepeat:"repeat-y"})}},zoomInBoundary:function(){if(project.readOnly()){return}staticWidgets.hideStaticBoundary();var a=project.getActivePageId();if(a){staticWidgets.showStaticBoundary(a)}},hLimiter:false,vLimiter:false,currentPageId:false,showStaticBoundary:function(d){var c=storage.get(d).width;var h=storage.get(d).height;var a=project.get("pageWH");a=$.extend(true,[],a);var b=page.get(d,"orientation");var f=a[0];var i=a[1];var e=(f<i)?"Portrait":"Landscape";if(b!==e){f=a[1];i=a[0]}staticWidgets.drawBoundaries({pageId:d,pageHeight:h,pageWidth:c,deviceWidth:f,deviceHeight:i})},determineStatic:function(c){allStaticWidgetsFront=[];if(c){var b=c}else{propInspectorCtrl.saveSelection();var b=propInspectorCtrl.currentSelection}b=b.not(".backgroundWidget");var d=b.length;if(d==0){a=false;return}b.each(function(){var f=$(this).attr("id");var e=widget.get(f);if(e.st=="f"){allStaticWidgetsFront.push(f)}});var a=false;if(allStaticWidgetsFront.length==d){a="front"}return a},getSelection:function(){function b(){var e=$(this);var d=e.attr("data-lockto");var c=$("#"+d);var f=widget.getLockTos($("#"+d));a=a.add(f,c)}if(!propInspectorCtrl.currentSelection){propInspectorCtrl.saveSelection()}var a=propInspectorCtrl.currentSelection.not(".backgroundWidget");a.each(b);return a},mapSelection:function(e){var f=$([]);for(var d=0;d<e.length;d++){var c=$("#"+e[d]);var b=c.attr("data-lockto");var a=$("#"+b);var h=widget.getLockTos($("#"+b));f=f.add(h,a)}return f},createZalignOrder:function(b){var a=[];b.each(function(){var c=$(this);var d=c.nextAll(".rootWidget").first().attr("id");a.push({id:c.attr("id"),fromNextId:d})});return a},pushToForeground:function(){var b=staticWidgets.getSelection();if(b.length==0||!b){return}var a=staticWidgets.determineStatic(b);if(a=="toFront"){return}fluid.command.create("staticToForeground",{direction:"toForeground",pastState:a,sel:b,order:staticWidgets.createZalignOrder(b)}).dispatchTo("fluid.controllers.widget")},removeStaticProperty:function(){var b=staticWidgets.getSelection();if(b.length==0||!b){return}var a=staticWidgets.determineStatic(b);if(a==false){return}fluid.command.create("removeStaticWidgets",{pastState:a,sel:b}).dispatchTo("fluid.controllers.widget")},zAlignWidgets:function(d,f,e){var a=widget.getRoots(d);var c=(f=="toBackground")?"cmBack":"cmFront";a.each(function(){var h=$(this);var i=h.attr("id");contextMenu.cmZAlign2(null,h,c)});if(e==false){return}var b=project.getActivePageId();page.renderBlurs(b)},alignAll:function(c){c=c||project.getActivePageId();if(!c){return}var e=storage.get(c);var h=e.widgets;var k=$([]);var l=$([]);var j=false;var a;if(h){for(var d=0;d<h.length;d++){var b=h[d];var f=widget.get(b);if(f.st=="f"){a=$("#"+b);j=staticWidgets.findPositionOnScreen(a);if(j==true){k=k.add(a)}}}}var m=false;staticWidgets.zAlignWidgets(k,"toForeground",m)},create:function(c,d){var b="f";c.each(function(){var f=$(this).attr("id");var e=widget.get(f);widget.set({st:b},f)});var a=staticWidgets.determineStatic(c);staticWidgets.changeContextMenuIndicators(c);staticWidgets.updateButtonStates(a,c)},destroy:function(b){b.each(function(d){var e=$(this).attr("id");var c=fluid.main.project.get(e,{returnModel:true});c.unset("st")});var a=staticWidgets.determineStatic(b);staticWidgets.changeContextMenuIndicators(b);staticWidgets.updateButtonStates(a,b)},undoZalign:function(b){for(var a=b.length-1;a>=0;a--){var f=b[a];var e=$('[data-lockto="'+f.id+'"]');if(f.fromNextId){e.detach().insertBefore("#"+f.fromNextId)}else{var d=e.parent();e.detach().appendTo(d)}}var c=project.getActivePageId();page.renderBlurs(c)}};widget._setupSegments=function(f,d,j,k){var h=[];var f=$.extend(true,{},f);f.sc=f.sc||1;f.sl=f.sl||"h";f.sa=f.sa||"tl";f.sp=f.sp||[0,0,0,0];var c=widget._enumSegments(f,j);var l=f.tlwh||f.wh;var e=(f.sl=="h"?2:3)-(f.tlwh?0:2);if(typeof l[e]=="string"){if(!d){var b=f.of?$("#"+f.of):$("#canvasPages .active .widgetHolder");d=[0,0,b.width(),b.height()]}var a=f.sl=="h"?d[2]:d[3];if(l[e]=="a"&&c.autoSizeSegments.length>0){l[e]=a}else{var i=utils.fromPercentString(l[e],a);if(!isNaN(i)){l[e]=i}}}c.rootTlwh=l;widget._setSegmentTLWH(f,c);return c};widget._enumSegments=function(j,l){function e(C,z,y){if(!z||!(z.tlwh||z.wh)){return}var B={wId:C,wObj:z};if(!y||l===undefined){w.push(B)}else{w.splice(l,0,B);l++}var A=z.tlwh?z.tlwh[c]:z.wh[c-2];if(z.autoSize||typeof A==="string"){z.autoSize=true;r.push(B)}else{n+=A}}var w=[];var r=[];var n=0;var c=j.sl=="h"?2:3;if(j.segments&&j.segments.length>0){if(j.segments.length>0&&j.segments[0].hasOwnProperty("id")){var b=0;var a={};for(var o=0,x=j.segments.length;o<x;o++){var p=widget.get(j.segments[o].id);if(p){var u=j.segments[o].widget;e(u,p);b++;if(a[u]){a[u]++}else{a[u]=1}}}for(var f=b;f<j.sc;f++){var q=Number.MAX_VALUE;var s;for(var t=0;t<j.seg.length;t++){var v=j.seg[t];var k=a[v]||0;if(k<q){q=k;s=v}}var d=widget.get(s);e(s,d,true)}}else{for(var o=0,x=j.segments.length;o<x;o++){var v=j.segments[o].originalID;var d=widget.get(v);if(!d){d=widget.get(j.segments[o].widget)}else{d.id=j.segments[o].widget}e(j.segments[o].widget,d)}}}else{var m=j.seg.length;for(var t=0,i=0;t<j.sc;t++,i=t%m){var v=j.seg[i];var h=widget.get(v);e(v,h)}}return{segments:w,autoSizeSegments:r,totalSize:n}};widget._setSegmentTLWH=function(k,a){var e=k.tlwh||[0,0,k.wh[0],k.wh[1]];var l=k.sl=="h"?1:0;var i=k.sl=="h"?2:3;var j=[k.sp[1]||0,k.sp[0]||0];var c=k.sp[2+l]||0;var d=e[i]-j[l]-c-a.totalSize;if(a.autoSizeSegments.length>0){var n=Math.floor(d/a.autoSizeSegments.length);var m=d-(n*a.autoSizeSegments.length);for(var o=0;o<a.autoSizeSegments.length;o++,m--){var h=a.autoSizeSegments[o].wObj;var q=n+Number(m>0);a.totalSize+=q;if(h.tlwh){h.tlwh[i]=q}else{h.wh[i-2]=q}}}if(e[i]=="a"||a.autoSize){a.autoSize=true;e[i]=a.totalSize+j[l]+c}var f=0;var b=0;if(!a.autoSize){switch(k.sa){case"br":j[l]=e[i]-c-a.totalSize;break;case"c":j[l]+=d>>1;break;case"d":f=Math.floor(d/(k.sc+1));b=d-(f*(k.sc+1));break}}for(var o=0;o<a.segments.length;o++,b--){j[l]+=f+Number(b>0);a.segments[o].pos=[j[0],j[1]];var h=a.segments[o].wObj;var p=h.tlwh||[0,0,h.wh[0],h.wh[1]];j[l]+=p[i]}if(a.autoSize){a.rootTlwh=e;if(k.tlwh){k.tlwh[i]=e[i]}else{k.wh[i-2]=e[i]}}};widget._updateSegments=function(m,h,o){var v=h.segments;var j=$("#"+m.lockTo);for(var r=0;r<v.length;r++){var b=widget._setSegmentBorder(m,v,r);var z=v[r];var w=m.segments[r].id;if(w&&(w.substr(0,2)=="w_"||(w.substr(0,1)=="w"&&w.length==33))){var p={left:parseInt(j.get(0).style.left,10),top:parseInt(j.get(0).style.top,10)};var t=widget.get(w);var c=$("#"+w);var n={left:parseInt(c.get(0).style.left,10),top:parseInt(c.get(0).style.top,10)};var x=z.pos[1]+p.left-n.left;var q=z.pos[0]+p.top-n.top;var l=x!=0||q!=0;var f={tlwh:$.merge([],t.tlwh)};var k=typeof f.tlwh[2]=="string"||typeof f.tlwh[3]=="string";var B=false;var y=[0,0,j.width(),j.height()];var u=widget._setTMPLVars(w,z.wObj,y);var e=$("canvas, img",c);o=o||{};var a=o.redraw=="all"||(o.redraw=="seg"&&o.segId==w);if(l){c.css({left:n.left+x+"px",top:n.top+q+"px"});f.tlwh[0]=z.pos[0];f.tlwh[1]=z.pos[1]}if(k){B=u.absTLWH[2]!=e.width()||u.absTLWH[3]!=e.height()}else{var A=[e.width(),e.height()];B=A[0]!=f.tlwh[2]||A[1]!=f.tlwh[3]}if(B||a){function s(E,F,D){F.add(E).add($("textarea, .widgetText",F)).css({width:D[2]+"px",height:D[3]+"px"});E.attr({width:D[2],height:D[3]})}if(o.redraw=="img"&&e.length&&e.get(0).tagName=="CANVAS"){if(!e.data("replacing")){e.data("replacing",true);var C=new Image();C.src=e.get(0).toDataURL("image/png");C.onload=(function(F,E,G,D){return function(){if(F.data("cancelReplace")){F.data({"replacing":false,"cancelReplace":false})}else{$(E).data("origCanvas",F);F.data("replacing",false).replaceWith(E);var H=widget._setTMPLVars(G,D.wObj,[0,0,j.width(),j.height()]);s($(E),$("#"+G),H.absTLWH)}}})(e,C,w,z)}}else{s(e,c,u.absTLWH)}}if(b){f.b=$.merge([],z.wObj.b)}if(o.redraw!="none"&&o.redraw!="img"&&(b||B||a)){if(e.data("replacing")){e.data("cancelReplace",true)}else{var d=e.data("origCanvas");if(d){e.replaceWith(d).data("origCanvas",null);d.attr({width:u.absTLWH[2],height:u.absTLWH[3]}).css({width:u.absTLWH[2]+"px",height:u.absTLWH[3]+"px"})}}widget._drawCanvasOrImage(c,u)}widget.set(f,w);var i=$('#canvasPages [data-segment="'+w+'"]').not(c);widget._updateDependents(w,y,i)}}widget.set({tlwh:m.tlwh,sc:v.length,segments:m.segments},m.lockTo);widget._updateSegmentRoot(m.lockTo,m,h)};widget._updateSegmentRoot=function(j,i,b){var f=i.tlwh||[0,0,i.wh[0],i.wh[1]];var e=widget._getSegmentRootTLWH(j,i,b);if(!utils.arraysEqual(i.tlwh,e)||utils.isPercentString(e[2])||utils.isPercentString(e[3])){var a=$("#canvasPages .active .widgetHolder");var h=[0,0,a.width(),a.height()];var d=widget._setTMPLVars(j,i,h);d.tlwh=$.merge([],e);var c=$("#"+j);c.css({width:e[2]+"px",height:e[3]+"px"});widget._drawCanvasOrImage(c,d)}};widget._getSegmentRootTLWH=function(i,e,a){var b;if(a&&a.rootTlwh){b=a.rootTlwh}else{var h=!e.sl||e.sl=="h";var d=h?2:3;b=$.merge([],e.tlwh);if(b[d]=="a"){a=widget._enumSegments(e);var c=e.sp?e.sp[h?0:1]:0;var f=e.sp?e.sp[h?3:2]:0;b[d]=a.totalSize+c+f}}return b};widget._setSegmentBorder=function(h,e,b){if(!e){e=h.segments||[]}if(e&&e.length>0){var a=e.length-1;var f=h.sl||"h";var i="bs";if(a>0){switch(b){case 0:i=f=="h"?"bls":"bts";break;case a:i=f=="h"?"brs":"bbs";break;default:i="bms";break}}}var c=e[b].wObj;if(!c.hasOwnProperty("bs")){c.bs=c.b}var d=c.b;c.b=$.merge([],c[i]||c.b||[]);return !utils.arraysEqual(c.b,d||[])};widget._isMultiSegment=function(d){if(d==""){return false}var a=$("#"+d).attr("data-lockto");var c=storage.get(a);var b=c&&c.seg;if(b&&b.length>0){return true}return false};widget._addSegment=function(){var c=[];var a=fluid.selection.getSelectionModel().map(function(d){return d.get("id")});var b=$("#"+a.join(", #"));b.each(function(){var p=$(this).attr("id");var r=$(this).attr("data-segment");var q=Boolean(r);if(q&&$(this).attr("data-segment")!=p){p=$(this).attr("data-segment")}var k=widget.getRoots($(this));var l=k.attr("id");var i=widget.get(l);var h;if(q){h=0;for(var j=i.segments.length;h<j;h++){if(i.segments[h].id==p){h++;break}}}if(i&&i.seg){var o=$("#canvasPages .active");var e=i.of?$("#"+i.of):o.find(".widgetHolder");var n=[0,0,e.width(),e.height()];i.sc++;var d=widget._setupSegments(i,n,h);if(typeof h=="undefined"){h=d.segments.length-1}var m=d.segments[h];var f=widget._createSaveAndDraw(m.wObj,i["lockTo"],o,m.pos,e,n,k.attr("id"),true);i.segments.splice(h,0,{id:f,widget:m.wId});widget._updateSegments(i,d);c.push(f)}return false});fluid.selection.select(a);return c};widget._insertSegmentObj=function(b,d,a,c){b.segments.splice(c,0,{id:d,widget:a.wId});b.sc++;widget._updateSegments(b,widget._setupSegments(b))};widget._getLastSegment=function(b){var c=storage.get(b);var a=c&&c.segments;if(a&&a.length>0){return a[a.length-1].id}return false};widget.getSegmentsFromSelection=function(a){var b=$([]);$(a).each(function(){var d=$(this);var c=d.attr("data-segment");if(!c&&d.hasClass("rootWidget")){var c=widget._getLastSegment(d.attr("id"))}b=b.add($("#"+c))});return b};widget._deleteSegment=function(c,f){function a(){var k=$(this);var n=k.attr("data-segment");var h=k.attr("data-lockTo");if(!n){return}var i=storage.get(h);if(!i){return}var m=$.extend(true,{},storage.get(h));var j=0;for(;j<m.segments.length;j++){if(m.segments[j].id==n){break}}widget.remove(n);m.segments.splice(j,1);m.sc--;storage.set(h,m);if(m.segments.length==0){widget.del($("#"+h));contextMenu.hide();propInspector.resetPropInspector();return}var e=widget._setupSegments(m,null,j,true);widget._updateSegments(m,e);if($("#"+h).hasClass("ui-selected")){b.push(h)}else{var l=(j>0)?j-1:0;b.push(m.segments[l].id)}}var b=[];var d=f?$("#"+f):widget.getSegmentsFromSelection(".ui-selected");d.each(a);fluid.selection.select(b);return false};widget._getSegmentPosition=function(b){var d=$(b).attr("id");var c=storage.get($(b).attr("data-lockto"));var e=0;for(var a=c.segments.length;e<a;e++){if(c.segments[e].id==d){break}}return e};widget._drawFromRoot=function(r,q,c,j,o){j=j||widget.get(r);if(j.st=="g"){var p=j.ad;for(var m=0,h=p.length;m<h;m++){var n=p[m],k=n[0],s=widget.get(k);widget._drawFromRoot(k,q,c,s,[n[2],n[1],n[3]])}}else{var d=widget._draw(r,q,c,j,o);if(j.seg&&j.sc){var b=widget._setupSegments(j,c);for(var e=0,h=b.segments.length;e<h;e++){var f=b.segments[e];var a=[f.pos[0],f.pos[1],c[2],c[3]];widget._drawFromRoot(f.wId,q,a,f.wObj,o)}}if(!(j.ad&&j.ad.length)){return d}for(var e=0,h=j.ad.length;e<h;e++){var k=(d.ad[e])[0];var l=(d.ad[e])[3]||"tl";var o=[(d.ad[e])[2],(d.ad[e])[1],l];var s=false;widget._drawFromRoot(k,q,d.absTLWH,s,o)}}return d};widget._draw=function(i,c,b,a,h,e){var a=a||widget.get(i);if(!a){return false}var d=widget._setTMPLVars(i,a,b,h);if(d.isHelperWidget&&d.upload&&d.upload==="y"){d.data=i}var f=$("#tmplWidget2").tmpl(d);widget._drawCanvasOrImage(f,d);if(c){if(a.st=="b"){c.prepend(f)}else{if(e){if(e==="first"){c.prepend(f)}else{f.insertAfter($("#"+e))}}else{c.append(f)}}}return d};widget.adjustHandlesScale=function(){var f=fluid.zoom.getCurrentScale();var h=Math.round(12/f),c=Math.round(8/f),d=Math.round(8/f),b=Math.round(7/f),e=Math.round(1/f),a=$(".ui-selected .ui-resizable-handle");e=Math.max(e,1);requestAnimationFrame(function(){a.filter(".ui-resizable-n").css({top:-c,height:h});a.filter(".ui-resizable-s").css({bottom:-c,height:h});a.filter(".ui-resizable-e").css({right:-c,width:h});a.filter(".ui-resizable-w").css({left:-c,width:h});a.filter(".ui-resizable-ne").css({top:-b,right:-b,width:d,height:d,"outline-width":e});a.filter(".ui-resizable-nw").css({top:-b,left:-b,width:d,height:d,"outline-width":e});a.filter(".ui-resizable-se").css({bottom:-b,right:-b,width:d,height:d,"outline-width":e});a.filter(".ui-resizable-sw").css({bottom:-b,left:-b,width:d,height:d,"outline-width":e});a.show()})};widget._setTMPLVarsCache=[];widget._setTMPLVars=function(c,i,f,k,b){if(b&&widget._setTMPLVarsCache[c]){return widget._setTMPLVarsCache[c]}if(!b){widget._setTMPLVarsCache=[]}var e=$.extend(true,{},i);e.id=c;e.useCanvas=widget.useCanvas;e.includeCanvasOrImage=(((e.b||e.bg)&&!e.srps)||e.upload||e.i)?true:false;e.isRootwidget=(c==e.lockTo)?true:false;e.isLibaryWidget=(e.lockTo!=undefined)?true:false;e.of=(e.of)?e.of:e.lockTo;e.isText=(i.ts||i.tc)?true:false;e.isBackgroundWidget=(i.st=="b")?true:false;e.isStaticWidgetForeground=(i.st=="f")?true:false;if(i.ts){var h=i.ts.match(/width:\s*100\%;\s*height:\s*100%;\s*white-space:\s*pre-wrap/g);if(h&&h.length){e.addWH=false}else{e.addWH=true}var m;var j="";if(e.ts.indexOf("font-size")!==-1){m=e.ts.substring(i.ts.indexOf("font-size")+10,e.ts.indexOf(";",e.ts.indexOf("font-size"))).trim();m=parseFloat(m)}else{var d=e.ts.match(/font:[^;]*;/g);if(d.length){var l=d[0].match(/[0-9]*px/g);if(l.length){m=parseFloat(l[0])}if(l.length&&l.length>1){j=l[1]}}}if(j===""&&e.ts.indexOf("line-height")!==-1){j=e.ts.substring(e.ts.indexOf("line-height")+12,e.ts.indexOf(";",e.ts.indexOf("line-height"))).trim()}if(m&&j.indexOf("normal")!==-1){if(e.ts.indexOf("line-height")!==-1){e.ts=e.ts.replace(/line-height:\s*normal/g,"line-height: "+Math.round(m*1.14)+"px")}else{e.ts=e.ts.replace(/[0-9]*px\/[0-9]px/g,m+"px/"+Math.round(m*1.14)+"px")}}else{if(m&&j===""){e.ts=e.ts+"; line-height: "+Math.round(m*1.14)+"px;"}}}if(!e.tlwh){var a=e.wh||[f[2],f[3]];e.tlwh=[0,0,a[0],a[1]]}e.ca=(k)?k[2]||"tl":e.ca||"tl";e.absTLWH=widget._getAbsTLWH(c,e,f,k);if(b){widget._setTMPLVarsCache[c]=e}return e};widget._getAbsTLWH=function(n,m,k,c){function h(x,y){var e=parseFloat(x);return Math.round(e*y/100)}if(!m.of||n==m.of){var l=$.extend([],k)}else{var l=$.extend([],k);var d=widget.get(m.of);if(d){l=widget._getAbsTLWH(m.of,d,k,false)}}var r,q;var a=Boolean(m.segment&&d&&d.sp);var w=a?d.sp[0]+d.sp[3]:0;var p=a?d.sp[1]+d.sp[2]:0;if((m.seg||m.segments)&&(m.tlwh[2]=="a"||m.tlwh[3]=="a")){var f=widget._getSegmentRootTLWH(n,m);r=f[2];q=f[3]}else{var r=(m.tlwh[2]==="a")?"100%":m.tlwh[2];var q=(m.tlwh[3]==="a")?"100%":m.tlwh[3]}r=(typeof(r)==="string")?h(r,l[2]-w):r;q=(typeof(q)==="string")?h(q,l[3]-p):q;var v=(c)?c[0]:m.tlwh[0];var b=(c)?c[1]:m.tlwh[1];var j=(typeof(v)==="string")?h(v,l[3]-p):v;var i=(typeof(b)==="string")?h(b,l[2]-w):b;var o=m.ca||"tl";try{var u=(o[0]=="b")?l[3]-q-j:j;var t=(o[1]=="r")?l[2]-r-i:i}catch(s){var u=0;var t=0}u=(o[0]=="c")?j+l[3]/2-q/2:u;t=(o[1]=="c")?i+l[2]/2-r/2:t;u+=l[0];t+=l[1];return[Math.round(u),Math.round(t),Math.round(r),Math.round(q)]};widget._drawCanvasOrImage=function(e,c){if(!c.includeCanvasOrImage){return false}var b={width:c.absTLWH[2],height:c.absTLWH[3]};var d=$("<canvas>").attr(b);var a=d[0].getContext("2d");widget._paintCanvas(e,a,c);return true};widget.getImageData=function(d,b){var c=storage.get(d);var a=d||false;if(a&&a.substr(0,5)!="data:"){if(b&&(!c||!c.storage||c.storage=="cloud")){a=imgCloudUrl+d+".png"}else{a=ajax.apiObjectUrl("img",d)}}else{if(tmplVars.id){if(b&&(!c||!c.storage||c.storage=="cloud")){a=imgCloudUrl+tmplVars.id+".png"}else{a=ajax.apiObjectUrl("img",tmplVars.id)}}}return a};widget._drawPreviewImageUpload=function(c,a){c.get(0).innerHTML='<img class="preview-upload-image">';$imgEl=c.find("img");$imgEl.get(0).onerror=function(){if(this.src.indexOf("/data/img")===-1){this.onerror=function(){};this.src=widget.getImageData(a.data,false)}};if(location.origin==="file://"){var b="";switch(a.type){case"image/svg+xml":b=".svg";break;default:b=".png";break}$imgEl.get(0).src="img/"+a.data+b}else{$imgEl.get(0).src=widget.getImageData(a.data,true)}};widget._drawImageUpload=function(j,d){var b={width:d.absTLWH[2],height:d.absTLWH[3]};var c=j.find("canvas");var e=c.size()>0?c:$("<canvas/>");e.attr(b);var k=e[0].getContext("2d");function f(n,m,l){if(!m.tlwh[2]||!m.tlwh[3]){m.tlwh[2]=this.width;m.tlwh[3]=this.height;n.css({width:m.tlwh[2],height:m.tlwh[3]});$(l.canvas).attr({width:m.tlwh[2],height:m.tlwh[3]});widget.scale(n.closest(".widgetParts"),m)}l.drawImage(this,0,0,m.tlwh[2],m.tlwh[3])}function i(m,l){if(this.src.indexOf("/data/img")===-1){var n=new Image();n.src=h(false);n.onload=f;img=n;n.onerror=function(){$(k.canvas).addClass("failureImage");k.font="32pt Arial";k.fillText("Image",35,50);k.fillText("not found",10,115)}}else{$(k.canvas).addClass("failureImage");k.font="32pt Arial";k.fillText("Image",35,50);k.fillText("not found",10,115)}this.onerror=null}function a(){if(this.src.indexOf("/data/img")===-1){delete this.crossOrigin;this.removeAttribute("crossorigin");this.src=h(false)}else{i.apply(this,arguments);widget._convertCanvasToImg($(k.canvas),j.find("img"),d)}this.onerror=null}function h(m){var n=storage.get(d.data);var l=d.data||false;if(l&&l.substr(0,5)!="data:"){if(m&&(!n||!n.storage||n.storage=="cloud")){l=imgCloudUrl+d.data+".png"}else{l=ajax.apiObjectUrl("img",d.data)}}else{if(d.id){if(m&&(!n||!n.storage||n.storage=="cloud")){l=imgCloudUrl+d.id+".png"}else{l=ajax.apiObjectUrl("img",d.id)}}}return l||i()}if((c.length||j.find("img"))&&d.simpleUploadResize){return}fluid.upload.get({id:d.data||d.id,image:j.find("img").get(0),callback:function(p,o,m,l){if(l.success){if(l.image){f.call(l.image,p,o,m,l.image)}else{if(l.imgData){var n=new Image();n.onload=f.bind(n,p,o,m);n.onerror=i.bind(n,p,o);n.src=l.imgData}}}else{var n=new Image();i.call(n)}}.bind(this,j,d,k),priority:fluid.upload.priority.pageZoomedIn});return};widget._convertCanvasToImg=function(d,c,b){function a(){var e=d[0].toDataURL("image/png");if(e!="data:,"){c.attr("src",e)}}a()};widget._paintCanvas=function(t,o,f){var r={blur:function(){if(f.blur&&!((browserDetect.browser==="Chrome"||browserDetect.browser==="Safari")&&document.domain==="")){var y=t[0],u,v;if(window.g_preview||!storage.get(f.id).getPage){u=storage.get(window.g_preview||project.get("id")).pages;for(var w=0,c=u.length;w<c;w++){var x=u[w];if(storage.get(x).widgets.indexOf(f.id)!==-1){v=x;break}}v=v||document.querySelector(".canvasObject.active").id}else{v=storage.get(f.id,{returnModel:true}).getPage().id}widget.renderBlurLayer(y.id,v,function(i){widget.blurLayers[y.id]=i;widget.setBlurBG(y)});if(widget.blurLayers[y.id]){widget.setBlurBG(y)}}},background:function(){o.save();function c(){var u=(f.bgc)?f.bgc:["#CAD1D7","#C4CBD3"];var w=[5,2];var v="v";if(f.bgd){v=f.bgd[0];w=[f.bgd[1],f.bgd[2]]}o.fillStyle=u[1];o.fill();o.fillStyle=u[0];if(v=="v"){for(var x=w[0];x<d;){o.fillRect(x,0,w[1],s);x+=w[0]}}else{for(var x=w[0];x<s;){o.fillRect(0,x,d,w[1]);x+=w[0]}}}if(!d){d=0}if(!s){s=0}if(f.bg=="c"){o.fillStyle=f.bgc[0];o.fill()}else{if(f.bg=="s"){c()}else{if(f.bg=="l"){g=o.createLinearGradient(0,0,0,s);r._gradient(g,o,f)}else{if(f.bg=="lrl"){g=o.createLinearGradient(0,0,d,0);r._gradient(g,o,f)}else{if(f.bg=="ld"){g=o.createLinearGradient(0,0,d,s);r._gradient(g,o,f)}else{if(f.bg=="ld2"){g=o.createLinearGradient(d,0,0,s);r._gradient(g,o,f)}else{if(f.bg=="r"){g=o.createRadialGradient(d/2,s/2,0,d/2,s/2,s/2);r._gradient(g,o,f)}}}}}}}o.restore()},border:function(y,u,v,i){var x=0,w=0;y.lineWidth=(typeof n)==="number"?n:b;y.strokeStyle=u.b[1];y.stroke();y.save()},path:function(ac,ai,K,F,C,i,v,B,H){ac.beginPath();var W=F+Math.floor(B/2);var aa=C+Math.floor(B/2);var ae=F+v-Math.floor(B/2);var Y=C+i-Math.floor(B/2);if(H.sh&&H.sh[3]&&H.sh[2]){W+=Math.floor(H.sh[3]-H.sh[2]/2);aa+=Math.floor(H.sh[3]-H.sh[2]/2);ae-=Math.floor(H.sh[3]+H.sh[2]/2);Y-=Math.floor(H.sh[3]+H.sh[2]/2)}if($.isArray(K)){for(var ab=0;ab<4;ab++){K[ab]=K[ab]||0}}else{K=[K,K,K,K]}if(ai=="sq"){var ad=Math.min((Y-aa)/2,(ae-W)/2);K[0]=Math.min(K[0],ad);K[1]=Math.min(K[1],ad);K[2]=Math.min(K[2],ad);K[3]=Math.min(K[3],ad);ac.moveTo(aa+K[0],W),ac.lineTo(Y-K[1],W),ac.quadraticCurveTo(Y,W,Y,W+K[1]),ac.lineTo(Y,ae-K[2]),ac.quadraticCurveTo(Y,ae,Y-K[2],ae),ac.lineTo(aa+K[3],ae),ac.quadraticCurveTo(aa,ae,aa,ae-K[3]),ac.lineTo(aa,W+K[0]),ac.quadraticCurveTo(aa,W,aa+K[0],W)}if(ai=="arrU"){var N=w<=P?(ae-W)/2:(Y-aa)+(5/4),w=ae-W,P=(Y-aa)*1.5;var U=[utils.Vector((aa+Y)/2,W+B),utils.Vector(Y-(B/2),W+N),utils.Vector((aa+Y)*0.65,W+N),utils.Vector((aa+Y)*0.65,ae),utils.Vector((aa+Y)*0.35,ae),utils.Vector((aa+Y)*0.35,W+N),utils.Vector(aa+(B/2),W+N)];utils.drawVectors(ac,U,K)}if(ai=="arrD"){var N=(Y-aa)+(5/4);var w=ae-W;var P=(Y-aa)*1.5;if(w<=P){var N=(ae-W)/2}var U=[utils.Vector((aa+Y)/2,ae-B),utils.Vector(Y-(B/2),ae-N),utils.Vector((aa+Y)*0.65,ae-N),utils.Vector((aa+Y)*0.65,W),utils.Vector((aa+Y)*0.35,W),utils.Vector((aa+Y)*0.35,ae-N),utils.Vector(aa+(B/2),ae-N),utils.Vector((aa+Y)/2,ae)];utils.drawVectors(ac,U,K)}if(ai=="arrR"){var N=(ae-W)+(5/4);var z=Y-aa;var M=(ae-W)*1.5;if(z<=M){var N=(Y-aa)/2}var U=[utils.Vector(Y-B,(W+ae)/2),utils.Vector(Y-N,ae-(B/2)),utils.Vector(Y-N,(W+ae)*0.65),utils.Vector(aa,(W+ae)*0.65),utils.Vector(aa,(W+ae)*0.35),utils.Vector(Y-N,(W+ae)*0.35),utils.Vector(Y-N,W+(B/2)),utils.Vector(Y-B,(W+ae)/2),];utils.drawVectors(ac,U,K)}if(ai=="arrL"){var N=(ae-W)+(5/4);var z=Y-aa;var M=(ae-W)*1.5;if(z<=M){var N=(Y-aa)/2}var U=[utils.Vector(aa+B,(W+ae)/2),utils.Vector(aa+N,ae-(B/2)),utils.Vector(aa+N,(W+ae)*0.65),utils.Vector(Y,(W+ae)*0.65),utils.Vector(Y,(W+ae)*0.35),utils.Vector(aa+N,(W+ae)*0.35),utils.Vector(aa+N,W+(B/2)),utils.Vector(aa+B,(W+ae)/2)];utils.drawVectors(ac,U,K)}if(ai=="image"){ac.moveTo(aa,W);ac.lineTo(Y,W);ac.lineTo(Y,ae);ac.lineTo(aa,ae);ac.lineTo(aa,W);ac.moveTo(aa,W);ac.lineTo(aa+1,W);ac.lineTo(Y,ae-1);ac.lineTo(Y,ae);ac.lineTo(Y-1,ae);ac.lineTo(aa,W-1);ac.lineTo(aa,W);ac.moveTo(Y-1,W);ac.lineTo(Y,W);ac.lineTo(Y,W-1);ac.lineTo(aa+1,ae);ac.lineTo(aa,ae);ac.lineTo(aa,ae-1);ac.lineTo(Y-1,W)}else{if(ai=="tri"){var U=[utils.Vector(aa,W),utils.Vector(Y,W),utils.Vector(Y,ae)];utils.drawVectors(ac,U,K)}else{if(ai=="trR"){var U=[utils.Vector(aa,W),utils.Vector(Y,W),utils.Vector(aa,ae)];utils.drawVectors(ac,U,K)}else{if(ai=="ttrL"){var U=[utils.Vector(Y,W),utils.Vector(Y,ae),utils.Vector(aa,ae)];utils.drawVectors(ac,U,K)}else{if(ai=="ttrR"){var U=[utils.Vector(aa,W),utils.Vector(Y,ae),utils.Vector(aa,ae)];utils.drawVectors(ac,U,K)}else{if(ai=="triU"){var U=[utils.Vector((aa+Y)/2,W),utils.Vector(Y,ae),utils.Vector(aa,ae)];utils.drawVectors(ac,U,K)}else{if(ai=="triD"){var U=[utils.Vector(aa,W),utils.Vector(Y,W),utils.Vector((aa+Y)/2,ae)];utils.drawVectors(ac,U,K)}else{if(ai=="triR"){var U=[utils.Vector(aa,W),utils.Vector(Y,(W+ae)/2),utils.Vector(aa,ae)];utils.drawVectors(ac,U,K)}else{if(ai=="triL"){var U=[utils.Vector(Y,W),utils.Vector(aa,(W+ae)/2),utils.Vector(Y,ae)];utils.drawVectors(ac,U,K)}else{if(ai=="ribU"){ac.moveTo(aa,W);ac.lineTo((aa+Y)/2,(W+ae)/4);ac.lineTo(Y,W);ac.lineTo(Y,ae);ac.lineTo(aa,ae);ac.lineTo(aa,W)}else{if(ai=="ribD"){ac.moveTo(aa,W);ac.lineTo(Y,W);ac.lineTo(Y,ae);ac.lineTo((aa+Y)/2,(3/4)*(W+ae));ac.lineTo(aa,ae);ac.lineTo(aa,W)}else{if(ai=="flagR"){ac.moveTo(aa,W);ac.lineTo(Y,W);ac.lineTo((4/5)*(aa+Y),(W+ae)/2);ac.lineTo(Y,ae);ac.lineTo(aa,ae);ac.lineTo(aa,W)}else{if(ai=="flagL"){ac.moveTo(aa,W);ac.lineTo((1/5)*(aa+Y),(W+ae)/2);ac.lineTo(aa,ae);ac.lineTo(Y,ae);ac.lineTo(Y,W);ac.lineTo(aa,W)}else{if(ai=="houseU"){var U=[utils.Vector(Y,(3/7)*(W+ae)),utils.Vector(Y,ae),utils.Vector(aa,ae),utils.Vector(aa,(3/7)*(W+ae)),utils.Vector((aa+Y)/2,W)];utils.drawVectors(ac,U,K)}else{if(ai=="houseD"){var U=[utils.Vector((aa+Y)/2,ae),utils.Vector(Y,(4/7)*(W+ae)),utils.Vector(Y,W),utils.Vector(aa,W),utils.Vector(aa,(4/7)*(W+ae))];utils.drawVectors(ac,U,K)}else{if(ai=="oct"){var ag=21/72,E=51/72,J=aa+Y,I=W+ae,U=[utils.Vector(ag*J,W),utils.Vector(E*J,W),utils.Vector(Y,ag*I),utils.Vector(Y,E*I),utils.Vector(E*J,ae),utils.Vector(ag*J,ae),utils.Vector(aa,E*I),utils.Vector(aa,ag*I)];utils.drawVectors(ac,U,K)}else{if(ai=="star"){var U=[utils.Vector((aa+Y)/2,W),utils.Vector((33/54)*(aa+Y),(39/102)*(ae+W)),utils.Vector(Y,(39/102)*(ae+W)),utils.Vector((75/108)*(aa+Y),(63/102)*(ae+W)),utils.Vector((87/108)*(aa+Y),ae),utils.Vector((aa+Y)/2,(39/51)*(ae+W)),utils.Vector((21/108)*(aa+Y),ae),utils.Vector((33/108)*(aa+Y),(63/102)*(ae+W)),utils.Vector(aa,(39/102)*(ae+W)),utils.Vector((21/54)*(aa+Y),(39/102)*(ae+W))];utils.drawVectors(ac,U,K)}else{if(ai=="pgL"){var U=[utils.Vector(aa,ae),utils.Vector(Y,ae),utils.Vector(Y,W),utils.Vector((aa+Y)/3,W),utils.Vector(aa,(W+ae)/4)];utils.drawVectors(ac,U,K)}else{if(ai=="pgR"){var U=[utils.Vector(Y,ae),utils.Vector(aa,ae),utils.Vector(aa,W),utils.Vector((2/3)*(aa+Y),W),utils.Vector(Y,(W+ae)/4)];utils.drawVectors(ac,U,K)}else{if(ai=="pointrL"){var U=[utils.Vector(aa,W),utils.Vector(Y,W),utils.Vector((5/7)*(aa+Y),(3/7)*(W+ae)),utils.Vector((5/7)*(aa+Y),ae),utils.Vector(aa,W)];utils.drawVectors(ac,U,K)}else{if(ai=="pointrR"){var U=[utils.Vector(aa,W),utils.Vector(Y,W),utils.Vector((2/7)*(aa+Y),ae),utils.Vector((2/7)*(aa+Y),(3/7)*(W+ae)),utils.Vector(aa,W)];utils.drawVectors(ac,U,K)}else{if(ai=="ldL"){ac.moveTo(aa,W);ac.lineTo(aa+2,W);ac.lineTo(Y,ae);ac.lineTo(Y-2,ae);ac.lineTo(aa,W)}else{if(ai=="ldR"){ac.moveTo(Y,W);ac.lineTo(Y-2,W);ac.lineTo(aa,ae);ac.lineTo(aa+2,ae);ac.lineTo(Y,W)}else{if(ai=="dropD"){ac.moveTo((aa+Y)/2,W);ac.lineTo((aa+Y)/6,(W+ae)/2);ac.bezierCurveTo(aa-((aa+Y)*(1.5/6)),ae+((ae+W)/6.2),Y+((aa+Y)*(1.5/6)),ae+((ae+W)/6.2),(aa+Y)*(5/6),(W+ae)/2);ac.lineTo((aa+Y)/2,W)}else{if(ai=="dropU"){ac.moveTo((aa+Y)/2,ae);ac.lineTo((aa+Y)/6,(W+ae)/2);ac.bezierCurveTo(aa-((aa+Y)*(1.5/6)),W-((ae+W)/6.2),Y+((aa+Y)*(1.5/6)),W-((ae+W)/6.2),(aa+Y)*(5/6),(W+ae)/2);ac.lineTo((aa+Y)/2,ae)}else{if(ai=="oval"){ac.moveTo(aa,(ae+W)/2);ac.bezierCurveTo((aa+Y)*(1/4),W-((ae+W)/7),(aa+Y)*(3/4),W-((ae+W)/7),Y,(ae+W)/2);ac.bezierCurveTo((aa+Y)*(3/4),ae+((ae+W)/7),(aa+Y)*(1/4),ae+((ae+W)/7),aa,(ae+W)/2)}else{if(ai=="cloud"){ac.moveTo((aa+Y)*(1.5/9),ae);ac.bezierCurveTo(aa,ae,aa,(W+ae)*(7/11),(aa+Y)*(1.6/9),(ae+W)*(7/11));ac.bezierCurveTo((aa+Y)/9,(ae+W)/3,(aa+Y)/3,(ae+W)/6.3,(aa+Y)*(4/9),(ae+W)/3.2);ac.bezierCurveTo((aa+Y)*(4.5/9),W,(aa+Y)*(7.4/9),W,(aa+Y)*(7.3/9),(ae+W)/2);ac.bezierCurveTo(Y,(ae+W)/2,Y,ae,(aa+Y)*(7.7/9),ae);ac.lineTo((aa+Y)*(1.5/9),ae)}else{if(ai=="person"){ac.moveTo(aa,ae);ac.bezierCurveTo((aa+Y)/16,(W+ae)*(11/14),(aa+Y)*(3/16),(W+ae)*(10/14),(aa+Y)*(6/16),(ae+W)*(9/14));ac.bezierCurveTo((aa+Y)*(2.5/16),(W+ae)*(4/7),(aa+Y)*(2.5/16),W,(aa+Y)/2,W);ac.bezierCurveTo((aa+Y)*(13.5/16),W,(aa+Y)*(13.5/16),(W+ae)*(4/7),(aa+Y)*(10/16),(ae+W)*(9/14));ac.bezierCurveTo((aa+Y)*(13/16),(W+ae)*(10/14),(aa+Y)*(15/16),(W+ae)*(11/14),Y,ae);ac.lineTo(aa,ae)}else{if(ai=="thumbsU"){ac.moveTo(aa,(W+ae)*(16/17));ac.lineTo(aa,(W+ae)*(15/34));ac.bezierCurveTo((aa+Y)*(2/15),(W+ae)*(7/17),(aa+Y)*(9/30),(W+ae)*(4/17),(aa+Y)/3,(ae+W)*(3/34));ac.bezierCurveTo((aa+Y)*(5.2/15),W,(aa+Y)*(9/15),W,(aa+Y)*(8.5/15),(W+ae)*(2/17));ac.lineTo((aa+Y)*(7/15),(W+ae)*(11/34));ac.bezierCurveTo((aa+Y)*(9/15),(W+ae)*(13/34),(aa+Y)*(11/15),(W+ae)*(13/34),(aa+Y)*(12/15),(W+ae)*(13/34));ac.bezierCurveTo(Y,(W+ae)*(13/34),Y,(W+ae)*(19/34),(aa+Y)*(12/15),(W+ae)*(19/34));ac.bezierCurveTo((aa+Y)*(14/15),(W+ae)*(19/34),(aa+Y)*(27/30),(W+ae)*(12/17),(aa+Y)*(23/30),(W+ae)*(12/17));ac.bezierCurveTo((aa+Y)*(13/15),(W+ae)*(12/17),(aa+Y)*(25/30),(W+ae)*(29/34),(aa+Y)*(11/15),(W+ae)*(29/34));ac.bezierCurveTo((aa+Y)*(25/30),(W+ae)*(29/34),(aa+Y)*(12/15),ae,(aa+Y)*(8.5/15),ae);ac.bezierCurveTo((aa+Y)/2,ae,(aa+Y)/5,ae,aa,(W+ae)*(16/17))}else{if(ai=="thumbsD"){ac.moveTo(aa,(W+ae)/17);ac.lineTo(aa,(W+ae)*(19/34));ac.bezierCurveTo((aa+Y)*(2/15),(W+ae)*(10/17),(aa+Y)*(9/30),(W+ae)*(13/17),(aa+Y)/3,(ae+W)*(31/34));ac.bezierCurveTo((aa+Y)*(5.2/15),ae,(aa+Y)*(9/15),ae,(aa+Y)*(8.5/15),(W+ae)*(15/17));ac.lineTo((aa+Y)*(7/15),(W+ae)*(23/34));ac.bezierCurveTo((aa+Y)*(9/15),(W+ae)*(21/34),(aa+Y)*(11/15),(W+ae)*(21/34),(aa+Y)*(12/15),(W+ae)*(21/34));ac.bezierCurveTo(Y,(W+ae)*(21/34),Y,(W+ae)*(15/34),(aa+Y)*(12/15),(W+ae)*(15/34));ac.bezierCurveTo((aa+Y)*(14/15),(W+ae)*(15/34),(aa+Y)*(27/30),(W+ae)*(5/17),(aa+Y)*(23/30),(W+ae)*(5/17));ac.bezierCurveTo((aa+Y)*(13/15),(W+ae)*(5/17),(aa+Y)*(25/30),(W+ae)*(5/34),(aa+Y)*(11/15),(W+ae)*(5/34));ac.bezierCurveTo((aa+Y)*(25/30),(W+ae)*(5/34),(aa+Y)*(12/15),W,(aa+Y)*(8.5/15),W);ac.bezierCurveTo((aa+Y)/2,W,(aa+Y)/5,W,aa,(W+ae)/17)}else{if(ai=="arcL"){var i=Y-aa;var v=ae-W;var X=(v>=(i*2))?i:v/2;ac.moveTo(aa+X,W);ac.arcTo(aa,W,aa,W+X,X);ac.arcTo(aa,W+(2*X),aa+X,W+(2*X),X);ac.lineTo(aa+X,W)}else{if(ai=="arcR"){var i=Y-aa;var v=ae-W;var X=(v>=(i*2))?i:v/2;ac.moveTo(aa,W);ac.arcTo(aa+X,W,aa+X,W+X,X);ac.arcTo(aa+X,W+(2*X),aa,W+(2*X),X);ac.lineTo(aa,W)}else{if(ai=="arcU"){var i=Y-aa;var v=ae-W;var X=(i>=(v*2))?v:i/2;ac.moveTo(aa,W+X);ac.arcTo(aa,W,aa+X,W,X);ac.arcTo(aa+(2*X),W,aa+(2*X),W+(2*X),X);ac.lineTo(aa,W+X)}else{if(ai=="arcD"){var i=Y-aa;var v=ae-W;var X=(i>=(v*2))?v:i/2;ac.moveTo(aa,W);ac.arcTo(aa,W+X,aa+X,W+X,X);ac.arcTo(aa+(2*X),W+X,aa+(2*X),W,X);ac.lineTo(aa,W)}else{if(ai=="folder"){var S=K[0],i=Y-W,v=ae-W,L={x:(3/8)*(Y+aa),y:(2/15)*(W+ae)},G={x:(5/16)*(Y+aa),y:W},R={x:G.x+(L.x-G.x)/2,y:W+(L.y-W)/2},af=Math.sqrt(R.x*R.x+R.y*R.y);K[1]=Math.min(S,(i-L.x)/2,v/2);K[2]=Math.min(S,(ae-L.y)/2,(L.x-W)/2);K[4]=Math.min(S,v/2,(G.x-aa)/2),K[1]=K[4]=Math.min(K[1],K[4]);K[3]=Math.min(K[4],K[2]);K[0]=Math.min(S,af,K[4]);K[5]=K[0];ac.moveTo(L.x+K[0],L.y);ac.lineTo(Y-K[1],L.y);ac.quadraticCurveTo(Y,L.y,Y,L.y+K[1]);ac.lineTo(Y,ae-K[2]);ac.quadraticCurveTo(Y,ae,Y-K[2],ae);ac.lineTo(aa+K[3],ae);ac.quadraticCurveTo(aa,ae,aa,ae-K[3]);ac.lineTo(aa,W+K[4]);ac.quadraticCurveTo(aa,W,aa+K[4],W);ac.lineTo(G.x-K[5],G.y);ac.quadraticCurveTo(G.x,G.y,R.x,R.y);ac.quadraticCurveTo(L.x,L.y,L.x+K[0],L.y)}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}if(ai=="speechRight"){ac.moveTo(Y-17,ae);ac.lineTo(Y-96,ae-13);ac.lineTo(aa,ae-13);ac.lineTo(aa,W);ac.lineTo(Y,W);ac.lineTo(Y,ae-13);ac.lineTo(Y-38,ae-13);ac.lineTo(Y-17,ae)}if(ai=="speechLeft"){ac.moveTo(aa+17,ae);ac.lineTo(aa+96,ae-13);ac.lineTo(Y,ae-13);ac.lineTo(Y,W);ac.lineTo(aa,W);ac.lineTo(aa,ae-13);ac.lineTo(aa+38,ae-13);ac.lineTo(aa+17,ae)}else{if(ai=="bubr"){right=i-1;bottom=v-2;tailSize=7;if(H.b){F=F+H.b[0]/2;C=C+H.b[0]/2;right=right-H.b[0]/2;bottom=bottom-H.b[0]/2}ac.moveTo(right-tailSize,bottom-7);ac.lineTo(right-tailSize,F+K[1]);ac.quadraticCurveTo(right-tailSize,F,right-K[1]-tailSize,F);ac.lineTo(C+K[0],F);ac.quadraticCurveTo(C,F,C,F+K[0]);ac.lineTo(C,bottom-K[3]);ac.quadraticCurveTo(C,bottom,C+K[3],bottom);ac.lineTo(right-19,bottom);ac.quadraticCurveTo(right-15,bottom-1,right-14,bottom-2);ac.quadraticCurveTo(right-7,bottom+1,right-1,bottom-2);ac.quadraticCurveTo(right-tailSize,bottom-3,right-tailSize,bottom-7)}else{if(ai=="bubl"){right=i-1;bottom=v-2;tailSize=7;if(H.b){F=F+H.b[0]/2;C=C+H.b[0]/2;right=right-H.b[0]/2;bottom=bottom-H.b[0]/2}ac.moveTo(right,bottom-K[2]);ac.lineTo(right,F+K[1]);ac.quadraticCurveTo(right,F,right-K[1],F);ac.lineTo(C+K[0]+tailSize,F);ac.quadraticCurveTo(C+tailSize,F,C+tailSize,F+K[0]);ac.lineTo(C+tailSize,bottom-6);ac.quadraticCurveTo(C+4,bottom-1,C+1,bottom-2);ac.quadraticCurveTo(C+2,bottom+2,C+13,bottom-2);ac.quadraticCurveTo(C+15,bottom,C+19,bottom);ac.lineTo(right-K[2],bottom);ac.quadraticCurveTo(right,bottom,right,bottom-K[2])}else{if(ai=="arrowL"||ai=="arrowR"||ai=="arrowU"||ai=="arrowD"){var ah=2;if(H.aCurve){ah=H.aCurve}var O=12;if(H.aSize){O=H.aSize}if(ai=="arrowL"){ac.moveTo(aa+O,W);ac.lineTo(Y-K[1],W);ac.quadraticCurveTo(Y,W,Y,W+K[1]);ac.lineTo(Y,ae-K[2]);ac.quadraticCurveTo(Y,ae,Y-K[2],ae);ac.lineTo(aa+O,ae);ac.bezierCurveTo(aa+O-ah,ae,aa,((ae+W)/2)+ah,aa,(ae+W)/2);ac.bezierCurveTo(aa,((ae+W)/2)-ah,O-ah,W,aa+O,W)}else{if(ai=="arrowR"){ac.moveTo(aa+K[0],W);ac.lineTo(Y-O,W);ac.bezierCurveTo(Y-O+ah,W,Y,((W+ae)/2)-ah,Y,(W+ae)/2);ac.bezierCurveTo(Y,((W+ae)/2)+ah,Y-O+ah,ae,Y-O,ae);ac.lineTo(aa+K[3],ae);ac.quadraticCurveTo(aa,ae,aa,ae-K[3]);ac.lineTo(aa,W+K[0]);ac.quadraticCurveTo(aa,W,aa+K[0],W)}else{if(ai=="arrowD"){var A=(H.aW)?H.aW:A;var u=(aa+Y)/2;var Z=A/2;ac.moveTo(aa+K[0],W);ac.lineTo(Y-K[1],W);ac.quadraticCurveTo(Y,W,Y,W+K[1]);ac.lineTo(Y,ae-O-K[2]);ac.quadraticCurveTo(Y,ae-O,Y-K[2],ae-O);ac.lineTo(u+Z,ae-O);ac.lineTo(u,ae);ac.lineTo(u-Z,ae-O);ac.lineTo(aa+K[3],ae-O);ac.quadraticCurveTo(aa,ae-O,aa,ae-O-K[3]);ac.lineTo(aa,W+K[0]);ac.quadraticCurveTo(aa,W,aa+K[0],W)}else{if(ai=="arrowU"){var A=(H.aW)?H.aW:20;var u=(aa+Y)/2;var Z=A/2;ac.moveTo(aa+K[0],W+O);ac.lineTo(u-Z,W+O);ac.lineTo(u,W);ac.lineTo(u+Z,W+O);ac.lineTo(Y-K[1],W+O);ac.quadraticCurveTo(Y,W+O,Y,W+O+K[1]);ac.lineTo(Y,ae-K[2]);ac.quadraticCurveTo(Y,ae,Y-K[2],ae);ac.lineTo(aa+K[2],ae);ac.quadraticCurveTo(aa,ae,aa,ae-K[3]);ac.lineTo(aa,W+O+K[0]);ac.quadraticCurveTo(aa,W+O,aa+K[3],W+O)}}}}}else{if(ai=="c"){var V=i/2,T=v/2,D=Math.min(V,T),Q=Math.min(B|0,D),X=D-Q/2;if(X<0){X=0}n=Q;ac.arc(V,T,X,0,Math.PI*2,true)}}}}}ac.closePath()},_gradient:function(y,A,w){var u=["#ffffff","#000000"];var x=[0,1];if(w.bgc&&w.bgd){u=w.bgc;x=w.bgd}for(var v=0;v<u.length&&v<x.length;v++){try{y.addColorStop(x[v],u[v])}catch(z){}}A.fillStyle=y;A.fill()},_glaze:function(y,v){var C=5,z=2,w=10,u=v.absTLWH[2]-27,B=10,i=0,A=7;if(v.s=="bubl"){w+=A}r.path(y,"sq",C,z,w,u,B,i,v);var x=y.createLinearGradient(0,z+B,0,z);x.addColorStop(0,"rgba(231, 231, 231, 0.2)");x.addColorStop(0.59,"rgba(240, 240, 240, 0.25)");x.addColorStop(1,"rgba(249, 249, 249, 0.3)");y.fillStyle=x;y.fill();y.restore()},_shadow:function(u,i){u.shadowColor=i.sh[0];u.shadowOffsetX=i.sh[1];u.shadowOffsetY=i.sh[2];u.shadowBlur=i.sh[3]},_effect:function(G,v){var u=v.fx;for(var B=0;B<u.length;B++){var D=u[B];if(D[0]=="dots"){var K=D[1];var E=D[2];var J=D[3];G.fillStyle=D[4];var x=v.absTLWH[2];var w=v.absTLWH[3];var H=K+E;var C=K+J;var I=parseInt(x/H)+1;var F=parseInt(w/C)+1;var A=0;for(var z=0;z<F;z++){A=(A)?0:K;for(var y=0;y<I;y++){G.beginPath();G.arc((y*H)+A,(z*C),K/2,0,2*Math.PI);G.closePath();G.fill()}}}}},_setImage:function(y,A,w){try{if(w.useCanvas){var i={width:w.absTLWH[2],height:w.absTLWH[3]};var u=y.find("canvas").attr(i);var x=u[0].getContext("2d");x.drawImage(A.canvas,0,0)}else{var v=y.find("img");widget._convertCanvasToImg($(A.canvas),v,w)}}catch(z){}}};if(!t[0].classList.contains("ui-resizable-resizing")){r.blur()}if(typeof f.upload==="string"&&f.upload=="y"){if(window.g_preview){widget._drawPreviewImageUpload(t,f)}else{widget._drawImageUpload(t,f)}return}var q=0,h=0;var d=f.absTLWH[2];var s=f.absTLWH[3];var b=0;var e=0;var j=f.b;var n=null;if(j){b=j[0];e=j.length>3?j.slice(2):j[2]}var m=f.s?f.s:"sq";o.save();r.path(o,m,e,q,h,d,s,b,f);if(f.sh){r._shadow(o,f)}if(f.bg){r.background(o,f)}o.restore();if(j&&b>0){r.border(o,f,d,s)}if(f.glaze&&f.glaze=="y"){r._glaze(o,f)}if(f.fx&&f.fx.length>0){r._effect(o,f)}if(f.i){for(var l=0;l<f.i.length;l++){var p=f.i[l];var k=new Image();function a(){var i=p[5];if(typeof(i)=="string"&&i.search("%")!=-1){i=(d*parseInt(i)/100)-p[3]/2}else{if(i<0){i=parseInt(d)+p[5]-p[3]}}var c=p[6];if(typeof(c)=="string"&&c.search("%")!=-1){c=(s*parseInt(c)/100)-p[4]/2}else{if(c<0){c=parseInt(s)+p[6]-p[4]}}k.onload=function(){try{o.drawImage(k,p[1],p[2],p[3],p[4],i+h,c+q,p[3],p[4]);r._setImage(t,o,f);if(o.canvas.hasOwnProperty("onchange")){o.canvas.onchange()}}catch(u){}};k.src=p[0]}$(k).ready(a)}}else{r._setImage(t,o,f)}};widget.scale=function(f,a){var c=10;var e;if(a.ls){e=a.ls}else{if(typeof a.wh==="undefined"){e=66/80}else{if(a.wh[0]=="a"||a.wh[1]=="a"){e=66/320}else{if(a.wh[0]=="100%"||a.wh[1]=="100%"){e=66/320}else{if(typeof(a.wh[0])==="string"||typeof(a.wh[1])==="string"){var d=parseInt(a.wh[0])/640;var b=parseInt(a.wh[1])/640;e=Math.max(d,b)}else{e=Math.min(1,66/a.wh[0],66/a.wh[1])}}}}}if(e<1){$(f).css({"-webkit-transform":"scale("+e+")","-moz-transform":"scale("+e+")"})}};var qrCode={setURL:function(b,a){qrCode._setCode(document.querySelector("#qrHolder img"),b,a)},setShareURL:function(b,a){var c=document.querySelectorAll(".qrContainer");fluid.util._.each(c,function(d){qrCode._setCode(d,b,a)})},_setCode:function(b,c,a){if(b instanceof HTMLImageElement){b.src=qr.dataUrl(c)}else{b.style.backgroundImage="url("+qr.dataUrl(c,a||200)+")";b.style.backgroundPosition="center";b.style.backgroundRepeat="no-repeat"}}};var qr=function(){var o=function(C,s){var K=236;var J=17;var w=C;var y=j[s];var u=null;var F=0;var q=null;var A=new Array();var G={dark:"#000",bright:"#FFF"};var D=function(M,L){F=w*4+17;u=function(Q){var O=new Array(Q);for(var P=0;P<Q;P+=1){O[P]=new Array(Q);for(var N=0;N<Q;N+=1){O[P][N]=null}}return O}(F);z(0,0);z(F-7,0);z(0,F-7);B();r();I(M,L);if(w>=7){x(M)}if(q==null){q=t(w,y,A)}E(q,L)};var z=function(N,L){for(var M=-1;M<=7;M+=1){if(N+M<=-1||F<=N+M){continue}for(var O=-1;O<=7;O+=1){if(L+O<=-1||F<=L+O){continue}if((0<=M&&M<=6&&(O==0||O==6))||(0<=O&&O<=6&&(M==0||M==6))||(2<=M&&M<=4&&2<=O&&O<=4)){u[N+M][L+O]=true}else{u[N+M][L+O]=false}}}};var v=function(){var O=0;var N=0;for(var M=0;M<8;M+=1){D(true,M);var L=i.getLostPoint(G);if(M==0||O>L){O=L;N=M}}return N};var r=function(){for(var L=8;L<F-8;L+=1){if(u[L][6]!=null){continue}u[L][6]=(L%2==0)}for(var M=8;M<F-8;M+=1){if(u[6][M]!=null){continue}u[6][M]=(M%2==0)}};var B=function(){var R=i.getPatternPosition(w);for(var N=0;N<R.length;N+=1){for(var M=0;M<R.length;M+=1){var P=R[N];var L=R[M];if(u[P][L]!=null){continue}for(var O=-2;O<=2;O+=1){for(var Q=-2;Q<=2;Q+=1){if(O==-2||O==2||Q==-2||Q==2||(O==0&&Q==0)){u[P+O][L+Q]=true}else{u[P+O][L+Q]=false}}}}}};var x=function(O){var N=i.getBCHTypeNumber(w);for(var M=0;M<18;M+=1){var L=(!O&&((N>>M)&1)==1);u[Math.floor(M/3)][M%3+F-8-3]=L}for(var M=0;M<18;M+=1){var L=(!O&&((N>>M)&1)==1);u[M%3+F-8-3][Math.floor(M/3)]=L}};var I=function(Q,P){var O=(y<<3)|P;var N=i.getBCHTypeInfo(O);for(var M=0;M<15;M+=1){var L=(!Q&&((N>>M)&1)==1);if(M<6){u[M][8]=L}else{if(M<8){u[M+1][8]=L}else{u[F-15+M][8]=L}}}for(var M=0;M<15;M+=1){var L=(!Q&&((N>>M)&1)==1);if(M<8){u[8][F-M-1]=L}else{if(M<9){u[8][15-M-1+1]=L}else{u[8][15-M-1]=L}}}u[F-8][8]=(!Q)};var E=function(Q,M){var O=-1;var V=F-1;var P=7;var L=0;var T=i.getMaskFunction(M);for(var N=F-1;N>0;N-=2){if(N==6){N-=1}while(true){for(var S=0;S<2;S+=1){if(u[V][N-S]==null){var R=false;if(L<Q.length){R=(((Q[L]>>>P)&1)==1)}var U=T(V,N-S);if(U){R=!R}u[V][N-S]=R;P-=1;if(P==-1){L+=1;P=7}}}V+=O;if(V<0||F<=V){V-=O;O=-O;break}}}};var H=function(V,Y){var N=0;var ab=0;var Z=0;var M=new Array(Y.length);var Q=new Array(Y.length);for(var T=0;T<Y.length;T+=1){var U=Y[T].dataCount;var L=Y[T].totalCount-U;ab=Math.max(ab,U);Z=Math.max(Z,L);M[T]=new Array(U);for(var W=0;W<M[T].length;W+=1){M[T][W]=255&V.getBuffer()[W+N]}N+=U;var R=i.getErrorCorrectPolynomial(L);var aa=e(M[T],R.getLength()-1);var O=aa.mod(R);Q[T]=new Array(R.getLength()-1);for(var W=0;W<Q[T].length;W+=1){var S=W+O.getLength()-Q[T].length;Q[T][W]=(S>=0)?O.get(S):0}}var X=0;for(var W=0;W<Y.length;W+=1){X+=Y[W].totalCount}var ac=new Array(X);var P=0;for(var W=0;W<ab;W+=1){for(var T=0;T<Y.length;T+=1){if(W<M[T].length){ac[P]=M[T][W];P+=1}}}for(var W=0;W<Z;W+=1){for(var T=0;T<Y.length;T+=1){if(W<Q[T].length){ac[P]=Q[T][W];P+=1}}}return ac};var t=function(S,R,O){var M=h.getRSBlocks(S,R);var L=f();for(var N=0;N<O.length;N+=1){var Q=O[N];L.put(Q.getMode(),4);L.put(Q.getLength(),i.getLengthInBits(Q.getMode(),S));Q.write(L)}var P=0;for(var N=0;N<M.length;N+=1){P+=M[N].dataCount}if(L.getLengthInBits()>P*8){throw new Error("code length overflow. ("+L.getLengthInBits()+">"+P*8+")")}if(L.getLengthInBits()+4<=P*8){L.put(0,4)}while(L.getLengthInBits()%8!=0){L.putBit(false)}while(true){if(L.getLengthInBits()>=P*8){break}L.put(K,8);if(L.getLengthInBits()>=P*8){break}L.put(J,8)}return H(L,M)};G.addData=function(M){var L=n(M);A.push(L);q=null};G.isDark=function(M,L){if(M<0||F<=M||L<0||F<=L){throw new Error(M+","+L)}return u[M][L]};G.getModuleCount=function(){return F};G.make=function(){D(false,v())};G.createImgTag=function(P,O){P=P||2;O=(typeof O=="undefined")?P*4:O;var N=G.getModuleCount()*P+O*2;var M=O;var L=N-O;return d(N,N,function(Q,T){if(M<=Q&&Q<L&&M<=T&&T<L){var S=Math.floor((Q-M)/P);var R=Math.floor((T-M)/P);return G.isDark(R,S)?0:1}else{return 1}})};G.createDataUrl=function(T,P){T=T||200;var R=G.getModuleCount(),M=(T/R|0)||1,O=document.createElement("canvas"),N=O.getContext("2d");O.width=O.height=T;P=(T-M*R)/2|0;N.translate(P,P);for(var L=0;L<R;L++){var Q=L*M;for(var S=0;S<R;S++){N.fillStyle=G.isDark(L,S)?G.dark:G.bright;N.fillRect(S*M,Q,M,M)}}return O.toDataURL()};return G};o.dataUrl=function(v,t,u,s){u=u|0>0?u|0:1;s=s||"L";try{var q=o(u,s);q.addData(v);q.make();return q.createDataUrl(t)}catch(r){if(/code length overflow/.test(r.message)){return o.dataUrl(v,t,u+1,s)}else{throw (r)}}};o.stringToBytes=function(t){var q=new Array();for(var r=0;r<t.length;r+=1){var u=t.charCodeAt(r);q.push(u&255)}return q};o.createStringToBytes=function(t,s){var r=function(){var E=a(t);var u=function(){var v=E.read();if(v==-1){throw new Error()}return v};var x=0;var y={};while(true){var C=E.read();if(C==-1){break}var B=u();var A=u();var z=u();var w=String.fromCharCode((C<<8)|B);var D=(A<<8)|z;y[w]=D;x+=1}if(x!=s){throw new Error(x+" != "+s)}return y}();var q="?".charCodeAt(0);return function(x){var v=new Array();for(var w=0;w<x.length;w+=1){var y=x.charCodeAt(w);if(y<128){v.push(y)}else{var u=r[x.charAt(w)];if(typeof u=="number"){if((u&255)==u){v.push(u)}else{v.push(u>>>8);v.push(u&255)}}else{v.push(q)}}}return v}};var k={MODE_NUMBER:1<<0,MODE_ALPHA_NUM:1<<1,MODE_8BIT_BYTE:1<<2,MODE_KANJI:1<<3};var j={L:1,M:0,Q:3,H:2};var c={PATTERN000:0,PATTERN001:1,PATTERN010:2,PATTERN011:3,PATTERN100:4,PATTERN101:5,PATTERN110:6,PATTERN111:7};var i=function(){var t=[[],[6,18],[6,22],[6,26],[6,30],[6,34],[6,22,38],[6,24,42],[6,26,46],[6,28,50],[6,30,54],[6,32,58],[6,34,62],[6,26,46,66],[6,26,48,70],[6,26,50,74],[6,30,54,78],[6,30,56,82],[6,30,58,86],[6,34,62,90],[6,28,50,72,94],[6,26,50,74,98],[6,30,54,78,102],[6,28,54,80,106],[6,32,58,84,110],[6,30,58,86,114],[6,34,62,90,118],[6,26,50,74,98,122],[6,30,54,78,102,126],[6,26,52,78,104,130],[6,30,56,82,108,134],[6,34,60,86,112,138],[6,30,58,86,114,142],[6,34,62,90,118,146],[6,30,54,78,102,126,150],[6,24,50,76,102,128,154],[6,28,54,80,106,132,158],[6,32,58,84,110,136,162],[6,26,54,82,110,138,166],[6,30,58,86,114,142,170]];var q=(1<<10)|(1<<8)|(1<<5)|(1<<4)|(1<<2)|(1<<1)|(1<<0);var v=(1<<12)|(1<<11)|(1<<10)|(1<<9)|(1<<8)|(1<<5)|(1<<2)|(1<<0);var s=(1<<14)|(1<<12)|(1<<10)|(1<<4)|(1<<1);var u={};var r=function(w){var x=0;while(w!=0){x+=1;w>>>=1}return x};u.getBCHTypeInfo=function(w){var x=w<<10;while(r(x)-r(q)>=0){x^=(q<<(r(x)-r(q)))}return((w<<10)|x)^s};u.getBCHTypeNumber=function(w){var x=w<<12;while(r(x)-r(v)>=0){x^=(v<<(r(x)-r(v)))}return(w<<12)|x};u.getPatternPosition=function(w){return t[w-1]};u.getMaskFunction=function(w){switch(w){case c.PATTERN000:return function(y,x){return(y+x)%2==0};case c.PATTERN001:return function(y,x){return y%2==0};case c.PATTERN010:return function(y,x){return x%3==0};case c.PATTERN011:return function(y,x){return(y+x)%3==0};case c.PATTERN100:return function(y,x){return(Math.floor(y/2)+Math.floor(x/3))%2==0};case c.PATTERN101:return function(y,x){return(y*x)%2+(y*x)%3==0};case c.PATTERN110:return function(y,x){return((y*x)%2+(y*x)%3)%2==0};case c.PATTERN111:return function(y,x){return((y*x)%3+(y+x)%2)%2==0};default:throw new Error("bad maskPattern:"+w)}};u.getErrorCorrectPolynomial=function(x){var w=e([1],0);for(var y=0;y<x;y+=1){w=w.multiply(e([1,p.gexp(y)],0))}return w};u.getLengthInBits=function(x,w){if(1<=w&&w<10){switch(x){case k.MODE_NUMBER:return 10;case k.MODE_ALPHA_NUM:return 9;case k.MODE_8BIT_BYTE:return 8;case k.MODE_KANJI:return 8;default:throw new Error("mode:"+x)}}else{if(w<27){switch(x){case k.MODE_NUMBER:return 12;case k.MODE_ALPHA_NUM:return 11;case k.MODE_8BIT_BYTE:return 16;case k.MODE_KANJI:return 10;default:throw new Error("mode:"+x)}}else{if(w<41){switch(x){case k.MODE_NUMBER:return 14;case k.MODE_ALPHA_NUM:return 13;case k.MODE_8BIT_BYTE:return 16;case k.MODE_KANJI:return 12;default:throw new Error("mode:"+x)}}else{throw new Error("type:"+w)}}}};u.getLostPoint=function(F){var y=F.getModuleCount();var z=0;for(var H=0;H<y;H+=1){for(var x=0;x<y;x+=1){var E=0;var D=F.isDark(H,x);for(var w=-1;w<=1;w+=1){if(H+w<0||y<=H+w){continue}for(var C=-1;C<=1;C+=1){if(x+C<0||y<=x+C){continue}if(w==0&&C==0){continue}if(D==F.isDark(H+w,x+C)){E+=1}}}if(E>5){z+=(3+E-5)}}}for(var H=0;H<y-1;H+=1){for(var x=0;x<y-1;x+=1){var A=0;if(F.isDark(H,x)){A+=1}if(F.isDark(H+1,x)){A+=1}if(F.isDark(H,x+1)){A+=1}if(F.isDark(H+1,x+1)){A+=1}if(A==0||A==4){z+=3}}}for(var H=0;H<y;H+=1){for(var x=0;x<y-6;x+=1){if(F.isDark(H,x)&&!F.isDark(H,x+1)&&F.isDark(H,x+2)&&F.isDark(H,x+3)&&F.isDark(H,x+4)&&!F.isDark(H,x+5)&&F.isDark(H,x+6)){z+=40}}}for(var x=0;x<y;x+=1){for(var H=0;H<y-6;H+=1){if(F.isDark(H,x)&&!F.isDark(H+1,x)&&F.isDark(H+2,x)&&F.isDark(H+3,x)&&F.isDark(H+4,x)&&!F.isDark(H+5,x)&&F.isDark(H+6,x)){z+=40}}}var G=0;for(var x=0;x<y;x+=1){for(var H=0;H<y;H+=1){if(F.isDark(H,x)){G+=1}}}var B=Math.abs(100*G/y/y-50)/5;z+=B*10;return z};return u}();var p=function(){var q=new Array(256);var s=new Array(256);for(var r=0;r<8;r+=1){q[r]=1<<r}for(var r=8;r<256;r+=1){q[r]=q[r-4]^q[r-5]^q[r-6]^q[r-8]}for(var r=0;r<255;r+=1){s[q[r]]=r}var t={};t.glog=function(u){if(u<1){throw new Error("glog("+u+")")}return s[u]};t.gexp=function(u){while(u<0){u+=255}while(u>=256){u-=255}return q[u]};return t}();function e(r,q){if(typeof r.length=="undefined"){throw new Error(r.length+"/"+q)}var s=function(){var w=0;while(w<r.length&&r[w]==0){w+=1}var v=new Array(r.length-w+q);for(var u=0;u<r.length-w;u+=1){v[u]=r[u+w]}return v}();var t={};t.get=function(u){return s[u]};t.getLength=function(){return s.length};t.multiply=function(x){var v=new Array(t.getLength()+x.getLength()-1);for(var w=0;w<t.getLength();w+=1){for(var u=0;u<x.getLength();u+=1){v[w+u]^=p.gexp(p.glog(t.get(w))+p.glog(x.get(u)))}}return e(v,0)};t.mod=function(x){if(t.getLength()-x.getLength()<0){return t}var w=p.glog(t.get(0))-p.glog(x.get(0));var u=new Array(t.getLength());for(var v=0;v<t.getLength();v+=1){u[v]=t.get(v)}for(var v=0;v<x.getLength();v+=1){u[v]^=p.gexp(p.glog(x.get(v))+w)}return e(u,0).mod(x)};return t}var h=function(){var r=[[1,26,19],[1,26,16],[1,26,13],[1,26,9],[1,44,34],[1,44,28],[1,44,22],[1,44,16],[1,70,55],[1,70,44],[2,35,17],[2,35,13],[1,100,80],[2,50,32],[2,50,24],[4,25,9],[1,134,108],[2,67,43],[2,33,15,2,34,16],[2,33,11,2,34,12],[2,86,68],[4,43,27],[4,43,19],[4,43,15],[2,98,78],[4,49,31],[2,32,14,4,33,15],[4,39,13,1,40,14],[2,121,97],[2,60,38,2,61,39],[4,40,18,2,41,19],[4,40,14,2,41,15],[2,146,116],[3,58,36,2,59,37],[4,36,16,4,37,17],[4,36,12,4,37,13],[2,86,68,2,87,69],[4,69,43,1,70,44],[6,43,19,2,44,20],[6,43,15,2,44,16],[4,101,81],[1,80,50,4,81,51],[4,50,22,4,51,23],[3,36,12,8,37,13],[2,116,92,2,117,93],[6,58,36,2,59,37],[4,46,20,6,47,21],[7,42,14,4,43,15],[4,133,107],[8,59,37,1,60,38],[8,44,20,4,45,21],[12,33,11,4,34,12],[3,145,115,1,146,116],[4,64,40,5,65,41],[11,36,16,5,37,17],[11,36,12,5,37,13],[5,109,87,1,110,88],[5,65,41,5,66,42],[5,54,24,7,55,25],[11,36,12],[5,122,98,1,123,99],[7,73,45,3,74,46],[15,43,19,2,44,20],[3,45,15,13,46,16],[1,135,107,5,136,108],[10,74,46,1,75,47],[1,50,22,15,51,23],[2,42,14,17,43,15],[5,150,120,1,151,121],[9,69,43,4,70,44],[17,50,22,1,51,23],[2,42,14,19,43,15],[3,141,113,4,142,114],[3,70,44,11,71,45],[17,47,21,4,48,22],[9,39,13,16,40,14],[3,135,107,5,136,108],[3,67,41,13,68,42],[15,54,24,5,55,25],[15,43,15,10,44,16],[4,144,116,4,145,117],[17,68,42],[17,50,22,6,51,23],[19,46,16,6,47,17],[2,139,111,7,140,112],[17,74,46],[7,54,24,16,55,25],[34,37,13],[4,151,121,5,152,122],[4,75,47,14,76,48],[11,54,24,14,55,25],[16,45,15,14,46,16],[6,147,117,4,148,118],[6,73,45,14,74,46],[11,54,24,16,55,25],[30,46,16,2,47,17],[8,132,106,4,133,107],[8,75,47,13,76,48],[7,54,24,22,55,25],[22,45,15,13,46,16],[10,142,114,2,143,115],[19,74,46,4,75,47],[28,50,22,6,51,23],[33,46,16,4,47,17],[8,152,122,4,153,123],[22,73,45,3,74,46],[8,53,23,26,54,24],[12,45,15,28,46,16],[3,147,117,10,148,118],[3,73,45,23,74,46],[4,54,24,31,55,25],[11,45,15,31,46,16],[7,146,116,7,147,117],[21,73,45,7,74,46],[1,53,23,37,54,24],[19,45,15,26,46,16],[5,145,115,10,146,116],[19,75,47,10,76,48],[15,54,24,25,55,25],[23,45,15,25,46,16],[13,145,115,3,146,116],[2,74,46,29,75,47],[42,54,24,1,55,25],[23,45,15,28,46,16],[17,145,115],[10,74,46,23,75,47],[10,54,24,35,55,25],[19,45,15,35,46,16],[17,145,115,1,146,116],[14,74,46,21,75,47],[29,54,24,19,55,25],[11,45,15,46,46,16],[13,145,115,6,146,116],[14,74,46,23,75,47],[44,54,24,7,55,25],[59,46,16,1,47,17],[12,151,121,7,152,122],[12,75,47,26,76,48],[39,54,24,14,55,25],[22,45,15,41,46,16],[6,151,121,14,152,122],[6,75,47,34,76,48],[46,54,24,10,55,25],[2,45,15,64,46,16],[17,152,122,4,153,123],[29,74,46,14,75,47],[49,54,24,10,55,25],[24,45,15,46,46,16],[4,152,122,18,153,123],[13,74,46,32,75,47],[48,54,24,14,55,25],[42,45,15,32,46,16],[20,147,117,4,148,118],[40,75,47,7,76,48],[43,54,24,22,55,25],[10,45,15,67,46,16],[19,148,118,6,149,119],[18,75,47,31,76,48],[34,54,24,34,55,25],[20,45,15,61,46,16]];var q=function(u,v){var w={};w.totalCount=u;w.dataCount=v;return w};var t={};var s=function(v,u){switch(u){case j.L:return r[(v-1)*4+0];case j.M:return r[(v-1)*4+1];case j.Q:return r[(v-1)*4+2];case j.H:return r[(v-1)*4+3];default:return undefined}};t.getRSBlocks=function(w,C){var v=s(w,C);if(typeof v=="undefined"){throw new Error("bad rs block @ typeNumber:"+w+"/errorCorrectLevel:"+C)}var u=v.length/3;var A=new Array();for(var y=0;y<u;y+=1){var z=v[y*3+0];var D=v[y*3+1];var B=v[y*3+2];for(var x=0;x<z;x+=1){A.push(q(D,B))}}return A};return t}();var f=function(){var q=new Array();var s=0;var r={};r.getBuffer=function(){return q};r.get=function(t){var u=Math.floor(t/8);return((q[u]>>>(7-t%8))&1)==1};r.put=function(t,v){for(var u=0;u<v;u+=1){r.putBit(((t>>>(v-u-1))&1)==1)}};r.getLengthInBits=function(){return s};r.putBit=function(u){var t=Math.floor(s/8);if(q.length<=t){q.push(0)}if(u){q[t]|=(128>>>(s%8))}s+=1};return r};var n=function(t){var s=k.MODE_8BIT_BYTE;var q=t;var r=o.stringToBytes(t);var u={};u.getMode=function(){return s};u.getLength=function(v){return r.length};u.write=function(v){for(var w=0;w<r.length;w+=1){v.put(r[w],8)}};return u};var l=function(){var q=new Array();var r={};r.writeByte=function(s){q.push(s&255)};r.writeShort=function(s){r.writeByte(s);r.writeByte(s>>>8)};r.writeBytes=function(t,v,s){v=v||0;s=s||t.length;for(var u=0;u<s;u+=1){r.writeByte(t[u+v])}};r.writeString=function(u){for(var t=0;t<u.length;t+=1){r.writeByte(u.charCodeAt(t))}};r.toByteArray=function(){return q};r.toString=function(){var u="";u+="[";for(var t=0;t<q.length;t+=1){if(t>0){u+=","}u+=q[t]}u+="]";return u};return r};var b=function(){var r=0;var u=0;var w=0;var q="";var v={};var t=function(x){q+=String.fromCharCode(s(x&63))};var s=function(x){if(x<0){}else{if(x<26){return 65+x}else{if(x<52){return 97+(x-26)}else{if(x<62){return 48+(x-52)}else{if(x==62){return 43}else{if(x==63){return 47}}}}}}throw new Error("n:"+x)};v.writeByte=function(x){r=(r<<8)|(x&255);u+=8;w+=1;while(u>=6){t(r>>>(u-6));u-=6}};v.flush=function(){if(u>0){t(r<<(6-u));r=0;u=0}if(w%3!=0){var y=3-w%3;for(var x=0;x<y;x+=1){q+="="}}};v.toString=function(){return q};return v};var a=function(u){var w=u;var q=0;var r=0;var s=0;var v={};v.read=function(){while(s<8){if(q>=w.length){if(s==0){return -1}throw new Error("unexpected end of file./"+s)}var y=w.charAt(q);q+=1;if(y=="="){s=0;return -1}else{if(y.match(/^\s$/)){continue}}r=(r<<6)|t(y.charCodeAt(0));s+=6}var x=(r>>>(s-8))&255;s-=8;return x};var t=function(x){if(65<=x&&x<=90){return x-65}else{if(97<=x&&x<=122){return x-97+26}else{if(48<=x&&x<=57){return x-48+52}else{if(x==43){return 62}else{if(x==47){return 63}else{throw new Error("c:"+x)}}}}}};return v};var m=function(q,x){var t=q;var u=x;var r=new Array(q*x);var v={};v.setPixel=function(z,B,A){r[B*t+z]=A};v.write=function(A){A.writeString("GIF87a");A.writeShort(t);A.writeShort(u);A.writeByte(128);A.writeByte(0);A.writeByte(0);A.writeByte(0);A.writeByte(0);A.writeByte(0);A.writeByte(255);A.writeByte(255);A.writeByte(255);A.writeString(",");A.writeShort(0);A.writeShort(0);A.writeShort(t);A.writeShort(u);A.writeByte(0);var B=2;var z=s(B);A.writeByte(B);var C=0;while(z.length-C>255){A.writeByte(255);A.writeBytes(z,C,255);C+=255}A.writeByte(z.length-C);A.writeBytes(z,C,z.length-C);A.writeByte(0);A.writeString(";")};var w=function(A){var B=A;var C=0;var z=0;var D={};D.write=function(F,E){if((F>>>E)!=0){throw new Error("length over")}while(C+E>=8){B.writeByte(255&((F<<C)|z));E-=(8-C);F>>>=(8-C);z=0;C=0}z=(F<<C)|z;C=C+E};D.flush=function(){if(C>0){B.writeByte(z)}};return D};var s=function(A){var E=1<<A;var C=(1<<A)+1;var G=A+1;var I=y();for(var D=0;D<E;D+=1){I.add(String.fromCharCode(D))}I.add(String.fromCharCode(E));I.add(String.fromCharCode(C));var B=l();var z=w(B);z.write(E,G);var H=0;var J=String.fromCharCode(r[H]);H+=1;while(H<r.length){var F=String.fromCharCode(r[H]);H+=1;if(I.contains(J+F)){J=J+F}else{z.write(I.indexOf(J),G);if(I.size()<4095){if(I.size()==(1<<G)){G+=1}I.add(J+F)}J=F}}z.write(I.indexOf(J),G);z.write(C,G);z.flush();return B.toByteArray()};var y=function(){var A={};var z=0;var B={};B.add=function(C){if(B.contains(C)){throw new Error("dup key:"+C)}A[C]=z;z+=1};B.size=function(){return z};B.indexOf=function(C){return A[C]};B.contains=function(C){return typeof A[C]!="undefined"};return B};return v};var d=function(q,y,w,u){var t=m(q,y);var x=l();t.write(x);var v=b();var z=x.toByteArray();for(var s=0;s<z.length;s+=1){v.writeByte(z[s])}v.flush();var r="";r+="<img";r+='\u0020src="';r+="data:image/gif;base64,";r+=v;r+='"';r+='\u0020width="';r+=q;r+='"';r+='\u0020height="';r+=y;r+='"';if(u){r+='\u0020alt="';r+=u;r+='"'}r+="/>";return r};return o}();