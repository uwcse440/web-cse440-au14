var idbModules={};(function(b){function e(h,f,j,i){j.target=f;(typeof f[h]==="function")&&f[h].apply(f,[j]);(typeof i==="function")&&i()}function d(h,i,f){var j=new DOMException.constructor(0,i);j.name=h;j.message=i;j.stack=arguments.callee.caller;b.DEBUG&&console.log(h,i,f,j);throw j}var c=function(){this.length=0;this._items=[];if(Object.defineProperty){Object.defineProperty(this,"_items",{enumerable:false})}};c.prototype={contains:function(f){return -1!==this._items.indexOf(f)},item:function(f){return this._items[f]},indexOf:function(f){return this._items.indexOf(f)},push:function(h){this._items.push(h);this.length+=1;for(var f=0;f<this._items.length;f++){this[f]=this._items[f]}},splice:function(){this._items.splice.apply(this._items,arguments);this.length=this._items.length;for(var f in this){if(f===String(parseInt(f,10))){delete this[f]}}for(f=0;f<this._items.length;f++){this[f]=this._items[f]}}};if(Object.defineProperty){for(var a in {"indexOf":false,"push":false,"splice":false}){Object.defineProperty(c.prototype,a,{enumerable:false})}}b.util={"throwDOMException":d,"callback":e,"quote":function(f){return"'"+f+"'"},"StringList":c}}(idbModules));(function(a){var b=(function(){return{"encode":function(c){return JSON.stringify(c)},"decode":function(c){return JSON.parse(c)}}}());a.Sca=b}(idbModules));(function(c){var e=["","number","string","boolean","object","undefined"];var d=function(){return{"encode":function(f){return e.indexOf(typeof f)+"-"+JSON.stringify(f)},"decode":function(f){if(typeof f==="undefined"){return undefined}else{return JSON.parse(f.substring(2))}}}};var b={"number":d("number"),"boolean":d(),"object":d(),"string":{"encode":function(f){return e.indexOf("string")+"-"+f},"decode":function(f){return""+f.substring(2)}},"undefined":{"encode":function(f){return e.indexOf("undefined")+"-undefined"},"decode":function(f){return undefined}}};var a=(function(){return{encode:function(f){return b[typeof f].encode(f)},decode:function(f){return b[e[f.substring(0,1)]].decode(f)}}}());c.Key=a}(idbModules));(function(b,c){var a=function(e,d){return{"type":e,debug:d,bubbles:false,cancelable:false,eventPhase:0,timeStamp:new Date()}};b.Event=a}(idbModules));(function(b){var a=function(){this.onsuccess=this.onerror=this.result=this.error=this.source=this.transaction=null;this.readyState="pending"};var c=function(){this.onblocked=this.onupgradeneeded=null};c.prototype=a;b.IDBRequest=a;b.IDBOpenRequest=c}(idbModules));(function(b,c){var a=function(e,f,d,h){this.lower=e;this.upper=f;this.lowerOpen=d;this.upperOpen=h};a.only=function(d){return new a(d,d,true,true)};a.lowerBound=function(e,d){return new a(e,c,d,c)};a.upperBound=function(d){return new a(c,d,c,open)};a.bound=function(e,f,d,h){return new a(e,f,d,h)};b.IDBKeyRange=a}(idbModules));(function(a,c){function b(d,i,e,j,h,f){this.__range=d;this.source=this.__idbObjectStore=e;this.__req=j;this.key=c;this.direction=i;this.__keyColumnName=h;this.__valueColumnName=f;if(!this.source.transaction.__active){a.util.throwDOMException("TransactionInactiveError - The transaction this IDBObjectStore belongs to is not active.")}this.__offset=-1;this.__lastKeyContinued=c;this["continue"]()}b.prototype.__find=function(f,d,k,e){var h=this;var j=["SELECT * FROM ",a.util.quote(h.__idbObjectStore.name)];var i=[];j.push("WHERE ",h.__keyColumnName," NOT NULL");if(h.__range&&(h.__range.lower||h.__range.upper)){j.push("AND");if(h.__range.lower){j.push(h.__keyColumnName+(h.__range.lowerOpen?" >":" >= ")+" ?");i.push(a.Key.encode(h.__range.lower))}(h.__range.lower&&h.__range.upper)&&j.push("AND");if(h.__range.upper){j.push(h.__keyColumnName+(h.__range.upperOpen?" < ":" <= ")+" ?");i.push(a.Key.encode(h.__range.upper))}}if(typeof f!=="undefined"){h.__lastKeyContinued=f;h.__offset=0}if(h.__lastKeyContinued!==c){j.push("AND "+h.__keyColumnName+" >= ?");i.push(a.Key.encode(h.__lastKeyContinued))}j.push("ORDER BY ",h.__keyColumnName);j.push("LIMIT 1 OFFSET "+h.__offset);a.DEBUG&&console.log(j.join(" "),i);d.executeSql(j.join(" "),i,function(l,n){if(n.rows.length===1){var m=a.Key.decode(n.rows.item(0)[h.__keyColumnName]);var o=h.__valueColumnName==="value"?a.Sca.decode(n.rows.item(0)[h.__valueColumnName]):a.Key.decode(n.rows.item(0)[h.__valueColumnName]);k(m,o)}else{a.DEBUG&&console.log("Reached end of cursors");k(c,c)}},function(l,m){a.DEBUG&&console.log("Could not execute Cursor.continue");e(m)})};b.prototype["continue"]=function(d){var e=this;this.__idbObjectStore.transaction.__addToTransactionQueue(function(f,i,j,h){e.__offset++;e.__find(d,f,function(k,l){e.key=k;e.value=l;j(typeof e.key!=="undefined"?e:c,e.__req)},function(k){h(k)})})};b.prototype.advance=function(e){if(e<=0){a.util.throwDOMException("Type Error - Count is invalid - 0 or negative",e)}var d=this;this.__idbObjectStore.transaction.__addToTransactionQueue(function(f,i,j,h){d.__offset+=e;d.__find(c,f,function(k,l){d.key=k;d.value=l;j(typeof d.key!=="undefined"?d:c,d.__req)},function(k){h(k)})})};b.prototype.update=function(e){var d=this;return this.__idbObjectStore.transaction.__addToTransactionQueue(function(f,i,j,h){d.__find(c,f,function(k,l){var m="UPDATE "+a.util.quote(d.__idbObjectStore.name)+" SET value = ? WHERE key = ?";a.DEBUG&&console.log(m,e,k);f.executeSql(m,[a.Sca.encode(e),a.Key.encode(k)],function(n,o){if(o.rowsAffected===1){j(k)}else{h("No rowns with key found"+k)}},function(n,o){h(o)})},function(k){h(k)})})};b.prototype["delete"]=function(){var d=this;return this.__idbObjectStore.transaction.__addToTransactionQueue(function(e,h,i,f){d.__find(c,e,function(j,k){var l="DELETE FROM  "+a.util.quote(d.__idbObjectStore.name)+" WHERE key = ?";a.DEBUG&&console.log(l,j);e.executeSql(l,[a.Key.encode(j)],function(m,n){if(n.rowsAffected===1){i(c)}else{f("No rowns with key found"+j)}},function(m,n){f(n)})},function(j){f(j)})})};a.IDBCursor=b}(idbModules));(function(idbModules,undefined){function IDBIndex(indexName,idbObjectStore){this.indexName=this.name=indexName;this.__idbObjectStore=this.objectStore=this.source=idbObjectStore;var indexList=idbObjectStore.__storeProps&&idbObjectStore.__storeProps.indexList;indexList&&(indexList=JSON.parse(indexList));this.keyPath=((indexList&&indexList[indexName]&&indexList[indexName].keyPath)||indexName);["multiEntry","unique"].forEach(function(prop){this[prop]=!!indexList&&!!indexList[indexName]&&!!indexList[indexName].optionalParams&&!!indexList[indexName].optionalParams[prop]},this)}IDBIndex.prototype.__createIndex=function(indexName,keyPath,optionalParameters){var me=this;var transaction=me.__idbObjectStore.transaction;transaction.__addToTransactionQueue(function(tx,args,success,failure){me.__idbObjectStore.__getStoreProps(tx,function(){function error(){idbModules.util.throwDOMException(0,"Could not create new index",arguments)}if(transaction.mode!==2){idbModules.util.throwDOMException(0,"Invalid State error, not a version transaction",me.transaction)}var idxList=JSON.parse(me.__idbObjectStore.__storeProps.indexList);if(typeof idxList[indexName]!=="undefined"){idbModules.util.throwDOMException(0,"Index already exists on store",idxList)}var columnName=indexName;idxList[indexName]={"columnName":columnName,"keyPath":keyPath,"optionalParams":optionalParameters};me.__idbObjectStore.__storeProps.indexList=JSON.stringify(idxList);var sql=["ALTER TABLE",idbModules.util.quote(me.__idbObjectStore.name),"ADD",columnName,"BLOB"].join(" ");idbModules.DEBUG&&console.log(sql);tx.executeSql(sql,[],function(tx,data){tx.executeSql("SELECT * FROM "+idbModules.util.quote(me.__idbObjectStore.name),[],function(tx,data){(function initIndexForRow(i){if(i<data.rows.length){try{var value=idbModules.Sca.decode(data.rows.item(i).value);var indexKey=eval("value['"+keyPath+"']");tx.executeSql("UPDATE "+idbModules.util.quote(me.__idbObjectStore.name)+" set "+columnName+" = ? where key = ?",[idbModules.Key.encode(indexKey),data.rows.item(i).key],function(tx,data){initIndexForRow(i+1)},error)}catch(e){initIndexForRow(i+1)}}else{idbModules.DEBUG&&console.log("Updating the indexes in table",me.__idbObjectStore.__storeProps);tx.executeSql("UPDATE __sys__ set indexList = ? where name = ?",[me.__idbObjectStore.__storeProps.indexList,me.__idbObjectStore.name],function(){me.__idbObjectStore.__setReadyState("createIndex",true);success(me)},error)}}(0))},error)},error)},"createObjectStore")})};IDBIndex.prototype.openCursor=function(range,direction){var cursorRequest=new idbModules.IDBRequest();var cursor=new idbModules.IDBCursor(range,direction,this.source,cursorRequest,this.indexName,"value");return cursorRequest};IDBIndex.prototype.openKeyCursor=function(range,direction){var cursorRequest=new idbModules.IDBRequest();var cursor=new idbModules.IDBCursor(range,direction,this.source,cursorRequest,this.indexName,"key");return cursorRequest};IDBIndex.prototype.__fetchIndexData=function(key,opType){var me=this;return me.__idbObjectStore.transaction.__addToTransactionQueue(function(tx,args,success,error){var sql=["SELECT * FROM ",idbModules.util.quote(me.__idbObjectStore.name)," WHERE",me.indexName,"NOT NULL"];var sqlValues=[];if(typeof key!=="undefined"){sql.push("AND",me.indexName," = ?");sqlValues.push(idbModules.Key.encode(key))}idbModules.DEBUG&&console.log("Trying to fetch data for Index",sql.join(" "),sqlValues);tx.executeSql(sql.join(" "),sqlValues,function(tx,data){var d;if(typeof opType==="count"){d=data.rows.length}else{if(data.rows.length===0){d=undefined}else{if(opType==="key"){d=idbModules.Key.decode(data.rows.item(0).key)}else{d=idbModules.Sca.decode(data.rows.item(0).value)}}}success(d)},error)})};IDBIndex.prototype.get=function(key){return this.__fetchIndexData(key,"value")};IDBIndex.prototype.getKey=function(key){return this.__fetchIndexData(key,"key")};IDBIndex.prototype.count=function(key){return this.__fetchIndexData(key,"count")};idbModules.IDBIndex=IDBIndex}(idbModules));(function(idbModules){var IDBObjectStore=function(name,idbTransaction,ready){this.name=name;this.transaction=idbTransaction;this.__ready={};this.__setReadyState("createObjectStore",typeof ready==="undefined"?true:ready);this.indexNames=new idbModules.util.StringList()};IDBObjectStore.prototype.__setReadyState=function(key,val){this.__ready[key]=val};IDBObjectStore.prototype.__waitForReady=function(callback,key){var ready=true;if(typeof key!=="undefined"){ready=(typeof this.__ready[key]==="undefined")?true:this.__ready[key]}else{for(var x in this.__ready){if(!this.__ready[x]){ready=false}}}if(ready){callback()}else{idbModules.DEBUG&&console.log("Waiting for to be ready",key);var me=this;window.setTimeout(function(){me.__waitForReady(callback,key)},100)}};IDBObjectStore.prototype.__getStoreProps=function(tx,callback,waitOnProperty){var me=this;this.__waitForReady(function(){if(me.__storeProps){idbModules.DEBUG&&console.log("Store properties - cached",me.__storeProps);callback(me.__storeProps)}else{tx.executeSql("SELECT * FROM __sys__ where name = ?",[me.name],function(tx,data){if(data.rows.length!==1){callback()}else{me.__storeProps={"name":data.rows.item(0).name,"indexList":data.rows.item(0).indexList,"autoInc":data.rows.item(0).autoInc,"keyPath":data.rows.item(0).keyPath};idbModules.DEBUG&&console.log("Store properties",me.__storeProps);callback(me.__storeProps)}},function(){callback()})}},waitOnProperty)};IDBObjectStore.prototype.__deriveKey=function(tx,value,key,callback){function getNextAutoIncKey(){tx.executeSql("SELECT * FROM sqlite_sequence where name like ?",[me.name],function(tx,data){if(data.rows.length!==1){callback(0)}else{callback(data.rows.item(0).seq)}},function(tx,error){idbModules.util.throwDOMException(0,"Data Error - Could not get the auto increment value for key",error)})}var me=this;me.__getStoreProps(tx,function(props){if(!props){idbModules.util.throwDOMException(0,"Data Error - Could not locate defination for this table",props)}if(props.keyPath){if(typeof key!=="undefined"){idbModules.util.throwDOMException(0,"Data Error - The object store uses in-line keys and the key parameter was provided",props)}if(value){try{var primaryKey=eval("value['"+props.keyPath+"']");if(!primaryKey){if(props.autoInc==="true"){getNextAutoIncKey()}else{idbModules.util.throwDOMException(0,"Data Error - Could not eval key from keyPath")}}else{callback(primaryKey)}}catch(e){idbModules.util.throwDOMException(0,"Data Error - Could not eval key from keyPath",e)}}else{idbModules.util.throwDOMException(0,"Data Error - KeyPath was specified, but value was not")}}else{if(typeof key!=="undefined"){callback(key)}else{if(props.autoInc==="false"){idbModules.util.throwDOMException(0,"Data Error - The object store uses out-of-line keys and has no key generator and the key parameter was not provided. ",props)}else{getNextAutoIncKey()}}}})};IDBObjectStore.prototype.__insertData=function(tx,value,primaryKey,success,error){var paramMap={};if(typeof primaryKey!=="undefined"){paramMap.key=idbModules.Key.encode(primaryKey)}var indexes=JSON.parse(this.__storeProps.indexList);for(var key in indexes){try{paramMap[indexes[key].columnName]=idbModules.Key.encode(eval("value['"+indexes[key].keyPath+"']"))}catch(e){error(e)}}var sqlStart=["INSERT INTO ",idbModules.util.quote(this.name),"("];var sqlEnd=[" VALUES ("];var sqlValues=[];for(key in paramMap){sqlStart.push(key+",");sqlEnd.push("?,");sqlValues.push(paramMap[key])}sqlStart.push("value )");sqlEnd.push("?)");sqlValues.push(idbModules.Sca.encode(value));var sql=sqlStart.join(" ")+sqlEnd.join(" ");idbModules.DEBUG&&console.log("SQL for adding",sql,sqlValues);tx.executeSql(sql,sqlValues,function(tx,data){success(primaryKey)},function(tx,err){error(err)})};IDBObjectStore.prototype.add=function(value,key){var me=this;return me.transaction.__addToTransactionQueue(function(tx,args,success,error){me.__deriveKey(tx,value,key,function(primaryKey){me.__insertData(tx,value,primaryKey,success,error)})})};IDBObjectStore.prototype.put=function(value,key){var me=this;return me.transaction.__addToTransactionQueue(function(tx,args,success,error){me.__deriveKey(tx,value,key,function(primaryKey){var sql="DELETE FROM "+idbModules.util.quote(me.name)+" where key = ?";tx.executeSql(sql,[idbModules.Key.encode(primaryKey)],function(tx,data){idbModules.DEBUG&&console.log("Did the row with the",primaryKey,"exist? ",data.rowsAffected);me.__insertData(tx,value,primaryKey,success,error)},function(tx,err){error(err)})})})};IDBObjectStore.prototype.get=function(key){var me=this;return me.transaction.__addToTransactionQueue(function(tx,args,success,error){me.__waitForReady(function(){var primaryKey=idbModules.Key.encode(key);idbModules.DEBUG&&console.log("Fetching",me.name,primaryKey);tx.executeSql("SELECT * FROM "+idbModules.util.quote(me.name)+" where key = ?",[primaryKey],function(tx,data){idbModules.DEBUG&&console.log("Fetched data",data);try{if(0===data.rows.length){return success()}success(idbModules.Sca.decode(data.rows.item(0).value))}catch(e){idbModules.DEBUG&&console.log(e);success(undefined)}},function(tx,err){error(err)})})})};IDBObjectStore.prototype["delete"]=function(key){var me=this;return me.transaction.__addToTransactionQueue(function(tx,args,success,error){me.__waitForReady(function(){var primaryKey=idbModules.Key.encode(key);idbModules.DEBUG&&console.log("Fetching",me.name,primaryKey);tx.executeSql("DELETE FROM "+idbModules.util.quote(me.name)+" where key = ?",[primaryKey],function(tx,data){idbModules.DEBUG&&console.log("Deleted from database",data.rowsAffected);success()},function(tx,err){error(err)})})})};IDBObjectStore.prototype.clear=function(){var me=this;return me.transaction.__addToTransactionQueue(function(tx,args,success,error){me.__waitForReady(function(){tx.executeSql("DELETE FROM "+idbModules.util.quote(me.name),[],function(tx,data){idbModules.DEBUG&&console.log("Cleared all records from database",data.rowsAffected);success()},function(tx,err){error(err)})})})};IDBObjectStore.prototype.count=function(key){var me=this;return me.transaction.__addToTransactionQueue(function(tx,args,success,error){me.__waitForReady(function(){var sql="SELECT * FROM "+idbModules.util.quote(me.name)+((typeof key!=="undefined")?" WHERE key = ?":"");var sqlValues=[];(typeof key!=="undefined")&&sqlValues.push(idbModules.Key.encode(key));tx.executeSql(sql,sqlValues,function(tx,data){success(data.rows.length)},function(tx,err){error(err)})})})};IDBObjectStore.prototype.openCursor=function(range,direction){var cursorRequest=new idbModules.IDBRequest();var cursor=new idbModules.IDBCursor(range,direction,this,cursorRequest,"key","value");return cursorRequest};IDBObjectStore.prototype.index=function(indexName){var index=new idbModules.IDBIndex(indexName,this);return index};IDBObjectStore.prototype.createIndex=function(indexName,keyPath,optionalParameters){var me=this;optionalParameters=optionalParameters||{};me.__setReadyState("createIndex",false);var result=new idbModules.IDBIndex(indexName,me);me.__waitForReady(function(){result.__createIndex(indexName,keyPath,optionalParameters)},"createObjectStore");me.indexNames.push(indexName);return result};IDBObjectStore.prototype.deleteIndex=function(indexName){var result=new idbModules.IDBIndex(indexName,this,false);result.__deleteIndex(indexName);return result};idbModules.IDBObjectStore=IDBObjectStore}(idbModules));(function(c){var b=0;var a=1;var e=2;var d=function(f,l,h){if(typeof l==="number"){this.mode=l;(l!==2)&&c.DEBUG&&console.log("Mode should be a string, but was specified as ",l)}else{if(typeof l==="string"){switch(l){case"readwrite":this.mode=a;break;case"readonly":this.mode=b;break;default:this.mode=b;break}}}this.storeNames=typeof f==="string"?[f]:f;for(var j=0;j<this.storeNames.length;j++){if(!h.objectStoreNames.contains(this.storeNames[j])){c.util.throwDOMException(0,"The operation failed because the requested database object could not be found. For example, an object store did not exist but was being opened.",this.storeNames[j])}}this.__active=true;this.__running=false;this.__requests=[];this.__aborted=false;this.db=h;this.error=null;this.onabort=this.onerror=this.oncomplete=null;var k=this};d.prototype.__executeRequests=function(){if(this.__running&&this.mode!==e){c.DEBUG&&console.log("Looks like the request set is already running",this.mode);return}this.__running=true;var f=this;window.setTimeout(function(){if(f.mode!==2&&!f.__active){c.util.throwDOMException(0,"A request was placed against a transaction which is currently not active, or which is finished",f.__active)}f.db.__db.transaction(function(j){f.__tx=j;var m=null,l=0;function o(i,p){if(p){m.req=p}m.req.readyState="done";m.req.result=i;delete m.req.error;var q=c.Event("success");c.util.callback("onsuccess",m.req,q);l++;h()}function k(i){m.req.readyState="done";m.req.error="DOMError";var p=c.Event("error",arguments);c.util.callback("onerror",m.req,p);l++;h()}try{function h(){if(l>=f.__requests.length){f.__active=false;f.__requests=[];return}m=f.__requests[l];m.op(j,m.args,o,k)}h()}catch(n){c.DEBUG&&console.log("An exception occured in transaction",arguments);typeof f.onerror==="function"&&f.onerror()}},function(){c.DEBUG&&console.log("An error in transaction",arguments);typeof f.onerror==="function"&&f.onerror()},function(){c.DEBUG&&console.log("Transaction completed",arguments);typeof f.oncomplete==="function"&&f.oncomplete()})},1)};d.prototype.__addToTransactionQueue=function(i,f){if(!this.__active&&this.mode!==e){c.util.throwDOMException(0,"A request was placed against a transaction which is currently not active, or which is finished.",this.__mode)}var h=new c.IDBRequest();h.source=this.db;this.__requests.push({"op":i,"args":f,"req":h});this.__executeRequests();return h};d.prototype.objectStore=function(f){return new c.IDBObjectStore(f,this)};d.prototype.abort=function(){!this.__active&&c.util.throwDOMException(0,"A request was placed against a transaction which is currently not active, or which is finished",this.__active)};d.prototype.READ_ONLY=0;d.prototype.READ_WRITE=1;d.prototype.VERSION_CHANGE=2;c.IDBTransaction=d}(idbModules));(function(a){var b=function(d,e,c,h){this.__db=d;this.version=c;this.__storeProperties=h;this.objectStoreNames=new a.util.StringList();for(var f=0;f<h.rows.length;f++){this.objectStoreNames.push(h.rows.item(f).name)}this.name=e;this.onabort=this.onerror=this.onversionchange=null};b.prototype.createObjectStore=function(d,e){var f=this;e=e||{};e.keyPath=e.keyPath||null;var c=new a.IDBObjectStore(d,f.__versionTransaction,false);var h=f.__versionTransaction;h.__addToTransactionQueue(function(i,l,n,k){function j(){a.util.throwDOMException(0,"Could not create new object store",arguments)}if(!f.__versionTransaction){a.util.throwDOMException(0,"Invalid State error",f.transaction)}var m=["CREATE TABLE",a.util.quote(d),"(key BLOB",e.autoIncrement?", inc INTEGER PRIMARY KEY AUTOINCREMENT":"PRIMARY KEY",", value BLOB)"].join(" ");a.DEBUG&&console.log(m);i.executeSql(m,[],function(o,p){o.executeSql("INSERT INTO __sys__ VALUES (?,?,?,?)",[d,e.keyPath,e.autoIncrement?true:false,"{}"],function(){c.__setReadyState("createObjectStore",true);n(c)},j)},j)});f.objectStoreNames.push(d);return c};b.prototype.deleteObjectStore=function(d){var c=function(){a.util.throwDOMException(0,"Could not delete ObjectStore",arguments)};var e=this;!e.objectStoreNames.contains(d)&&c("Object Store does not exist");e.objectStoreNames.splice(e.objectStoreNames.indexOf(d),1);var f=e.__versionTransaction;f.__addToTransactionQueue(function(h,j,k,i){if(!e.__versionTransaction){a.util.throwDOMException(0,"Invalid State error",e.transaction)}e.__db.transaction(function(l){l.executeSql("SELECT * FROM __sys__ where name = ?",[d],function(m,n){if(n.rows.length>0){m.executeSql("DROP TABLE "+a.util.quote(d),[],function(){m.executeSql("DELETE FROM __sys__ WHERE name = ?",[d],function(){},c)},c)}})})})};b.prototype.close=function(){};b.prototype.transaction=function(c,e){var d=new a.IDBTransaction(c,e||1,this);return d};a.IDBDatabase=b}(idbModules));(function(d){var b=4*1024*1024;if(!window.openDatabase){return}var a=window.openDatabase("__sysdb__",1,"System Database",b);a.transaction(function(e){e.executeSql("SELECT * FROM dbVersions",[],function(f,h){},function(){a.transaction(function(f){f.executeSql("CREATE TABLE IF NOT EXISTS dbVersions (name VARCHAR(255), version INT);",[],function(){},function(){d.util.throwDOMException("Could not create table __sysdb__ to save DB versions")})})})},function(){d.DEBUG&&console.log("Error in sysdb transaction - when selecting from dbVersions",arguments)});var c={open:function(f,e){var j=new d.IDBOpenRequest();var h=false;function i(){if(h){return}var l=d.Event("error",arguments);j.readyState="done";j.error="DOMError";d.util.callback("onerror",j,l);h=true}function k(l){var m=window.openDatabase(f,1,f,b);j.readyState="done";if(typeof e==="undefined"){e=l||1}if(e<=0||l>e){d.util.throwDOMException(0,"An attempt was made to open a database using a lower version than the existing version.",e)}m.transaction(function(n){n.executeSql("CREATE TABLE IF NOT EXISTS __sys__ (name VARCHAR(255), keyPath VARCHAR(255), autoInc BOOLEAN, indexList BLOB)",[],function(){n.executeSql("SELECT * FROM __sys__",[],function(o,p){var q=d.Event("success");j.source=j.result=new d.IDBDatabase(m,f,e,p);if(l<e){a.transaction(function(r){r.executeSql("UPDATE dbVersions set version = ? where name = ?",[e,f],function(){var s=d.Event("upgradeneeded");s.oldVersion=l;s.newVersion=e;j.transaction=j.result.__versionTransaction=new d.IDBTransaction([],2,j.source);d.util.callback("onupgradeneeded",j,s,function(){var t=d.Event("success");d.util.callback("onsuccess",j,t)})},i)},i)}else{d.util.callback("onsuccess",j,q)}},i)},i)},i)}a.transaction(function(l){l.executeSql("SELECT * FROM dbVersions where name = ?",[f],function(m,n){if(n.rows.length===0){m.executeSql("INSERT INTO dbVersions VALUES (?,?)",[f,e||1],function(){k(0)},i)}else{k(n.rows.item(0).version)}},i)},i);return j},"deleteDatabase":function(i){var j=new d.IDBOpenRequest();var h=false;function k(m){if(h){return}j.readyState="done";j.error="DOMError";var l=d.Event("error");l.message=m;l.debug=arguments;d.util.callback("onerror",j,l);h=true}var e=null;function f(){a.transaction(function(l){l.executeSql("DELETE FROM dbVersions where name = ? ",[i],function(){j.result=undefined;var m=d.Event("success");m.newVersion=null;m.oldVersion=e;d.util.callback("onsuccess",j,m)},k)},k)}a.transaction(function(l){l.executeSql("SELECT * FROM dbVersions where name = ?",[i],function(m,o){if(o.rows.length===0){j.result=undefined;var p=d.Event("success");p.newVersion=null;p.oldVersion=e;d.util.callback("onsuccess",j,p);return}e=o.rows.item(0).version;var n=window.openDatabase(i,1,i,b);n.transaction(function(q){q.executeSql("SELECT * FROM __sys__",[],function(r,t){var s=t.rows;(function u(v){if(v>=s.length){r.executeSql("DROP TABLE __sys__",[],function(){f()},k)}else{r.executeSql("DROP TABLE "+d.util.quote(s.item(v).name),[],function(){u(v+1)},function(){u(v+1)})}}(0))},function(r){f()})},k)})},k);return j},"cmp":function(f,e){return d.Key.encode(f)>d.Key.encode(e)?1:f===e?0:-1}};d.shimIndexedDB=c}(idbModules));(function(b,a){if(typeof b.openDatabase!=="undefined"){b.shimIndexedDB=a.shimIndexedDB;if(b.shimIndexedDB){b.shimIndexedDB.__useShim=function(){b.indexedDB=a.shimIndexedDB;b.IDBDatabase=a.IDBDatabase;b.IDBTransaction=a.IDBTransaction;b.IDBCursor=a.IDBCursor;b.IDBKeyRange=a.IDBKeyRange};b.shimIndexedDB.__debug=function(c){a.DEBUG=c}}}b.indexedDB=b.indexedDB||b.webkitIndexedDB||b.mozIndexedDB||b.oIndexedDB||b.msIndexedDB;if(typeof b.indexedDB==="undefined"&&typeof b.openDatabase!=="undefined"){b.shimIndexedDB.__useShim()}else{b.IDBDatabase=b.IDBDatabase||b.webkitIDBDatabase;b.IDBTransaction=b.IDBTransaction||b.webkitIDBTransaction;b.IDBCursor=b.IDBCursor||b.webkitIDBCursor;b.IDBKeyRange=b.IDBKeyRange||b.webkitIDBKeyRange;if(!b.IDBTransaction){b.IDBTransaction={}}b.IDBTransaction.READ_ONLY=b.IDBTransaction.READ_ONLY||"readonly";b.IDBTransaction.READ_WRITE=b.IDBTransaction.READ_WRITE||"readwrite"}}(window,idbModules));var dbStorage={dbAvailable:null,db:null,readyListeners:[],versionNumber:34,onReady:function(a){if(dbStorage.db||dbStorage.dbAvailable===false){a()}else{dbStorage.readyListeners.push(a)}},init:function(){var a;if(window.indexedDB){a=window.indexedDB.open("fluidDB",dbStorage.versionNumber)}else{a=window.shimIndexedDB.open("fluidDB",dbStorage.versionNumber)}a.onupgradeneeded=function(c){dbStorage.dbAvailable=true;if(!this.result.objectStoreNames.contains("rastPages")){var b=this.result.createObjectStore("rastPages",{keyPath:"id"});b.createIndex("by_id","id",{unique:true});b.createIndex("by_data","data");b.createIndex("by_project","project")}if(!this.result.objectStoreNames.contains("uploads")){b=this.result.createObjectStore("uploads",{keyPath:"id"});b.createIndex("by_id","id",{unique:true});b.createIndex("by_data","data")}if(!this.result.objectStoreNames.contains("projects")){b=this.result.createObjectStore("projects",{keyPath:"id"});b.createIndex("by_id","id",{unique:true});b.createIndex("by_data","data")}if(!this.result.objectStoreNames.contains("uiIcons")){b=this.result.createObjectStore("uiIcons",{keyPath:"id"});b.createIndex("by_id","id",{unique:true});b.createIndex("by_data","data")}if(!this.result.objectStoreNames.contains("uploadThumbs")){b=this.result.createObjectStore("uploadThumbs",{keyPath:"id"});b.createIndex("by_id","id",{unique:true});b.createIndex("by_data","data")}if(!this.result.objectStoreNames.contains("uploadHeaders")){b=this.result.createObjectStore("uploadHeaders",{keyPath:"id"});b.createIndex("by_id","id",{unique:true});b.createIndex("by_data","data")}if(!this.result.objectStoreNames.contains("wdgDefinitions")){b=this.result.createObjectStore("wdgDefinitions",{keyPath:"id"});b.createIndex("by_id","id",{unique:true});b.createIndex("by_data","data")}if(!this.result.objectStoreNames.contains("accounts")){b=this.result.createObjectStore("accounts",{keyPath:"id"});b.createIndex("by_id","id",{unique:true});b.createIndex("by_data","data")}if(c.oldVersion!==0){dbStorage.clearStores=true}};a.onsuccess=function(b){dbStorage.dbAvailable=true;dbStorage.db=this.result;if(localStorage.getItem("account.loginStarted")==="true"&&localStorage.getItem("account.loginEnded")===null){dbStorage.clearStores=true}if(dbStorage.clearStores){var c;for(var d=0;d<dbStorage.db.objectStoreNames.length;d++){c=dbStorage.getObjectStore(dbStorage.db.objectStoreNames[d],"readwrite");c.clear()}dbStorage.db.close();localStorage.clear();localStorage.setItem("indexedDBreloaded",true);localStorage.setItem("postloadMessage","updateLogout");setTimeout(function(){window.location.reload()},3000);return}for(var d=0;d<dbStorage.readyListeners.length;d++){dbStorage.readyListeners[d]()}localStorage.setItem("indexedDBreloaded",false)};a.onerror=function(b){dbStorage.dbAvailable=false;if(!localStorage.getItem("clearedIndexedDb")){setTimeout(function(){window.indexedDB.deleteDatabase("fluidDB");localStorage.clear();localStorage.setItem("clearedIndexedDb",true);window.location.reload()},2000)}else{localStorage.removeItem("clearedIndexedDb")}if(b.target.error.name&&localStorage.getItem("indexedDBreloaded")==="false"){setTimeout(function(){dbStorage.clear();localStorage.clear();localStorage.setItem("indexedDBreloaded",true);localStorage.setItem("postloadMessage","updateLogout");window.location.reload()},5000)}};a.onblocked=function(b){dbStorage.dbAvailable=false}},getObjectStore:function(a,c){var b=dbStorage.db.transaction(a,c);return b.objectStore(a)},clear:function(){window.indexedDB.deleteDatabase("fluidDB")},set:function(c,e,f){if(e.length===undefined){e=[e]}if(e.length===0||dbStorage.dbAvailable===false){console.log("not saved: ",e.length,dbStorage.dbAvailable);if(f){f()}return}var b=dbStorage.getObjectStore(c,"readwrite");for(var d=0;d<e.length;d++){var a=b.put(e[d]);a.onsuccess=function(){if(d===e.length&&f){f({success:true})}};a.onerror=function(){if(d===e.length&&f){f({success:false})}}}},remove:function(b,d,e){if(d.length===undefined){d=[d]}if(d.length===0||dbStorage.dbAvailable===false){if(e){e()}return}var a=dbStorage.getObjectStore(b,"readwrite");for(var c=0;c<d.length;c++){a["delete"](d[c]).onsuccess=function(f,i,h){if(f===i.length-1&&h){h()}}.bind(this,c,d,e)}},list:function(a,e){var c=dbStorage.db.transaction(a);var d=c.objectStore(a);var b=[];d.openCursor().onsuccess=function(f){var h=f.target.result;if(h){b.push(h.key);h["continue"]()}else{if(e){e(b)}}}},get:function(a,e,j){var d={failed:[],fetched:[],resultsArr:[],resultsObj:{}};if(e.length===undefined||typeof(e)==="string"){e=[e]}if(e.length===0||dbStorage.dbAvailable===false){if(j){j(d)}return}var c=dbStorage.db.transaction(a);var h=c.objectStore(a);var f;for(var b=0;b<e.length;b++){f=h.get(e[b]);f.onsuccess=function(i,k){if(this.result){d.fetched.push(i);d.resultsObj[i]=this.result}else{d.failed.push(i);d.resultsObj[i]=null}d.resultsArr.push(d.resultsObj[i]);if(j&&d.resultsArr.length===e.length){j(d)}}.bind(f,e[b])}}};if(!Function.prototype.bind){Function.prototype.bind=function(a){if(typeof this!=="function"){throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable")}var e=Array.prototype.slice.call(arguments,1),d=this,b=function(){},c=function(){return d.apply(this instanceof b&&a?this:a,e.concat(Array.prototype.slice.call(arguments)))};b.prototype=this.prototype;c.prototype=new b();return c}}if(!window.fluid){window.fluid={}}fluid.wdgProvider=function(){var a=window.widgets?$.extend(true,{},widgets):null;return{getWidgets:function(d){var c=$.extend(true,{},a.summary);if(d){for(var b in c){if(c.hasOwnProperty(b)){c[b].originId=b}}}return c},getRootWidgets:function(e,d){var b=[];for(var c in a.summary){if(a.summary.hasOwnProperty(c)&&a.summary[c].g&&(e==undefined||a.summary[c].g.indexOf(e)!=-1)){b.push(a.summary[c]);if(d){b[b.length-1].originId=c}}}return b},getWdgGroups:function(){return $.extend(true,{},a.g)},getChildWidgets:function(b,e){var d=[];var f;var h;for(var c=0;c<b.ad.length;c++){f=b.ad[c][0];if(a&&a.summary[f]){h=$.extend(true,{},a.summary[f])}else{h=$.extend(true,{},widgets.summary[f])}if(e){h.originId=f}d.push(h)}return d},getById:function(b){if(a&&a.summary[b]){return $.extend(true,{},a.summary[b])}else{return $.extend({},widgets.summary[b])}},getChildById:function(d,c){parentChildren=c&&c.ad?c.ad:null;if(parentChildren&&parentChildren.length){for(var b=0;b<parentChildren.length;b++){if(d==parentChildren[b][0]){return parentChildren[b]}}}return false}}}();fluid.widget=function(){return{handleCollection:function(f,d,e){if(f.length==undefined){var a={};f=$.extend(true,{},f);e.unshift({});for(var c in f){if(f.hasOwnProperty(c)){e[0]=f[c];a[c]=d.apply(this,e)}}return a}else{var a=[];e.unshift({});for(var b=0;b<f.length;b++){e[0]=f[b];a.push(d.apply(this,e))}return a}},setSizeLimit:function(b,c,a){return this.handleCollection(b,function(e,f,d){if(!e.wh){e.wh=[f,d]}else{if(typeof e.wh[0]=="string"){e.wh[0]=f}if(typeof e.wh[1]=="string"){e.wh[1]=d}}return e},[c,a])},setRootSizeLimit:function(b,c,a){return this.handleCollection(b,function(e,f,d){if(!e.g){return e}if(!e.wh){e.wh=[f,d]}else{if(typeof e.wh[0]=="string"){e.wh[0]=f}if(typeof e.wh[1]=="string"){e.wh[1]=d}}return e},[c,a])},hasChildWidgets:function(a){return a.ad&&a.ad.length?true:false},hasSegments:function(a){return a.sc?true:false},isTextWidget:function(a){if(a.tc){return true}else{return false}},isShapeWidget:function(a){if(a.b||a.bg||a.bgc||a.bgd||a.i){return true}else{return false}},isUploadWidget:function(a){if(a.upload==="y"){return true}else{return false}}}}();fluid.wdgRenderer=function(a,b){this.canvasSize=[a||320,b||480];this.useCanvas=true;this.renderingQueue={};this.renditions={};this.imagesToLoad={};this.uploadsToLoad={};this.imagesLoaded={};this.canvases={};this.cropping={x:12004,y:9804,x2:0,y2:0};this.renderBlur=true;this.useOneCanvas=true;this.setCropping=function(c){if(c.x<this.cropping.x){this.cropping.x=c.x}if(c.y<this.cropping.y){this.cropping.y=c.y}if(c.x+c.width>this.cropping.x2){this.cropping.x2=c.x+c.width}if(c.y+c.height>this.cropping.y2){this.cropping.y2=c.y+c.height}};this.generateCanvas=function(d,c){this.canvas=$("<canvas>").attr({width:(c&&c.width!==undefined)?c.width:this.canvasSize[0],height:(c&&c.height!==undefined)?c.height:this.canvasSize[1]});if(d){this.canvas.attr({id:"pag-"+d})}this.canvases[d]=this.canvas;this.ctx=this.canvas.get(0).getContext("2d")};this.percentToPixel=function(e,f,c){var d;if(f.wh[0].indexOf&&f.wh[0].indexOf("%")!==-1){d=parseInt(f.wh[0],10)/100;d=d*c.box[2];e[2]=d}if(f.wh[1].indexOf&&f.wh[1].indexOf("%")!==-1){d=parseInt(f.wh[1],10)/100;d=d*c.box[3];e[3]=d}return e};this.getPixelDimensions=function(d,e,c){if(e.wh&&typeof e.wh[0]=="number"){d[2]=e.wh[0]}if(e.wh&&typeof e.wh[1]=="number"){d[3]=e.wh[1]}return d};this.parseBoxValue=function(e,d){if(typeof(e)==="number"&&!isNaN(e)){return e}else{var c=(parseFloat(e||0)/100)*(d||0);return isNaN(c)?0:c}};this.calculateBox=function(j,d,c){if(!d){d={box:[0,0,this.canvasSize[0],this.canvasSize[1]]}}var f=[0,0];var h;if(j.tlwh){f=[this.parseBoxValue(j.tlwh[1],d.box[2]),this.parseBoxValue(j.tlwh[0],d.box[3]),this.parseBoxValue(j.tlwh[2],d.box[2]),this.parseBoxValue(j.tlwh[3],d.box[3])];return f}if(!j.wh){f[2]=d.box[2];f[3]=d.box[3]}else{f=this.getPixelDimensions(f,j,d);f=this.percentToPixel(f,j,d)}if(c){if(!c[3]||c[3][1]=="l"){if(typeof c[1]=="number"){f[0]=c[1]}else{if(typeof c[1]=="string"){f[0]=(parseInt(c[1],10)/100)*d.box[2]}}}else{if(c[3][1]=="c"){var e;if(typeof c[1]=="number"){e=c[1]}else{e=(parseInt(c[1],10)/100)*d.box[2]}f[0]=(d.box[2]-f[2])/2+e}else{if(typeof c[1]=="number"){f[0]=d.box[2]-f[2]-c[1]}else{if(typeof c[1]=="string"){h=(parseInt(c[1],10)/100)*d.box[3];f[0]=d.box[2]-f[2]-h}}}}if(!c[3]||c[3][0]=="t"){if(typeof c[2]=="number"){f[1]=c[2]}else{if(typeof c[2]=="string"){f[1]=(parseInt(c[2],10)/100)*d.wh[1]}}}else{if(c[3][1]=="c"){var i;if(typeof c[2]=="number"){i=c[2]}else{i=(parseInt(c[2],10)/100)*d.box[3]}f[1]=(d.box[3]-f[3])/2+i}else{if(typeof c[2]=="number"){f[1]=d.box[3]-f[3]-c[2]}else{if(typeof c[2]=="string"){h=(parseInt(c[2],10)/100)*d.wh[1];f[1]=d.wh[1]-f[3]-h}}}}}f[0]=f[0]+d.box[0];f[1]=f[1]+d.box[1];return f};this.renderUpload=function(e,f,c){$canvas=f||this.canvas;function j(m,l){if(!e.box[2]||!e.box[3]){e.box[2]=l.width;e.box[3]=l.height}var k=m.get(0).getContext("2d");k.drawImage(l,e.box[0],e.box[1],e.box[2],e.box[3]);l.onload=null;l.onerror=null}function i(n,l,m){n.addClass("failureImage");var k=n.get(0).getContext("2d");k.font="32pt Arial";k.fillText("Image",35,50);k.fillText("not found",10,115)}function d(){i();widget._convertCanvasToImg($(ctx.canvas),widgEl.find("img"),tmplVars)}function h(){var k=e.data||false;if(k&&k.substr(0,5)!="data:"){k=ajax.apiObjectUrl("img",e.data)}else{if(e.id){k=ajax.apiObjectUrl("img",e.id)}}return k||i()}if(c){j($canvas,c);return this.canvas}fluid.upload.get({id:e.data||e.id,callback:function(m,k){if(k.success){if(k.image){j.call(this,m,k.image)}else{if(k.imgData){var l=new Image();l.onload=j.bind(this,m,l);l.onerror=i.bind(this,m,l);l.src=k.imgData}}}else{var l=new Image();i.call(this,m,l)}}.bind(this,$canvas),priority:fluid.upload.priority.pageZoomedOut})};this.adjustWords=function(d){var e=[];for(var c=0;c<d.length;c++){if(d[c]!==""){e.push(d[c])}else{if(browserDetect.browser==="Firefox"){e[e.length-1]+=" "}}}return e};this.wrapText=function(s,p,f,m,j,t){if(f[3]<0){return 0}var k=p.split(" ");var u="";var c="";var r=0;var i,q;var h;var o=" ";var l=f[1];if(isNaN(m)){m=13}k=this.adjustWords(k);if(p.match(/[\u3131-\uCB4C]/)){o="";k=p.split("")}for(var d=0;d<k.length;d++){i=u+k[d]+o;q=s.measureText(i).width;if(browserDetect.browser!=="Firefox"){q=q+Math.round(-0.285714286*parseFloat(t)+0.075)}if(q>f[2]&&k.length!==1){c=k[d]+o;if(browserDetect.browser!=="Firefox"&&k[d].indexOf("-")!==-1){var e=u+k[d].substring(0,k[d].indexOf("-")+1);if(s.measureText(e).width<=f[2]){u=e;c=k[d].substring(k[d].indexOf("-")+1)+o}}if(l+m*0.5>f[1]+f[3]){return r}h=s.measureText(u).width;if(browserDetect.browser!=="Firefox"){h=h+Math.round(-0.285714286*parseFloat(t)+0.075)}if(h>f[2]&&u.indexOf(" ")===u.length-1&&browserDetect.browser!=="Firefox"){c=o+c}if(j&&j[1]==="c"){s.fillText(u,f[0]+(f[2]/2)-(h/2),l)}else{if(j&&j[1]==="r"){s.fillText(u,f[0]+f[2]-h,l)}else{s.fillText(u,f[0],l)}}u=c;l+=m;r++}else{u=i}}if(l+m*0.5>f[1]+f[3]){return r}h=s.measureText(u).width;h=h+Math.round(-0.285714286*parseFloat(t)+0.075);if(j&&j[1]==="c"){s.fillText(u,f[0]+(f[2]/2)-(h/2),l)}else{if(j&&j[1]==="r"){s.fillText(u,f[0]+f[2]-h,l)}else{s.fillText(u,f[0],l)}}return r};this.renderText=function(m,l){var y=m.ts.replace(/"/g,"");if(!this.useOneCanvas){if(this.renderingMode==="singlepage"){return $('<div class="widgetText" style="'+y+';width: 100%;height:100%;">'+m.tc+"</div>")}else{return $('<div class="widgetText" style="'+y+";width:"+(m.box[2]+3)+"px;height:"+m.box[3]+"px; top:"+m.box[1]+"px; left:"+m.box[0]+'px;">'+m.tc+"</div>")}}else{var o=0;var u=m.tc.replace(/&nbsp/g," ");var f=u.split("\n");var e;var l=l||this.canvas;var r=l.get(0).getContext("2d");var p=y.match(/font:[a-zA-Z0-9\s:\/]*;/);var d=y.match(/[0-9]+px/);if(d){d=parseInt(d[0],10)}if(p){p=p[0];p=p.replace("font:","");p=p.replace(";","")}else{var h="normal";if(y.indexOf("font-style")!==-1){h=y.substring(y.indexOf("font-style")+11,y.indexOf(";",y.indexOf("font-style"))).trim()}var k="normal";if(y.indexOf("font-variant")!==-1){k=y.substring(y.indexOf("font-variant")+13,y.indexOf(";",y.indexOf("font-variant"))).trim()}var n="normal";if(y.indexOf("font-weight")!==-1){n=y.substring(y.indexOf("font-weight")+12,y.indexOf(";",y.indexOf("font-weight"))).trim()}d=y.substring(y.indexOf("font-size")+10,y.indexOf(";",y.indexOf("font-size"))).trim();var A=y.substring(y.indexOf("font-family")+12,y.indexOf(";",y.indexOf("font-family"))).trim();e=y.substring(y.indexOf("line-height")+12,y.indexOf(";",y.indexOf("line-height"))).trim();p=h+" "+k+" "+n+" "+d+" "+A}var v=y.substring(y.indexOf("color")+6,y.indexOf(";",y.indexOf("color"))).trim();if(v.indexOf("rgb(")!==-1){v=utils.rgb2hex(v)}var j=y.indexOf(";",y.indexOf("text-align"))!==-1?y.substring(y.indexOf("text-align")+11,y.indexOf(";",y.indexOf("text-align"))).trim():y.substring(y.indexOf("text-align")+11).trim();var t="";if(y.indexOf("text-decoration")!==-1){t=y.substring(y.indexOf("text-decoration")+16,y.indexOf(";",y.indexOf("text-decoration"))).trim()}var B=0;if(y.indexOf("padding-top")!==-1){o=y.indexOf(";",y.indexOf("padding-top"));if(o!==-1){B=parseInt(y.substring(y.indexOf("padding-top")+12,o).trim(),10)}else{B=parseInt(y.substring(y.indexOf("padding-top")+12).trim(),10)}}var c=0;if(y.indexOf("margin-top")!==-1){o=y.indexOf(";",y.indexOf("margin-top"));if(o!==-1){c=parseInt(y.substring(y.indexOf("margin-top")+11,y.indexOf(";",y.indexOf("margin-top"))).trim(),10)}else{c=parseInt(y.substring(y.indexOf("margin-top")+11).trim(),10)}}r.fillStyle=v;r.font=p;r.textBaseline="top";var z=0;var q=0;if(e&&parseFloat(e)){z=Math.round(-0.07*parseFloat(d)+2.66);q=Math.round(0.5*(parseFloat(e)-parseFloat(d))-2.75);e=parseFloat(e)}else{if(p.indexOf("/")!==-1&&parseFloat(p.substring(p.indexOf("/")+1))){z=Math.round(-0.07*parseFloat(d)+2.66);e=parseFloat(p.substring(p.indexOf("/")+1))}else{e=Math.round(1.14*parseFloat(d))}}if(browserDetect.browser==="Firefox"){z=z+Math.round(0.148148148*parseFloat(d)+0.5)}var s=0;var C=[m.box[0],m.box[1]+z+q+B+c,m.box[2],m.box[3]];var w=m.ca||"lt";if(j==="center"){w=w[0]+"c"}else{if(j==="right"){w=w[0]+"r"}else{if(j==="left"){w=w[0]+"l"}}}if(f.length==1){this.wrapText(r,u,C,e,w,d)}else{for(var x=0;x<f.length;x++){s=s+this.wrapText(r,f[x],[C[0],C[1]+(x+s)*e,C[2],C[3]-(x+s)*e],e,w,d)}}return l}};this.paintCanvas=function(m,k){var q=this;if(!this.useOneCanvas){k=$("<canvas>").attr({width:this.renderingMode==="singlepage"?m.box[2]:this.canvasSize[0],height:this.renderingMode==="singlepage"?m.box[3]:this.canvasSize[1]})}else{if(!k){k=this.canvas}}var u=k.get(0).getContext("2d");var q=this;var l={blur:function(){if(m.blur){if(q.renderBlur){var x=document.createElement("img"),z=widget.renderBlurLayerImmediate.call(q,m.id),c=jQuery.extend([],m.box),i,A;if(!z){return false}if(c[0]<0){c[0]=0}if(c[1]<0){c[1]=0}if(c[2]>z.width){c[2]=z.width}if(c[3]>z.height){c[3]=z.height}var y=storage.get(m.id,{returnModel:true});if(y){A=y.getPage().getBox();if(c[0]+c[2]>A[2]){c[2]=A[2]-c[0]}if(c[1]+c[3]>A[3]){c[3]=A[3]-c[1]}}u.drawImage(z,c[0],c[1],c[2],c[3],c[0],c[1],c[2],c[3])}}},background:function(){u.save();function z(){var C=(m.bgc)?m.bgc:["#CAD1D7","#C4CBD3"];var E=[5,2];var D="v";if(m.bgd){D=m.bgd[0];E=[m.bgd[1],m.bgd[2]]}u.fillStyle=C[1];u.fill();u.fillStyle=C[0];if(D=="v"){for(var F=E[0];F<p;){u.fillRect(F,0,E[1],o);F+=E[0]}}else{for(var F=E[0];F<o;){u.fillRect(0,F,p,E[1]);F+=E[0]}}}if(!p){p=0}if(!o){o=0}if(m.bg=="c"){u.fillStyle=m.bgc[0];u.fill()}else{if(m.bg=="s"){z()}else{if(m.bg=="l"){var i=q.useOneCanvas?m.box[0]:0;var y=q.useOneCanvas?m.box[1]:0;var x=q.useOneCanvas?m.box[1]+m.box[3]:m.box[3];g=u.createLinearGradient(i,y,i,x);l._gradient(g,u,m)}else{if(m.bg=="lrl"){g=u.createLinearGradient(m.box[0],m.box[1],m.box[0]+m.box[2],m.box[1]);l._gradient(g,u,m)}else{if(m.bg=="ld"){g=u.createLinearGradient(m.box[0],m.box[1],m.box[0]+m.box[2],m.box[1]+m.box[3]);l._gradient(g,u,m)}else{if(m.bg=="ld2"){g=u.createLinearGradient(m.box[0]+m.box[2],m.box[1],m.box[0],m.box[1]+m.box[3]);l._gradient(g,u,m)}else{if(m.bg=="r"){var c=m.box[3]/2;var B=m.box[0]+m.box[2]/2;var A=m.box[1]+c;g=u.createRadialGradient(B,A,0,B,A,c);l._gradient(g,u,m)}}}}}}}u.restore()},border:function(B,x,y,i){var A=0,z=0;B.lineWidth=(typeof d)==="number"?d:v;B.strokeStyle=x.b[1];B.stroke();B.save()},path:function(aa,z,C,O,B,T,Q,ad,S){aa.beginPath();var I=Math.floor(ad/2);var M=O+I;var X=B+I;var ac=O+Q-I;var P=B+T-I;var E=P-X;var R=ac-M;var i=["cloud","thumbsD","thumbsU"];if(S.sh&&S.sh[3]&&S.sh[2]){M+=Math.floor(S.sh[3]-S.sh[2]/2);X+=Math.floor(S.sh[3]-S.sh[2]/2);ac-=Math.floor(S.sh[3]+S.sh[2]/2);P-=Math.floor(S.sh[3]+S.sh[2]/2)}if($.isArray(C)){for(var N=0;N<4;N++){C[N]=C[N]||0}}else{C=[C,C,C,C]}if(z=="sq"){var W=Math.min((P-X)/2,(ac-M)/2);C[0]=Math.min(C[0],W);C[1]=Math.min(C[1],W);C[2]=Math.min(C[2],W);C[3]=Math.min(C[3],W);aa.moveTo(X+C[0],M),aa.lineTo(P-C[1],M),aa.quadraticCurveTo(P,M,P,M+C[1]),aa.lineTo(P,ac-C[2]),aa.quadraticCurveTo(P,ac,P-C[2],ac),aa.lineTo(X+C[3],ac),aa.quadraticCurveTo(X,ac,X,ac-C[3]),aa.lineTo(X,M+C[0]),aa.quadraticCurveTo(X,M,X+C[0],M)}if(z=="arrU"){var G=(P-X)+(5/4);var L=(X+P)/2;var T=P-X;aa.moveTo(L,M+ad);aa.lineTo(P-(ad/2),M+G);aa.lineTo(L+T*0.15,M+G);aa.lineTo(L+T*0.15,ac);aa.lineTo(L-T*0.15,ac);aa.lineTo(L-T*0.15,M+G);aa.lineTo(X+(ad/2),M+G);aa.lineTo(L,M+ad)}if(z=="arrD"){var G=(P-X)+(5/4);var L=(X+P)/2;var T=P-X;aa.moveTo(L,ac-ad);aa.lineTo(P-(ad/2),ac-G);aa.lineTo(L+T*0.15,ac-G);aa.lineTo(L+T*0.15,M);aa.lineTo(L-T*0.15,M);aa.lineTo(L-T*0.15,ac-G);aa.lineTo(X+(ad/2),ac-G);aa.lineTo((X+P)/2,ac)}if(z=="arrR"){var G=(ac-M)+(5/4);var J=(M+ac)/2;var Q=ac-M;aa.moveTo(P-ad,(M+ac)/2);aa.lineTo(P-G,ac-(ad/2));aa.lineTo(P-G,J+Q*0.15);aa.lineTo(X,J+Q*0.15);aa.lineTo(X,J-Q*0.15);aa.lineTo(P-G,J-Q*0.15);aa.lineTo(P-G,M+(ad/2));aa.lineTo(P-ad,(M+ac)/2)}if(z=="arrL"){var G=(ac-M)+(5/4);var J=(M+ac)/2;var Q=ac-M;aa.moveTo(X+ad,(M+ac)/2);aa.lineTo(X+G,ac-(ad/2));aa.lineTo(X+G,J+Q*0.15);aa.lineTo(P,J+Q*0.15);aa.lineTo(P,J-Q*0.15);aa.lineTo(X+G,J-Q*0.15);aa.lineTo(X+G,M+(ad/2));aa.lineTo(X+ad,(M+ac)/2)}if(z=="image"){aa.moveTo(X,M);aa.lineTo(P,M);aa.lineTo(P,ac);aa.lineTo(X,ac);aa.lineTo(X,M-Math.floor(ad/2));aa.moveTo(X,M);aa.lineTo(P,ac);aa.moveTo(P,M);aa.lineTo(X,ac)}else{if(z=="tri"){aa.moveTo(X,M);aa.lineTo(P,M);aa.lineTo(P,ac);aa.lineTo(X,M)}else{if(z=="tri"){aa.moveTo(X,M);aa.lineTo(P,M);aa.lineTo(P,ac);aa.lineTo(X,M)}else{if(z=="trR"){aa.moveTo(X,M);aa.lineTo(P,M);aa.lineTo(X,ac);aa.lineTo(X,M)}else{if(z=="ttrL"){aa.moveTo(P,M);aa.lineTo(P,ac);aa.lineTo(X,ac);aa.lineTo(P,M)}else{if(z=="ttrR"){aa.moveTo(X,M);aa.lineTo(P,ac);aa.lineTo(X,ac);aa.lineTo(X,M)}else{if(z=="triU"){aa.moveTo((X+P)/2,M);aa.lineTo(P,ac);aa.lineTo(X,ac);aa.lineTo((X+P)/2,M)}else{if(z=="triD"){aa.moveTo(X,M);aa.lineTo(P,M);aa.lineTo((X+P)/2,ac);aa.lineTo(X,M)}else{if(z=="triR"){aa.moveTo(X,M);aa.lineTo(P,(M+ac)/2);aa.lineTo(X,ac);aa.lineTo(X,M)}else{if(z=="triL"){aa.moveTo(P,M);aa.lineTo(X,(M+ac)/2);aa.lineTo(P,ac);aa.lineTo(P,M)}else{if(z=="ribU"){aa.moveTo(X,M);aa.lineTo((X+P)/2,M+(ac-M)*0.25);aa.lineTo(P,M);aa.lineTo(P,ac);aa.lineTo(X,ac);aa.lineTo(X,M)}else{if(z=="ribD"){aa.moveTo(X,M);aa.lineTo(P,M);aa.lineTo(P,ac);aa.lineTo((X+P)/2,M+0.75*(ac-M));aa.lineTo(X,ac);aa.lineTo(X,M)}else{if(z=="flagR"){aa.moveTo(X,M);aa.lineTo(P,M);aa.lineTo(X+(4/5)*E,(M+ac)/2);aa.lineTo(P,ac);aa.lineTo(X,ac);aa.lineTo(X,M)}else{if(z=="flagL"){aa.moveTo(X,M);aa.lineTo(X+(1/5)*E,(M+ac)/2);aa.lineTo(X,ac);aa.lineTo(P,ac);aa.lineTo(P,M);aa.lineTo(X,M)}else{if(z=="houseU"){aa.moveTo((X+P)/2,M);aa.lineTo(P,M+(3/7)*R);aa.lineTo(P,ac);aa.lineTo(X,ac);aa.lineTo(X,M+(3/7)*R);aa.lineTo((X+P)/2,M)}else{if(z=="houseD"){aa.moveTo((X+P)/2,ac);aa.lineTo(P,M+(4/7)*R);aa.lineTo(P,M);aa.lineTo(X,M);aa.lineTo(X,M+(4/7)*R);aa.lineTo((X+P)/2,ac)}else{if(z=="oct"){aa.moveTo(X+(21/72)*E,M);aa.lineTo(X+(51/72)*E,M);aa.lineTo(P,M+(21/72)*R);aa.lineTo(P,M+(51/72)*R);aa.lineTo(X+(51/72)*E,ac);aa.lineTo(X+(21/72)*E,ac);aa.lineTo(X,M+(51/72)*R);aa.lineTo(X,M+(21/72)*R);aa.lineTo(X+(21/72)*E,M)}else{if(z=="star"){var L=(X+P)/2;var T=P-X;var Q=ac-M;aa.moveTo(L,M);aa.lineTo(X+(33/54)*T,M+(39/102)*Q);aa.lineTo(P,M+(39/102)*T);aa.lineTo(X+(75/108)*T,M+(63/102)*Q);aa.lineTo(X+(87/108)*T,ac);aa.lineTo(L,M+(39/51)*Q);aa.lineTo(X+(21/108)*T,ac);aa.lineTo(X+(33/108)*T,M+(63/102)*Q);aa.lineTo(X,M+(39/102)*Q);aa.lineTo(X+(21/54)*T,M+(39/102)*Q);aa.lineTo(L,M)}else{if(z=="pgL"){aa.moveTo(X,ac);aa.lineTo(P,ac);aa.lineTo(P,M);aa.lineTo(X+(P-X)/3,M);aa.lineTo(X,M+(ac-M)/4);aa.lineTo(X,ac)}else{if(z=="pgR"){aa.moveTo(P,ac);aa.lineTo(X,ac);aa.lineTo(X,M);aa.lineTo(X+(P-X)*0.66,M);aa.lineTo(P,M+(ac-M)*0.25);aa.lineTo(P,ac)}else{if(z=="pointrL"){aa.moveTo(X,M);aa.lineTo(P,M);aa.lineTo(X+(5/7)*E,M+(3/7)*R);aa.lineTo(X+(5/7)*E,ac);aa.lineTo(X,M)}else{if(z=="pointrR"){aa.moveTo(X,M);aa.lineTo(P,M);aa.lineTo(X+(2/7)*E,ac);aa.lineTo(X+(2/7)*E,M+(3/7)*R);aa.lineTo(X,M)}else{if(z=="ldL"){aa.moveTo(X,M);aa.lineTo(X+2,M);aa.lineTo(P,ac);aa.lineTo(P-2,ac);aa.lineTo(X,M)}else{if(z=="ldR"){aa.moveTo(P,M);aa.lineTo(P-2,M);aa.lineTo(X,ac);aa.lineTo(X+2,ac);aa.lineTo(P,M)}else{if(z=="dropD"){aa.moveTo((X+P)/2,M);aa.lineTo(X+E/6,(M+ac)/2);aa.bezierCurveTo(X-(E*(1.5/6)),ac+(R/6.2),P+(E*(1.5/6)),ac+(R/6.2),X+E*(5/6),(M+ac)/2);aa.lineTo((X+P)/2,M)}else{if(z=="dropU"){aa.moveTo((X+P)/2,ac);aa.lineTo(X+E/6,(M+ac)/2);aa.bezierCurveTo(X-(E*(1.5/6)),M-(R/6.2),P+(E*(1.5/6)),M-(R/6.2),X+E*(5/6),(M+ac)/2);aa.lineTo((X+P)/2,ac)}else{if(z=="oval"){aa.moveTo(X,(ac+M)/2);aa.bezierCurveTo(X+E*(1/4),M-(R/7),X+E*(3/4),M-(R/7),P,(ac+M)/2);aa.bezierCurveTo(X+E*(3/4),ac+(R/7),X+E*(1/4),ac+(R/7),X,(ac+M)/2)}else{if(z=="cloud"){aa.moveTo(X+E*(1.5/9),ac);aa.bezierCurveTo(X,ac,X,M+R*(7/11),X+E*(1.6/9),M+R*(7/11));aa.bezierCurveTo(X+E/9,M+R/3,X+E/3,M+R/6.3,X+E*(4/9),M+R/3.2);aa.bezierCurveTo(X+E*(4.5/9),M,X+E*(7.4/9),M,X+E*(7.3/9),(ac+M)/2);aa.bezierCurveTo(P,(ac+M)/2,P,ac,X+E*(7.7/9),ac);aa.lineTo(X+E*(1.5/9),ac)}else{if(z=="person"){aa.moveTo(X,ac);aa.bezierCurveTo((X+P)/16,(M+ac)*(11/14),(X+P)*(3/16),(M+ac)*(10/14),(X+P)*(6/16),(ac+M)*(9/14));aa.bezierCurveTo((X+P)*(2.5/16),(M+ac)*(4/7),(X+P)*(2.5/16),M,(X+P)/2,M);aa.bezierCurveTo((X+P)*(13.5/16),M,(X+P)*(13.5/16),(M+ac)*(4/7),(X+P)*(10/16),(ac+M)*(9/14));aa.bezierCurveTo((X+P)*(13/16),(M+ac)*(10/14),(X+P)*(15/16),(M+ac)*(11/14),P,ac);aa.lineTo(X,ac)}else{if(z=="thumbsU"){aa.moveTo(X,M+R*(16/17));aa.lineTo(X,M+R*(15/34));aa.bezierCurveTo(X+E*(2/15),M+R*(7/17),X+E*(9/30),M+R*(4/17),X+E/3,M+R*(3/34));aa.bezierCurveTo(X+E*(5.2/15),M,X+E*(9/15),M,X+E*(8.5/15),M+R*(2/17));aa.lineTo(X+E*(7/15),M+R*(11/34));aa.bezierCurveTo(X+E*(9/15),M+R*(13/34),X+E*(11/15),M+R*(13/34),X+E*(12/15),M+R*(13/34));aa.bezierCurveTo(P,M+R*(13/34),P,M+R*(19/34),X+E*(12/15),M+R*(19/34));aa.bezierCurveTo(X+E*(14/15),M+R*(19/34),X+E*(27/30),M+R*(12/17),X+E*(23/30),M+R*(12/17));aa.bezierCurveTo(X+E*(13/15),M+R*(12/17),X+E*(25/30),M+R*(29/34),X+E*(11/15),M+R*(29/34));aa.bezierCurveTo(X+E*(25/30),M+R*(29/34),X+E*(12/15),ac,X+E*(8.5/15),ac);aa.bezierCurveTo((X+P)/2,ac,X+E/5,ac,X,M+R*(16/17))}else{if(z=="thumbsD"){aa.moveTo(X,M+R/17);aa.lineTo(X,M+R*(19/34));aa.bezierCurveTo(X+E*(2/15),M+R*(10/17),X+E*(9/30),M+R*(13/17),X+E/3,M+R*(31/34));aa.bezierCurveTo(X+E*(5.2/15),ac,X+E*(9/15),ac,X+E*(8.5/15),M+R*(15/17));aa.lineTo(X+E*(7/15),M+R*(23/34));aa.bezierCurveTo(X+E*(9/15),M+R*(21/34),X+E*(11/15),M+R*(21/34),X+E*(12/15),M+R*(21/34));aa.bezierCurveTo(P,M+R*(21/34),P,M+R*(15/34),X+E*(12/15),M+R*(15/34));aa.bezierCurveTo(X+E*(14/15),M+R*(15/34),X+E*(27/30),M+R*(5/17),X+E*(23/30),M+R*(5/17));aa.bezierCurveTo(X+E*(13/15),M+R*(5/17),X+E*(25/30),M+R*(5/34),X+E*(11/15),M+R*(5/34));aa.bezierCurveTo(X+E*(25/30),M+R*(5/34),X+E*(12/15),M,X+E*(8.5/15),M);aa.bezierCurveTo(X+E/2,M,X+E/5,M,X,M+R/17)}else{if(z=="arcL"){var T=P-X;var Q=ac-M;var A=(Q>=(T*2))?T:Q/2;aa.moveTo(X+A,M);aa.arcTo(X,M,X,M+A,A);aa.arcTo(X,M+(2*A),X+A,M+(2*A),A);aa.lineTo(X+A,M)}else{if(z=="arcR"){var T=P-X;var Q=ac-M;var A=(Q>=(T*2))?T:Q/2;aa.moveTo(X,M);aa.arcTo(X+A,M,X+A,M+A,A);aa.arcTo(X+A,M+(2*A),X,M+(2*A),A);aa.lineTo(X,M)}else{if(z=="arcU"){var T=P-X;var Q=ac-M;var A=(T>=(Q*2))?Q:T/2;aa.moveTo(X,M+A);aa.arcTo(X,M,X+A,M,A);aa.arcTo(X+(2*A),M,X+(2*A),M+(2*A),A);aa.lineTo(X,M+A)}else{if(z=="arcD"){var T=P-X;var Q=ac-M;var A=(T>=(Q*2))?Q:T/2;aa.moveTo(X,M);aa.arcTo(X,M+A,X+A,M+A,A);aa.arcTo(X+(2*A),M+A,X+(2*A),M,A);aa.lineTo(X,M)}else{if(z=="folder"){var T=P-X;var Q=ac-M;aa.moveTo(X+(3/8)*T,M+(2/15)*Q);aa.lineTo(P-C[1],M+(2/15)*Q);aa.quadraticCurveTo(P,M+(2/15)*Q,P,(M+(2/15)*Q)+C[1]);aa.lineTo(P,ac-C[2]);aa.quadraticCurveTo(P,ac,P-C[2],ac);aa.lineTo(X+C[3],ac);aa.quadraticCurveTo(X,ac,X,ac-C[3]);aa.lineTo(X,M+C[0]);aa.quadraticCurveTo(X,M,X+C[0],M);aa.lineTo(X+(5/16)*T,M);aa.lineTo(X+(3/8)*T,M+(2/15)*Q)}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}if(z=="speechRight"){aa.moveTo(P-17,ac);aa.lineTo(P-96,ac-13);aa.lineTo(X,ac-13);aa.lineTo(X,M);aa.lineTo(P,M);aa.lineTo(P,ac-13);aa.lineTo(P-38,ac-13);aa.lineTo(P-17,ac)}if(z=="speechLeft"){aa.moveTo(X+17,ac);aa.lineTo(X+96,ac-13);aa.lineTo(P,ac-13);aa.lineTo(P,M);aa.lineTo(X,M);aa.lineTo(X,ac-13);aa.lineTo(X+38,ac-13);aa.lineTo(X+17,ac)}else{if(z=="bubr"){right=B+T-1;bottom=O+Q-2;tailSize=7;if(m.b){O=O+m.b[0]/2;B=B+m.b[0]/2;right=right-m.b[0]/2;bottom=bottom-m.b[0]/2}aa.moveTo(right-tailSize,bottom-7);aa.lineTo(right-tailSize,O+C[1]);aa.quadraticCurveTo(right-tailSize,O,right-C[1]-tailSize,O);aa.lineTo(B+C[0],O);aa.quadraticCurveTo(B,O,B,O+C[0]);aa.lineTo(B,bottom-C[3]);aa.quadraticCurveTo(B,bottom,B+C[3],bottom);aa.lineTo(right-19,bottom);aa.quadraticCurveTo(right-15,bottom-1,right-14,bottom-2);aa.quadraticCurveTo(right-7,bottom+1,right-1,bottom-2);aa.quadraticCurveTo(right-tailSize,bottom-3,right-tailSize,bottom-7)}else{if(z=="bubl"){right=B+T-1;bottom=O+Q-2;tailSize=7;if(m.b){O=O+m.b[0]/2;B=B+m.b[0]/2;right=right-m.b[0]/2;bottom=bottom-m.b[0]/2}aa.moveTo(right,bottom-C[2]);aa.lineTo(right,O+C[1]);aa.quadraticCurveTo(right,O,right-C[1],O);aa.lineTo(B+C[0]+tailSize,O);aa.quadraticCurveTo(B+tailSize,O,B+tailSize,O+C[0]);aa.lineTo(B+tailSize,bottom-6);aa.quadraticCurveTo(B+4,bottom-1,B+1,bottom-2);aa.quadraticCurveTo(B+2,bottom+2,B+13,bottom-2);aa.quadraticCurveTo(B+15,bottom,B+19,bottom);aa.lineTo(right-C[2],bottom);aa.quadraticCurveTo(right,bottom,right,bottom-C[2])}else{if(z=="arrowL"||z=="arrowR"||z=="arrowU"||z=="arrowD"){var V=2;if(S.aCurve){V=S.aCurve}var U=12;if(S.aSize){U=S.aSize}if(z=="arrowL"){aa.moveTo(X+U,M);aa.lineTo(P-C[1],M);aa.quadraticCurveTo(P,M,P,M+C[1]);aa.lineTo(P,ac-C[2]);aa.quadraticCurveTo(P,ac,P-C[2],ac);aa.lineTo(X+U,ac);aa.bezierCurveTo(X+U-V,ac,X,((ac+M)/2)+V,X,(ac+M)/2);aa.bezierCurveTo(X,((ac+M)/2)-V,U-V+X,M,X+U,M)}else{if(z=="arrowR"){aa.moveTo(X+C[0],M);aa.lineTo(P-U,M);aa.bezierCurveTo(P-U+V,M,P,((M+ac)/2)-V,P,(M+ac)/2);aa.bezierCurveTo(P,((M+ac)/2)+V,P-U+V,ac,P-U,ac);aa.lineTo(X+C[3],ac);aa.quadraticCurveTo(X,ac,X,ac-C[3]);aa.lineTo(X,M+C[0]);aa.quadraticCurveTo(X,M,X+C[0],M)}else{if(z=="arrowD"){var K=(S.aW)?S.aW:K;var ab=(X+P)/2;var Y=K/2;aa.moveTo(X+C[0],M);aa.lineTo(P-C[1],M);aa.quadraticCurveTo(P,M,P,M+C[1]);aa.lineTo(P,ac-U-C[2]);aa.quadraticCurveTo(P,ac-U,P-C[2],ac-U);aa.lineTo(ab+Y,ac-U);aa.lineTo(ab,ac);aa.lineTo(ab-Y,ac-U);aa.lineTo(X+C[3],ac-U);aa.quadraticCurveTo(X,ac-U,X,ac-U-C[3]);aa.lineTo(X,M+C[0]);aa.quadraticCurveTo(X,M,X+C[0],M)}else{if(z=="arrowU"){var K=(S.aW)?S.aW:20;var ab=(X+P)/2;var Y=K/2;aa.moveTo(X+C[0],M+U);aa.lineTo(ab-Y,M+U);aa.lineTo(ab,M);aa.lineTo(ab+Y,M+U);aa.lineTo(P-C[1],M+U);aa.quadraticCurveTo(P,M+U,P,M+U+C[1]);aa.lineTo(P,ac-C[2]);aa.quadraticCurveTo(P,ac,P-C[2],ac);aa.lineTo(X+C[2],ac);aa.quadraticCurveTo(X,ac,X,ac-C[3]);aa.lineTo(X,M+U+C[0]);aa.quadraticCurveTo(X,M+U,X+C[3],M+U)}}}}}else{if(z=="c"){var H=T/2,F=Q/2,Z=Math.min(H,F),D=Math.min(ad|0,Z),A=Z-D/2;d=D;aa.arc(B+H,O+F,A,0,Math.PI*2,true)}}}}}aa.closePath()},_gradient:function(B,D,y){var x=["#ffffff","#000000"];var A=[0,1];if(y.bgc&&y.bgd){x=y.bgc;A=y.bgd}for(var z=0;z<x.length&&z<A.length;z++){try{B.addColorStop(A[z],x[z])}catch(C){}}D.fillStyle=B;D.fill()},_glaze:function(B,z){var F=5,C=q.useOneCanvas?2+z.box[1]:2,y=q.useOneCanvas?10+z.box[0]:10,x=z.box[2]-27,E=10,i=0,D=7;if(z.s=="bubl"){y+=D}l.path(B,"sq",F,C,y,x,E,i,z);var A=B.createLinearGradient(0,C+E,0,C);A.addColorStop(0,"rgba(231, 231, 231, 0.2)");A.addColorStop(0.59,"rgba(240, 240, 240, 0.25)");A.addColorStop(1,"rgba(249, 249, 249, 0.3)");B.fillStyle=A;B.fill();B.restore()},_shadow:function(x,i){x.shadowColor=i.sh[0];x.shadowOffsetX=i.sh[1];x.shadowOffsetY=i.sh[2];x.shadowBlur=i.sh[3]},_effect:function(J,D){var x=D.fx;for(var E=0;E<x.length;E++){var G=x[E];if(G[0]=="dots"){var N=G[1];var H=G[2];var M=G[3];J.fillStyle=G[4];var z=D.box[2];var y=D.box[3];var K=N+H;var F=N+M;var L=parseInt(z/K)+1;var I=parseInt(y/F)+1;var C=0;for(var B=0;B<I;B++){C=(C)?0:N;for(var A=0;A<L;A++){J.beginPath();J.arc((A*K)+C,(B*F),N/2,0,2*Math.PI);J.closePath();J.fill()}}}}},_setImage:function(y,i){try{y.drawImage(y.canvas,0,0)}catch(x){}}};var j=this.renderingMode==="singlepage"?0:m.box[0];var n=this.renderingMode==="singlepage"?0:m.box[1];var p=m.box[2];var o=m.box[3];var v=0;var h=0;var r=m.b;var d=null;if(r){v=r[0];h=r.length>3?r.slice(2):r[2]}var f=m.s?m.s:"sq";u.save();if(!this.skipImages&&storage.get(m.id)){l.blur()}l.path(u,f,h,n,j,p,o,v,m);if(m.sh){l._shadow(u,m)}if(m.bg){l.background(u,m)}u.restore();if(r&&v>0){l.border(u,m,p,o)}if(m.glaze&&m.glaze=="y"){l._glaze(u,m)}if(m.fx&&m.fx.length>0){l._effect(u,m)}if(m.i){for(var s=0;s<m.i.length;s++){var t=m.i[s];var w=new Image();function e(){var i=t[5];if(typeof(i)=="string"&&i.search("%")!=-1){i=(p*parseInt(i)/100)-t[3]/2}else{if(i<0){i=parseInt(p)+t[5]-t[3]}}var c=t[6];if(typeof(c)=="string"&&c.search("%")!=-1){c=(o*parseInt(c)/100)-t[4]/2}else{if(c<0){c=parseInt(o)+t[6]-t[4]}}if(q.imagesLoaded[t[0]]){u.drawImage(q.imagesLoaded[t[0]],t[1],t[2],m.box[2],m.box[3],i+j,c+n,m.box[2],m.box[3])}else{w.onload=function(){try{u.drawImage(w,t[1],t[2],m.box[2],m.box[3],i+j,c+n,m.box[2],m.box[3]);if(u.canvas.hasOwnProperty("onchange")){u.canvas.onchange()}}catch(x){}};w.src=t[0]}}$(w).ready(e)}}else{}if(!this.useCanvas){k=this.canvasToImg(k)}return k};this.canvasToImg=function(d){var c=d.get(0).toDataURL("image/png");return $('<img src="'+c+'">')};this.renderOne=function(c,i,e){var h={$rendition:{},childWidgets:[]};if(!c.box){c.box=this.calculateBox(c,i,e)}if(fluid.widget.isShapeWidget(c)){h.$shapeRendition=this.paintCanvas(c)}if(fluid.widget.isUploadWidget(c)){}if(fluid.widget.isTextWidget(c)){h.$textRendition=this.renderText(c)}if(fluid.widget.hasChildWidgets(c)){var f=fluid.wdgProvider.getChildWidgets(c,true);for(var d=0;d<f.length;d++){h.childWidgets.push(this.renderOne(f[d],c,c.ad[d]))}}if(fluid.widget.hasSegments(c)){h.segments=this.renderSegments(c)}if(!h.childWidgets.length){delete h.childWidgets}return h};this.renderSegments=function(d){var e=[];var c=[];for(var f=0;f<d.sc;f++){if(d.segments&&d.segments.length){e.push({wdgObj:storage.get(d.segments[f].id),box:[]})}else{e.push({wdgObj:fluid.wdgProvider.getById(d.seg[f%d.seg.length]),box:[]})}}for(f=0;f<e.length;f++){if(e[f].wdgObj.wh){e[f].wdgObj.tlwh=[0,0,e[f].wdgObj.wh[0],e[f].wdgObj.wh[1]]}if(e[f].wdgObj.tlwh&&typeof(e[f].wdgObj.tlwh[2])==="number"){e[f].box[2]=e[f].wdgObj.tlwh[2]}else{if(e[f].wdgObj.tlwh){if(e[f].wdgObj.tlwh&&e[f].wdgObj.tlwh[2]==="a"){e[f].box[2]=d.box[2]/d.sc}else{if(e[f].wdgObj.tlwh[2].indexOf("%")!==-1){e[f].box[2]=(parseFloat(e[f].wdgObj.tlwh[2])/100)*d.box[2]}}}}if(e[f].wdgObj.tlwh&&typeof(e[f].wdgObj.tlwh[3])==="number"){e[f].box[3]=e[f].wdgObj.tlwh[3]}else{if(e[f].wdgObj.tlwh){if(e[f].wdgObj.tlwh&&e[f].wdgObj.tlwh[3]==="a"){e[f].box[3]=d.box[3]/d.sc}else{if(e[f].wdgObj.tlwh[3].indexOf("%")!==-1){e[f].box[3]=(parseFloat(e[f].wdgObj.tlwh[3])/100)*d.box[3]}}}}}if(d.sl=="h"){if(d.sa=="tl"||!d.sa){for(f=0;f<e.length;f++){e[f].box[0]=(f*(d.box[2]/d.sc));e[f].box[1]=0+d.sp[1]}}else{if(d.sa=="d"){for(f=0;f<e.length;f++){e[f].box[0]=(f*(d.box[2]/d.sc))+Math.max(d.box[2]/d.sc-e[f].box[2],0)/2;e[f].box[1]=(d.box?d.box[1]:0)+d.sp[1]}}}}else{for(f=0;f<e.length;f++){e[f].box[0]=d.box?d.box[0]:0;e[f].box[1]=(d.box?d.box[1]:0)+(f*e[f].box[3])}}for(f=0;f<e.length;f++){if(f===0&&e[f].wdgObj.bts){e[f].wdgObj.b=e[f].wdgObj.bts}else{if(f===e.length-1&&e[f].wdgObj.bbs){e[f].wdgObj.b=e[f].wdgObj.bbs}else{if(e[f].wdgObj.bms&&d.sl==="v"){e[f].wdgObj.b=e[f].wdgObj.bms}}}if(f===0&&e[f].wdgObj.bls){e[f].wdgObj.b=e[f].wdgObj.bls}else{if(f===e.length-1&&e[f].wdgObj.brs){e[f].wdgObj.b=e[f].wdgObj.brs}else{if(e[f].wdgObj.bms&&d.sl==="h"){e[f].wdgObj.b=e[f].wdgObj.bms}}}e[f].wdgObj.box=e[f].box;c.push(this.renderOne(e[f].wdgObj))}return c};this.renderRecursive=function(d,h){var f={};if(d.length){var c=[];for(var e=0;e<d.length;e++){this.generateCanvas(d[e].originId);f=this.renderOne(d[e],h);c.push(f)}}else{this.generateCanvas(d.originId);f=this.renderOne(d,h)}return c||f};this.onPageRenderFinish=function(f){this.renderingQueue[f]=null;if(this.afterPageRendered){var j=this.canvases[f].get(0).toDataURL("image/png");this.afterPageRendered(f,j,1,false)}else{var h=[];var e=project.get("id");var j=this.canvases[f].get(0).toDataURL("image/jpeg",0.5);var i=$("#"+f+"canvas.page-preview");var d=storage.get(f);var c=storage.get(f,{returnModel:true});c.set({imgData:j});if(pagesCache[f]){pagesCache[f].img=j}if(project.useLocalDb){h.push({id:f,data:j,project:e})}requestAnimationFrame(function(){if(!storage.get(f)||!storage.get(f).widgets||storage.get(f).widgets.length===0){return}var k=$('<img class="page-preview" src="'+j+'">');var l=new Image();l.src=j;k.insertAfter(i);setTimeout(function(){i.remove()}.bind(i),650);l.onload=function(){var n=$("#scaled-"+f);var m=fluid.zoom.getAllPagesParams().newScale;n.get(0).innerHTML="";$("#scaled-"+f).append(l);n.css({top:d.y*m,left:d.x*m,width:d.width*m,height:d.height*m})}.bind(this)}.bind(this))}};this.onRenderFinish=function(){if(typeof window.callPhantom==="function"){$("#canvas").css({top:(-this.cropping.y+15)+"px",left:(-this.cropping.x+15)+"px"});window.callPhantom({event:"finishedrendering",cropping:this.cropping})}else{if(!this.afterPageRendered){var d=[];var c=project.get("id");$("canvas.page-preview").each(function(){var h=$(this).parents(".screen").attr("id");var f=storage.get(h);if(!f||!f.widgets||!f.widgets.length){return}var i=$(this).get(0).toDataURL("image/jpeg",0.5);if(pagesCache[h]){pagesCache[h].img=i}var e=storage.get(h,{returnModel:true});e.set({imgData:i});requestAnimationFrame(function(){var j=$('<img class="page-preview" src="'+i+'">');j.insertAfter($(this));setTimeout(function(){$(this).remove()}.bind(this),500)}.bind(this))})}}};this.countRemainingLoads=function(d){var e=0;if(d){for(var f in this.imagesToLoad[d]){e++}for(var f in this.uploadsToLoad[d]){e++}return e}else{for(var d in this.imagesToLoad){if(this.imagesToLoad.hasOwnProperty(d)){for(var c in this.imagesToLoad[d]){if(this.imagesToLoad[d].hasOwnProperty(c)){e++}}}}for(var d in this.uploadsToLoad){if(this.uploadsToLoad.hasOwnProperty(d)){for(var c in this.uploadsToLoad[d]){if(this.uploadsToLoad[d].hasOwnProperty(c)){e++}}}}return e}};this.onImgLoadErr=function(e,k,d){if(d.src.indexOf("data/img")!==-1){if(account.hasUpload(k)===false&&account.syncedUploads){page.removeWidget(e,this.uploadsToLoad[e][k]);storage.remove(this.uploadsToLoad[e][k])}if(this.imagesToLoad[e][k]){delete this.imagesToLoad[e][k]}if(this.uploadsToLoad[e][k]){delete this.uploadsToLoad[e][k]}var h=this.countRemainingLoads(e);if(h===0){for(var f=0;f<this.renderingQueue[e].length;f++){var c=this.renderingQueue[e][f];if(fluid.widget.isShapeWidget(c)){this.paintCanvas(c,this.canvases[e])}if(fluid.widget.isUploadWidget(c)){this.renderUpload(c,this.canvases[e],this.imagesLoaded[c.data])}if(fluid.widget.isTextWidget(c)){this.renderText(c,this.canvases[e])}}if(this.countRemainingLoads()===0){this.onRenderFinish()}}return}var j=new Image();j.onload=this.onImgLoad.bind(this,e,k);j.onerror=this.onImgLoadErr.bind(this,e,k);j.src="data/img/"+k};this.onImgLoad=function(f,l,e){this.imagesLoaded[l]=e;if(this.imagesToLoad[f][l]){delete this.imagesToLoad[f][l]}if(this.uploadsToLoad[f][l]){delete this.uploadsToLoad[f][l]}var j=this.countRemainingLoads(f);if(j===0){for(var h=0;h<this.renderingQueue[f].length;h++){var d=this.renderingQueue[f][h];if(fluid.widget.isShapeWidget(d)){this.paintCanvas(d,this.canvases[f])}if(fluid.widget.isUploadWidget(d)){this.renderUpload(d,this.canvases[f],this.imagesLoaded[d.data])}if(fluid.widget.isTextWidget(d)){this.renderText(d,this.canvases[f])}}this.onPageRenderFinish(f);if(this.countRemainingLoads()===0){this.onRenderFinish()}}var c=fluid.main.uploads&&fluid.main.uploads.get(l);if(c&&l.indexOf("i_")===0&&window.uploadsCache&&!window.uploadsCache[l]){if(!project.uploadCanvas||utils.isTaintedCanvas(project.uploadCanvas)){project.uploadCanvas=document.createElement("canvas")}project.uploadCanvas.width=e.naturalWidth;project.uploadCanvas.height=e.naturalHeight;project.uploadCanvasCtx=project.uploadCanvas.getContext("2d");project.uploadCanvasCtx.drawImage(evt.target,0,0);var k=project.uploadCanvas.toDataURL("image/png");if(c&&k){c.set({imgData:k})}}};this.pageRenderOne=function(d){var h={$rendition:{}};if(!this.skipImages){if(!this.imagesToLoad[this.pageId]){this.imagesToLoad[this.pageId]={}}if(!this.uploadsToLoad[this.pageId]){this.uploadsToLoad[this.pageId]={}}var e=false;if(d.i&&!this.imagesToLoad[this.pageId][d.i[0][0]]){e=true}if(d.upload==="y"&&!this.uploadsToLoad[this.pageId][d.data]){e=true}if(e||this.renderingQueue[this.pageId].length>0){if(d.i&&!this.imagesToLoad[this.pageId][d.i[0][0]]){var c=new Image();this.imagesToLoad[this.pageId][d.i[0][0]]=true;c.onload=this.onImgLoad.bind(this,this.pageId,d.i[0][0],c);c.src=d.i[0][0]}else{if(d.upload==="y"&&!this.uploadsToLoad[this.pageId][d.data]){var f=storage.get(d.data);this.uploadsToLoad[this.pageId][d.data]=d.id;if(window.uploadsCache&&window.uploadsCache[d.data]){c.src=uploadsCache[d.data]}else{fluid.upload.get({id:d.data,callback:function(k,l,i){if(i.success){if(i.image){this.onImgLoad.call(this,k,l,i.image)}else{if(i.imgData){var j=new Image();j.onload=this.onImgLoad.bind(this,k,l,j);j.onerror=this.onImgLoadErr.bind(this,k,l,j);j.src=i.imgData}}}else{var j=new Image();this.onImgLoadErr.call(this,k,l,j)}}.bind(this,this.pageId,d.data),priority:fluid.upload.priority.pageZoomedOut})}}}this.renderingQueue[this.pageId].push(d);h.$shapeRendition=this.canvas;return h}}if(fluid.widget.isShapeWidget(d)||d.segments){h.$shapeRendition=this.paintCanvas(d)}if(!this.skipImages&&fluid.widget.isUploadWidget(d)){h.$shapeRendition=this.renderUpload(d)}if(fluid.widget.isTextWidget(d)){h.$textRendition=this.renderText(d)}return h};this.calculatePageBox=function(c,d){return storage.get(d,{returnModel:true}).getBox()};this.foo=function(e,d){var h=[];var f=e.tlwh[2]==null?0:e.tlwh[2];if(f&&typeof(f)==="number"){h[2]=f}else{if(f&&f.indexOf("%")!==-1){h[2]=(parseFloat(f)/100)*d.box[2]}else{h[2]=d.box[2]}}var c=e.tlwh[3]==null?0:e.tlwh[3];if(c&&typeof(c)==="number"){h[3]=c}else{if(c&&c.indexOf("%")!==-1){h[3]=(parseFloat(c)/100)*d.box[3]}else{if(c==="a"){h[3]=$("#"+e.lockTo).height()||d.box[3]}else{h[3]=d.box[3]}}}var j=e.tlwh[0]==null?0:e.tlwh[0];if(!e.ca||e.ca[0]=="t"){if(typeof(j)==="number"){h[1]=j+d.box[1]}else{if(j.indexOf("%")!==-1){h[1]=((parseFloat(j)/100)*d.box[3])+d.box[1]}else{h[1]=parseInt(j,10)+d.box[1]}}}else{if(e.ca[0]=="c"){if(typeof(j)==="number"){h[1]=j+d.box[1]+d.box[3]/2-h[3]/2}else{if(j.indexOf("%")!==-1){h[1]=((parseFloat(j)/100)*d.box[3])+d.box[1]+d.box[3]/2-h[3]/2}else{h[1]=parseInt(j,10)+d.box[1]+d.box[3]/2-h[3]/2}}}else{if(e.ca[0]=="b"){if(typeof(j)==="number"){h[1]=d.box[1]+d.box[3]-j-h[3]}else{if(j.indexOf("%")!==-1){h[1]=d.box[1]+d.box[3]-((parseFloat(j)/100)*d.box[3])-h[3]}else{h[1]=d.box[1]+d.box[3]-parseInt(j,10)}}}}}var i=e.tlwh[1]==null?0:e.tlwh[1];if(!e.ca||e.ca[1]=="l"){if(typeof(i)==="number"){h[0]=i+d.box[0]}else{if(i.indexOf("%")!==-1){h[0]=((parseFloat(i)/100)*d.box[2])+d.box[0]}else{h[0]=parseInt(i,10)+d.box[0]}}}else{if(e.ca[1]=="c"){if(typeof(i)==="number"){h[0]=i+d.box[0]+d.box[2]/2-h[2]/2}else{if(i.indexOf("%")!==-1){h[0]=((parseFloat(i)/100)*d.box[2])+d.box[0]+d.box[2]/2-h[2]/2}else{h[0]=parseInt(i,10)+d.box[0]+d.box[2]/2}}}else{if(e.ca[1]=="r"){if(typeof(i)==="number"){h[0]=d.box[0]+d.box[2]-i-h[2]}else{if(i.indexOf("%")!==-1){h[0]=d.box[0]+d.box[2]-((parseFloat(i)/100)*d.box[2])-h[2]}else{h[0]=d.box[0]+d.box[2]-f-parseInt(i,10)}}}}}h[0]=~~h[0];h[1]=~~h[1];h[2]=~~h[2];h[3]=~~h[3];return h};this.calculatePageBox=function(d,h){var f;var e;var c=(d.widgets[h]&&d.widgets[h].of)?d.widgets[h].of:null;if(!d.widgets[h]||!d.widgets[h].tlwh){return[0,0,this.canvasSize[0],this.canvasSize[1]]}if(!c){e={box:[0,0,this.canvasSize[0],this.canvasSize[1]]};f=this.foo(d.widgets[h],e)}else{if(d.widgets[c]&&d.widgets[c].box){f=this.foo(d.widgets[h],d.widgets[c])}else{f=this.calculatePageBox(d,c)}}return f};this.exceedsPage=function(d,c){if(d.box==undefined){return false}if(d.box[0]<0||d.box[1]<0){return true}if(d.box[0]+d.box[2]>c.width){return true}if(d.box[1]+d.box[3]>c.height){return true}return false};this.renderPage=function(d,c,f){if(this.renderingQueue[d.id]&&this.renditions[d.id]){return this.renditions[d.id]}else{this.renderingQueue[d.id]=[]}if(this.finishTimeout){clearTimeout(this.finishTimeout);delete this.finishTimeout}var i={};var e=[];var h=[];for(var j in d.widgets){d.widgets[j].id=j;d.widgets[j].box=this.calculatePageBox(d,j);if(!f){if(this.useOneCanvas&&this.exceedsPage(d.widgets[j],d)){h.push(j)}}}this.setCropping(d);this.generateCanvas(d.id);this.pageId=d.id;i=this.pageRenderOne({st:"b",ca:"tl",bg:"c",bgc:["#ffffff"],box:[0,0,this.canvasSize[0],this.canvasSize[1]],wg:[1],id:"dummy-bg-"+(new Date().getTime())});e.push(i);for(var j in d.widgets){if(d.widgets[j].st&&d.widgets[j].st==="b"){i=this.pageRenderOne(d.widgets[j]);i.id=j;i.lockTo=d.widgets[j].lockTo;i.box=d.widgets[j].box;e.push(i)}}for(var j in d.widgets){if((!d.widgets[j].st||d.widgets[j].st!=="b")&&!(c&&d.widgets[j].dm==="t")){i=this.pageRenderOne(d.widgets[j]);i.id=j;i.lockTo=d.widgets[j].lockTo;i.box=d.widgets[j].box;e.push(i)}}if(this.countRemainingLoads(d.id)===0){this.onPageRenderFinish(d.id)}if(this.countRemainingLoads()===0){this.finishTimeout=setTimeout(this.onRenderFinish.bind(this),200)}this.renditions[d.id]=e;return e};this.preparePage=function(e){var d=$.extend({id:e},storage.get(e));d.widgets=d.widgets.reduce(function(h,f){h[f]=$.extend({},storage.get(f));h[f].id=f;return h},{});for(var c in d.widgets){d.widgets[c].box=this.calculatePageBox(d,c)}return d},this.renderWdg=function(k,f){var c;var j=[0,0];f=$.extend({},f);f.widgets={};this.renderingQueue[k]=[];this.pageId=k;for(var d=0;f.ad&&d<f.ad.length;d++){c=f.ad[d][0];var e={wh:[widgets.summary[c].wh[0],widgets.summary[c].wh[1]]};(e.wh[0]=="a")&&(e.wh[0]="100%");(e.wh[1]=="a")&&(e.wh[1]="100%");e.tlwh=[f.ad[d][2],f.ad[d][1],e.wh[0],e.wh[1]];f.widgets[c]={id:c,box:this.calculateBox(e)};f.widgets[c]=$.extend(f.widgets[c],widgets.summary[c]);delete f.widgets[c].blur;j[0]=Math.max(j[0],f.widgets[c].box[0]+f.widgets[c].box[2]);j[1]=Math.max(j[1],f.widgets[c].box[1]+f.widgets[c].box[3])}var h=Math.max(j[0],j[1]);this.generateCanvas(k,{width:h,height:h});for(var d=0;f.ad&&d<f.ad.length;d++){this.renderSubWdg(f.widgets[f.ad[d][0]])}if(this.countRemainingLoads(k)===0){this.onPageRenderFinish(k)}},this.renderSubWdg=function(d){this.pageRenderOne(d);if(d.ad&&d.ad.length){var e,c;for(var f=0;f<d.ad.length;f++){e=d.ad[f][0];c=$.extend({},widgets.summary[e]);c.id=e;c.box=this.calculateBox(c,d,d.ad[f]);c.blur=false;this.renderSubWdg(c)}}else{if(d.sc){this.renderSegments(d)}}};this.renderWidgetsBelow=function(e,h,k){h=h||this.preparePage(this.pageId);var d=0,n=storage.get(h.id).widgets,f=n.length,c=this.ctx;for(;d<f;d++){if(n[d]===e){break}var l=h.widgets[n[d]];if(!l.dm){if((fluid.widget.isUploadWidget(l)||l.i)&&k){var j=document.getElementById(n[d]),m=j?(j.querySelector("img")||j.querySelector("canvas")):null;if(m){c.drawImage(m,l.box[0],l.box[1],l.box[2],l.box[3])}}else{this.pageRenderOne(l)}}}if(this.countRemainingLoads(h.id)===0){this.onPageRenderFinish(h.id)}if(this.countRemainingLoads()===0){this.finishTimeout=setTimeout(this.onRenderFinish.bind(this),200)}};this.onProjectUnloaded=function(c){if(!this.canceledPreview){this.canceledPreview=[]}this.canceledPreview.push(c)};this.renderProjectPreview=function(t,m){t=$.extend({},t);if(this.currentProjectId&&t[this.currentProjectId]){return}this.previewSize={width:205,height:160};var A=$("<canvas></canvas>");var k=A.get(0).getContext("2d");this.canvas=A;var n=$('<canvas class="project-preview" width="'+this.previewSize.width+'" height="'+this.previewSize.height+'"></canvas>').css({position:"relative"});var v=n.get(0).getContext("2d");var l;var q;var c={};var z={};for(var h in t){if(t.hasOwnProperty(h)){if(h.indexOf("w_")===0||(h.indexOf("w")===0&&h.length==33)){z[h]=$.extend({},t[h])}else{if(h.indexOf("x_")===0||(h.indexOf("x")===0&&h.length==33)){c[h]=$.extend({},t[h])}else{if(h.indexOf("p_")===0||(h.indexOf("p")===0&&h.length==33)){l=$.extend({},t[h]);q=h}}}}}this.lastProjectId=q;this.currentProjectId=q;var p=l.pages;if(!p){m.call(this,q,n);this.currentProjectId=null;return}var d;var B={x:l.canvasWidth,y:l.canvasHeight,x2:0,y2:0};for(var x=0;x<p.length;x++){d=c[p[x]];if(!d){continue}if(d.x<B.x){B.x=d.x}if(d.y<B.y){B.y=d.y}if(d.x+d.width>B.x2){B.x2=d.x+d.width}if(d.y+d.height>B.y2){B.y2=d.y+d.height}}var C={x:this.previewSize.width/(B.x2-B.x),y:this.previewSize.height/(B.y2-B.y)};C.x=Math.min(C.x,C.y);C.y=Math.min(C.x,C.y);this.skipImages=true;var f=[];for(var x=0;x<p.length;x++){if(!c[p[x]]){continue}var d=$.extend({},c[p[x]]);f.push(d);if(d.widgets&&d.widgets.length>0){var y={};for(var w=0;w<d.widgets.length;w++){y[d.widgets[w]]=z[d.widgets[w]]}}d.widgets=d.widgets.length>0?y:[];d.id=p[x];this.canvasSize=[d.width||320,d.height||480];if(!this.widgetsCache){this.widgetsCache={}}if(!this.pagesCache){this.pagesCache={}}for(var h in d.widgets){if(d.widgets.hasOwnProperty(h)&&d.widgets[h]){d.widgets[h].id=h;d.widgets[h].box=this.calculatePageBox(d,h);this.widgetsCache[h]=d.id}}this.pagesCache[d.id]=d}var e=$.extend({},l.links);var u;var o;var r;for(var x=0;x<e.linkDest.length;x++){if(!this.pagesCache[e.linkDest[x]]){continue}u=this.widgetsCache[e.linkOrigin[x]];if(u===undefined){continue}o={x:this.pagesCache[u].x+this.pagesCache[u].width*0.5,y:this.pagesCache[u].y+this.pagesCache[u].height*0.5};o.x=(o.x-B.x)*C.x;o.y=(o.y-B.y)*C.y;r={x:this.pagesCache[e.linkDest[x]].x+this.pagesCache[e.linkDest[x]].width*0.5,y:this.pagesCache[e.linkDest[x]].y+this.pagesCache[e.linkDest[x]].height*0.5};r.x=(r.x-B.x)*C.x;r.y=(r.y-B.y)*C.y;v.beginPath();v.strokeStyle="#009ecc";v.moveTo(o.x,o.y);v.lineTo(r.x,r.y);v.stroke()}function s(E){d=f[E];A.attr({width:d.width,height:d.height});k.fillStyle="#ffffff";k.fillRect(0,0,d.width,d.height);this.canvasSize=[d.width||320,d.height||480];for(var G in d.widgets){if(d.widgets.hasOwnProperty(G)&&d.widgets[G]){d.widgets[G].id=G;d.widgets[G].box=this.calculatePageBox(d,G)}}v.fillStyle="#ffffff";v.fillRect((d.x-B.x)*C.x,(d.y-B.y)*C.y,d.width*C.x,d.height*C.y);var j=storage.get(f[E].id,{returnModel:true});var F=j?j.get("imgData"):null;if(!j||!F){for(var G in d.widgets){if(d.widgets.hasOwnProperty(G)&&d.widgets[G]){if(d.widgets[G].st&&d.widgets[G].st==="b"){this.pageRenderOne(d.widgets[G])}}}for(var G in d.widgets){if(d.widgets.hasOwnProperty(G)&&d.widgets[G]){if(!d.widgets[G].st||d.widgets[G].st!=="b"){if(!j||!j.getBox()){page.calculateWdgPositions(d.id)}this.pageRenderOne(d.widgets[G])}}}}var D=new Image();if(!j||!F){D.src=A.get(0).toDataURL("image/jpeg")}else{D.src=F}D.onload=(function(K,I,M,L,H,J){v.drawImage(K,I,M,L,H);if(this.canceledPreview&&this.canceledPreview.indexOf(q)!==-1){var i=this.canceledPreview.indexOf(q);this.canceledPreview[i]=null}else{if(E<f.length-1){setTimeout(s.bind(this,E+1),100)}else{fluid.main.fire("thumbnailReady",q,n.get(0));m.call(this,q,n);this.currentProjectId=null}}}).bind(this,D,(d.x-B.x)*C.x,(d.y-B.y)*C.y,d.width*C.x,d.height*C.y,d.id)}if(f.length>0){setTimeout(s.bind(this,0),200)}else{m.call(this,q,n);this.currentProjectId=null}return n};this.flattenRenditions=function(d){if(d.length){var e=[];for(var c=0;c<d.length;c++){e.push(this.flattenRendition(d[c]))}return e}else{return[this.flattenRendition(d)]}};this.flattenRendition=function(d){var h=[];var f=d.childWidgets;var c=d.segments;h.push(d.$rendition);if(f&&f.length){for(var e=0;e<f.length;e++){h=h.concat(this.flattenRendition(f[e]))}}if(c&&c.length){for(e=0;e<c.length;e++){h=h.concat(this.flattenRendition(c[e]))}}return h}};widget.getBlurBox=function(d,b,f){var e,l,j,k;k=storage.get(d,{returnModel:true});if(k&&k.getPage){j=k.getPage().getBox()}else{var h=storage.get(b);j=[0,0,h.width,h.height]}if(k&&k.getBox){l=k.getBox()}else{if(d.indexOf("helper-")===0){l=[0,0,j[2],j[3]]}else{l=[0,0,1,1]}}var a=f*2;l[0]-=f;l[1]-=f;l[2]+=a;l[3]+=a;e=l;for(var c=0;c<2;c++){if(l[c]<0){e[c]=0;e[c+2]=e[c+2]+e[c]}}for(var c=2;c<=3;c++){if(l[c-2]+l[c]>j[c]){e[c]=j[c]-e[c-2]}}return e};widget.renderBlurLayer=function(h,e,n,l){e=e||storage.get(h,{returnModel:true}).getPage().id;var k=storage.get(e),c=document.createElement("canvas"),j=c.getContext("2d"),b=(b=h.match(/^helper-(.+)/))&&b[1],i=(b?widgets.summary[b].blur:widget.get(h).blur),m=widget.getBlurBox(h,e,i);if(m[2]<=0||m[3]<=0){return null}var d=m[0]+m[2],f=m[1]+m[3],a=new fluid.wdgRenderer(d,f);k=a.preparePage(e);c.width=d;c.height=f;a.renderBlur=false;a.useOneCanvas=true;a.pageId=e;a.renderingQueue[e]=[];a.generateCanvas(e);a.ctx.fillStyle="white";a.ctx.fillRect(0,0,a.canvasSize[0],a.canvasSize[1]);a.afterPageRendered=function(o,q){j.drawImage(a.canvas[0],0,0);utils.blur.canvasRGB(c,m[0],m[1],m[2],m[3],i);if(n){try{return n(c.toDataURL(0,0))}catch(p){return l?l(p):p}}};a.renderWidgetsBelow(h,k,!n);j.drawImage(a.canvas[0],0,0);utils.blur.canvasRGB(c,m[0],m[1],m[2],m[3],i);return c.toDataURL()};widget.renderBlurLayerImmediate=function(e,c){c=c||storage.get(e,{returnModel:true}).getPage().id;var b=storage.get(c),a=document.createElement("canvas"),d,h=(h=e.match(/^helper-(.+)/))&&h[1],f=(h?widgets.summary[h].blur:widget.get(e).blur);a.width=b.width;a.height=b.height;d=widget.getBlurBox(e,c,f);if(d[2]<=0||d[3]<=0){return null}if(this.canvases[c]){utils.blur.canvasRGB(a,d[0],d[1],d[2],d[3],f,this.canvases[c].get(0))}else{utils.blur.canvasRGB(a,d[0],d[1],d[2],d[3],f)}return a};widget.setBlurBG=function(e,b,a){var c=widget.blurLayers[e.id];if(c){var d=widget.blurOffsets[e.id];if(!d){d=widget.blurOffsets[e.id]={left:0,top:0}}if(typeof b!=="number"){b=0;a=0;d.left=parseInt(e.style.left,10);d.top=parseInt(e.style.top,10)}e.style.backgroundImage="url("+c+")";e.style.backgroundPosition=-(d.left+b)+"px "+-(d.top+a)+"px";e.style.backgroundRepeat="no-repeat"}else{e.style.backgroundImage="none"}};widget.blurLayers={};widget.blurOffsets={};var page={frame:null,frameVisible:false,menu:null,displayingMenu:false,orient:function(){var a=$(".screen.active");var c=a.attr("id");var b=$(this).val();page.update({orientation:b},c);a.each(page.resizeAfterOrient);page.updateOptionsMenu();hint.show("library");grid.showGrid()},resizeAfterOrient:function(){var c=$(this);var a=c.attr("id");var b=[page.get(a,"height"),page.get(a,"width")];c.css({"width":b[0],"height":b[1]});c.find(".page").css({"width":b[0],"height":b[1]});c.find(".page").children(".widgetHolder").css({"width":b[0],"height":b[1]});page.update({width:b[0],height:b[1]},a);if(fluid.zoom.isEditMode()&&c.hasClass("active")){if($("#"+a).hasClass("active")){page.drawDetailed(a,"init")}}else{page.draw(a,"init")}link.update(c)},updateOptionsMenu:function(){var c=project.getActivePageId();if(typeof c==="undefined"){return}var k=project.get("pageWH");var n=project.get("homepage");var d=page.get(c,"orientation");var i=project.get("orientation");var j=$("#pageMenu");var l=n==c?"This is the start page":"Make this the start page";var o=n==c?"Start page - Home":"";var h=n==c?"homePageOn":"homePageOff";var m=page.get(c,"name");m=m==undefined?"":m;$(".homePageStatusText").text(l);$(".iconPageSettingsIndicator").not(".gridOff, .gridOn, .snapToWidgetsOff, .snapToWidgetsOn").removeClass("homePageOn homePageOff").addClass(h).attr("alt",o).attr("title",o);j.find(".pageSize.rangeWidget.width>input").val(page.get(c,"width"));j.find(".pageSize.rangeWidget.height>input").val(page.get(c,"height"));j.find(".orientationSelector2").find("[value='"+i+"']").attr("selected","selected");var b=j.find(".buttonSwitchContainer");b.children().removeClass("activeOption");b.find("[data-for='"+d+"']").addClass("activeOption");$(".inputPageTitle").val(m);var a=project.get("deviceModel");var f=$("#DeviceSizeTmpl");if(a){$("option[data-type='"+a+"']",f).attr("selected","selected")}else{var p=project.get("pageWH");var e=false;$.each(f.children(),function(q,s){if($(s).val()!="Custom"){var r=$(s).val().split(",");if(((p[0]==r[0])&&(p[1]==r[1]))||((p[0]==r[1])&&(p[1]==r[0]))){$(s).attr("selected","selected");e=true;return false}}});if(!e){$("option[data-type='Custom']",f).attr("selected","selected")}}if($("option:selected",f).val()=="Custom"){$(".screenSize").parents("tr").children().show()}else{$(".screenSize").parents("tr").children().hide()}updateTLWH();var m=page.get(c,"name");grid.selectBackground()},addViaLinkDrop:function(e,l,k,c,j,h){var d=$("#viewport");var a=page.add({x:(d.get(0).scrollLeft+d.width()*0.75),y:(d.get(0).scrollTop+d.height()*0.5)},c,j);if(!a){return}var f="ahref";var i=fluid.zoom.getselectedBeforeZoomOut();var b=link.add(i,a,f);link.draw(b,i,a,f);$(b).fadeIn(600);return a},click:function(c){group.deselect();if(!fluid.zoom.isZoomingNow()&&c.target.tagName!=="TEXTAREA"){var b=$(this).closest(".screen").attr("id");if(!b){b=$(this).closest(".scaled-screen").attr("id").split("-")[1]}var a=c.originalEvent&&$(c.originalEvent.target);if(a&&(a.hasClass("track")||a.hasClass("thumb"))){return}fluid.zoom.zoomToPage({pageId:b,clientX:c.clientX,clientY:c.clientY});fluid.controllers.bin.show()}},makeHome:function(b,a){if(typeof a==="undefined"){a=$(this).closest(".screen")}if($(a).hasClass("template")){return}var c=$(a).attr("id");project.set({homepage:c});page.updateOptionsMenu();$(".scaled-screen").removeClass("homePage");$(a).addClass("homePage")},removeHome:function(a){project.set({homepage:a||null});if(a){$("#scaled-"+a+".scaled-screen").addClass("homePage")}page.updateOptionsMenu()},add:function(e,b,d){if(project.readOnly()){account.alertEditInactive();return false}if(fluid.zoom.isEditMode()){return}var a=$("#cmLink").data("lastClicked")||0;if((new Date()).getTime()<a+600){return}var c=page.create(e.y/fluid.zoom.getCurrentScale(),e.x/fluid.zoom.getCurrentScale());if(project.get("pages").length===1){fluidMenu.setCanvasFirstPage()}return c},correctPageCoords:function(f,e){var a=fluid.zoom.getCurrentScale();var c=project.get("canvasWidth");var d=project.get("canvasHeight");var b=project.get("pageWH");if(e+b[1]>d){e=d-b[1]}if(f+b[0]*a>c){f=c-b[0]}return{left:f,top:e}},create:function(e,f,h,d){var i=project.get("pageWH");var c=project.get("orientation");if(d){if(page.lastCameraY){if(page.lastCameraY===viewport.scrollTop){if(c==="Portrait"){f=page.lastPageX+i[0]+20}else{f=page.lastPageX+i[1]+20}page.lastPageX=f}else{page.lastCameraY=viewport.scrollTop;page.lastPageX=f}}else{page.lastCameraY=viewport.scrollTop;page.lastPageX=f}}var k=page.correctPageCoords(f,e);if(!fluid.main.fire("page.beforeAdd")){return}var a={x:k.left,y:k.top,width:i[0],height:i[1],orientation:c,widgets:[]};var b=utils.guid("x");project.addPage(b);storage.set(b,a);page.template(a,b,h);$("#zoomedOutPages").append('<div id="scaled-'+b+'" class="scaled-screen"></div>');var j=fluid.zoom.getCurrentScale();$("#scaled-"+b).css({top:storage.get(b).y*j,left:storage.get(b).x*j,width:storage.get(b).width*j,height:storage.get(b).height*j});if(!h){$("#scaled-"+b).bounce()}return b},hideOptionsMenu:function(a){page.hideNotes();page.pageMenuClick();$("#pageMenus").children().addClass("hide")},toggleOptionsMenu:function(b){var a=document.getElementById("pageMenu"),c;if(!a){return}c=!a.classList.contains("hide");page.pageMenuClick();page.updateOptionsMenu();page.toggleMenus();if(!c){a.classList.remove("hide")}},toggleSnapSettings:function(){var a=document.getElementById("snapSettingsPanel"),b;b=!a.classList.contains("hide");if(b){page.hideOptionsMenu();return}page.showDefaultSnapOptions()},showDefaultSnapOptions:function(){page.toggleMenus();document.getElementById("snapSettingsPanel").classList.remove("hide");var b=account.get("gridStatus");var a=account.get("snapToWidget");(b=="on")?$("#gridSwitchOn").show():$("#gridSwitchOff").show();(a=="on")?$("#snapSwitchOn").show():$("#snapSwitchOff").show()},resize:function(e,c,j){var h=project.get("pageWH");var i=project.get("orientation");var f=page.get(e,"orientation");if(f!=i){h=[h[1],h[0]]}if((c<h[0])||(isNaN(c))){c=h[0]}else{if(c>h[0]){$(".pageSize").filter(".width").val(c)}}if((j<h[1])||(isNaN(j))){j=h[1]}else{if(j<h[1]){$(".pageSize").filter(".height").val(j)}}var b=$("#"+e+" .page");page.update({width:c,height:j},e);hint.show("library");b.parent(".screen").css({width:c,height:j});b.css({width:c,height:j});b.children(".widgetHolder").css({width:c,height:j});var a=$("#"+e+" .backgroundWidget");var d={top:0,left:0,width:c,height:j};page.autoWidth(b.parent(".screen"));grid.showGrid();return false},get:function(a,c){if(typeof a!="string"){return""}var b=storage.get(a);if(typeof b==="undefined"||!b){return""}return b[c]},updateDragPos:function(f){var h=$(f);var j=fluid.zoom.getCurrentScale();var d=h.attr("id").indexOf("scaled-")!==-1?true:false;var c=d?h.attr("id").split("-")[1]:h.attr("id");if(!h.data().draggable){return}var i=d?h.data().draggable.position.top:Math.round(h.data().draggable.position.top/j);var b=d?h.data().draggable.position.left:Math.round(h.data().draggable.position.left/j);h.data().draggable.position.top=i;h.data().draggable.position.left=b;var a=fluid.main.project.get(c,{returnModel:true});var e=a.getBox();e[0]=b/fluid.zoom.getCurrentScale();e[1]=i/fluid.zoom.getCurrentScale();a.set({box:e},{silent:true});link.update(h);if(intersectTrash(h)==true){$("#trash").addClass("droppableStyle")}else{$("#trash").removeClass("droppableStyle")}},dragStart:function(a){if(project.readOnly()||fluid.zoom.isZoomingNow()){return false}if(fluid.zoom.isEditMode()){$("#canvasLinks").hide()}},drag:function(){page.updateDragPos(this)},dragStop:function(j){var i=$(this);var m=i.position();var h=i.attr("id").indexOf("scaled-")!==-1?true:false;var f=h?i.attr("id").split("-")[1]:i.attr("id");var c=$("#scaled-"+f);var l=storage.get(f);var k=storage.get(project.get("id"));var d=k.canvasWidth-l.width;var b=k.canvasHeight-l.height;var n=fluid.zoom.getCurrentScale();var a=Math.min(Math.max(Math.round(m.left/n),0),d);var o=Math.min(Math.max(Math.round(m.top/n),0),b);fluid.command.create("move",{id:f,x:a,y:o}).dispatchTo("fluid.controllers.page");i.appendTo(i.parent("#canvasPages"));c.appendTo(c.parent("#zoomedOutPages"));link.showahrefs();fluid.zoom.updatePagesBounding();if(fluid.zoom.getCtx()==="page"){fluid.zoom.zoomToPage(f)}if(m.top<0){i.css({top:0})}else{if(m.top/n>b){i.css({top:(k.canvasHeight-l.height)*n})}}if(m.left<0){i.css({left:0})}else{if(m.left/n>d){i.css({left:(k.canvasWidth-l.width)*n})}}},selectStart:function(a){if(project.readOnly()){a.preventDefault();a.stopPropagation();return false}},selectStop:function(b){var a=document.querySelectorAll("#canvasPages .ui-selected");fluid.main.fire("dragselection",a);fluid.zoom.onSelectionChanged();contextMenu.place()},updatePageName:function(){var b=$(this).val(),a=$(this).parents(".screen");if(a.length){page.update({name:b},a.attr("id"))}},template:function(b,h,f){var e=$.extend(true,{},b);e.id=h;var d=page.get(h,"width");var a=page.get(h,"height");e.screenWH=[d,a];var c=$("#tmplPage").tmpl(e).appendTo("#canvasPages");if(e.id===project.get("homepage")){c.addClass("homePage")}},updatePagePreviewButton:function(){var b=$("#pagePreview"),a=$(".canvasObject.active").attr("id");if(a&&storage.get(a).widgets.length){b.stop(true).animate({opacity:1},300);b.css("pointer-events","")}else{b.stop(true).animate({opacity:0},300);b.css("pointer-events","none")}},updateNotesIcon:function(){var b=document.querySelector(".canvasObject.active"),a=document.getElementById("pageAddNote");if(!b||!a){return}var c=storage.get(b.id).notes;if(c&&c[3]){a.classList.add("written")}else{a.classList.remove("written")}},hideNotes:function(){var a=document.getElementById("pageNote");if(!a){return}if(!a.classList.contains("hide")){page.saveNotesInput()}a.classList.add("hide")},showNotes:function(){page.hideOptionsMenu();var a=document.getElementById("pageNote");if(!a){return}page.setNotesTextboxValue();a.classList.remove("hide")},saveNotesInput:function(){var b=$(".canvasObject.active").attr("id"),a=$("#pageNote textarea");page.update({notes:[a.width(),a.height(),"",a.val()]},b);page.updateNotesIcon()},setNotesTextboxValue:function(){var b=document.getElementById("pageNote"),a=document.querySelector(".canvasObject.active").id,c=page.get(a,"notes")||[200,120,"",""];$("textarea",b).css({width:c[0],height:c[1]}).val(c[3])},toggleNotes:function(){var a=document.getElementById("pageNote");if(a.classList.contains("hide")){page.showNotes()}else{page.hideNotes()}},toggleMenus:function(){page.hideOptionsMenu();$("#pageMenus").show()},activate:function(c,b,e,d){var a;if(typeof(c)==="string"){a=c;c=$("#"+c)[0]}else{if($(c).hasClass("scaled-screen")){a=$(c).attr("id").split("-")[1];c=$("#"+a)[0]}}page.deactivate({activatingId:a});function f(){if(canvas2.isZoomedOut()){return}$("#canvasPages .screen.active").not($(c)).add(d).removeClass("active").each(function(){var j=$(this).attr("id");page.draw(j,"init")});$(c).addClass("active");var h=document.querySelector("#canvasPages .active");if(!project.readOnly()&&h){page.attachFrameTo(h)}grid.zoomIn();page.updateOptionsMenu();staticWidgets.zoomInBoundary();var i=b==undefined?true:b;page.displayMenu(i);if($(c).find(".page-preview").length){page.drawDetailed($(c).attr("id"),"init")}if(e==="wdgDrag"){widget.afterSelectionChange()}group.drawExisting(a);fluid.main.fire("pageactivated",a)}f()},deactivate:function(a){var b=$("#canvasPages .screen.active");b.each(function(){if(!a||!a.activatingId||$(this).attr("id")!==a.activatingId){$(this).removeClass("active");$(this).selectable("destroy").removeData("initSelectable");$(this).draggable("destroy").removeData("initDraggable");page.draw($(this).attr("id"),"init")}});page.detachFrame()},detachFrame:function(){if(page.frameVisible){page.frame.parentNode.removeChild(page.frame);page.menu.parentNode.removeChild(page.menu);page.frameVisible=page.displayingMenu=false;page.frame.style.display="none"}},attachFrameTo:function(a){page.frame=page.frame||document.getElementById("pageFrame");page.menu=page.menu||document.getElementById("pageMenus");page.frame.style.display="none";a.appendChild(page.menu);a.querySelector(".page").appendChild(page.frame);page.adjustPageFrameScale(a);page.frameVisible=page.displayingMenu=true;page.setNotesTextboxValue();page.updatePagePreviewButton()},adjustPageFrameScale:function(a){if(!page.frame){return}requestAnimationFrame(function(){var l=fluid.zoom.getCurrentScale();var b=51;var c=$(page.frame).closest(".screen").attr("id");if(!c&&a&&a.id){var h=$(a).find(".page");h.append(page.frame);c=a.id}if(!c){return}var j=storage.get(c).width*l;var k=243;var e=50/l;var d=$("#pageExpander");if(j<k){$("#pageSettingsMenu li").each(function(m){if(m===0){$(this).css({"z-index":1});return}else{if($(this).find("#pageExpander").length){$(this).css({left:40}).show()}else{$(this).css({left:0}).hide()}}});d.add(d.parent("li")).show();d.removeClass("expanded")}else{var i=0;$("#pageSettingsMenu li").each(function(){$(this).css({left:i});i=i+40});$("#pageSettingsMenu li").show();d.addClass("expanded").add(d.parent("li")).hide()}$(".pageBackground").css({"border-radius":(32/l)+"px"});$(".pageDragHandle").css({height:26/l,"border-bottom-width":1/l+"px","border-radius":(32/l)+"px "+(32/l)+"px "+"0 0"});page.frame.style.top=((-86)/l)+"px";page.frame.style.bottom=(-50/l)+"px";page.frame.style.left=(-b/l)+"px";page.frame.style.right=(-b/l)+"px";$("#pageSettingsMenuContainer").css({top:((21/l)+0)+"px",left:e+"px",transform:"scale("+1/l+")","transform-origin":"left top"});$("#pageMenus").css({transform:"scale("+(1/l)+")","transform-origin":"left top",left:(-47/l)+"px",top:(-78/l)+"px"});var f=$("#pageMenu");f.show();$("#"+page.focusedInputId).focus().select();$(page.frame).fadeIn(250)})},onExpanderHovered:function(b){var a=$("#pageExpander");if(b.type==="mouseenter"){a.addClass("visible")}else{if(!a.hasClass("expanded")){a.removeClass("visible")}}},toggleSettingsBtns:function(){var c=$("#pageSettingsMenu li");if(!$(this).hasClass("expanded")){var a=0;var b=$(this).parents(".screen").attr("id");c.each(function(){if($(this).find("#pageExpander").length&&storage.get(b).widgets.length===0){$(this).css({left:a}).show()}else{$(this).css({left:a}).show();a=a+40}});$(this).addClass("expanded")}else{c.each(function(){$(this).css({left:$(this).find("#pageExpander").length?40:0})});$(this).removeClass("expanded");setTimeout(function(){c.not($("#pageExpander").parents("li")).not($("#pageMenuToggle").parents("li")).hide()},300)}},displayMenu:function(b){var d=b==undefined?true:b;var e=true;if((project.readOnly()||(canvas2.isZoomedOut()))){e=false}if(e){page.updateNotesIcon();page.updatePagePreviewButton()}if(d&&e){function c(){if((page.displayingMenu)&&($("#pageSettingsMenuContainer").css("display")=="none")){$("#pageSettingsMenuContainer").fadeIn(300)}page.displayingMenu=false}page.displayingMenu=true;page.displayMenuTimer=setTimeout(c,200)}else{if(e){var a=fluid.selection.getSelectionModel().getRoots().getElements();if((a.length==1)&&($(".ui-selected").hasClass("backgroundWidget"))){page.displayMenu();return}}page.displayingMenu=false;$("#pageSettingsMenuContainer").stop(true,true).hide()}},del:function(b){function a(d){$(d).remove();var c=project.get("pages");if(c.length==0){fluidMenu.setCanvasNoPages(true);fluid.zoom.updatePagesBounding();return}if(!project.hasWidgets()){$("#previewView, #preview, #pagePreview, #shareMenu").addClass("hud-hidden")}if(canvas2.isZoomedOut()){hint.restart()}fluid.zoom.updatePagesBounding()}b.each(function(){var c=$(this);var e=c.attr("id");var f=c.find("#canvasPages .widgetHolder > .pageWidget");f.each(function(){var i=$(this);widget.del(i)});link.remove(c);project.deletePage(e);storage.remove(e);if(e==project.get("homepage")){var h=project.get("pages");var d=h&&h.length?h[0]:null;page.removeHome(d)}c=c.add("#scaled-"+e);c.fadeOut(450,a(c))})},drawRasterised:function(e,d,a,c){page.checkIntegrity(e);var b=page.calculateWdgPositions(e);this.renderer.afterPageRendered=d;if(!b||b.widgets===0){return}this.renderer.renderPage(b,a,c)},draw:function(b,i){if(!b){return}page.checkIntegrity(b);var k=page.calculateWdgPositions(b);if(this.renderer.renderingQueue[k.id]&&this.renderer.renderingQueue[k.id].length){return}this.renderer.afterPageRendered=null;var j=$("#"+b);if(j.length===0){page.template(k,b,i);j=$("#"+b)}else{var a=j.find(".pageWidget");setTimeout(function(){a.remove()},650)}var c=j.find(".widgetHolder");if($("#scaled-"+b).length===0){$("#zoomedOutPages").append('<div id="scaled-'+b+'" class="scaled-screen"></div>');var l=fluid.zoom.getAllPagesParams().newScale;$("#scaled-"+b).css({top:storage.get(b).y*l,left:storage.get(b).x*l,width:storage.get(b).width*l,height:storage.get(b).height*l})}var m=storage.get(b,{returnModel:true}).get("imgData");if(i==="useCache"&&m){j.find(".page-preview, .pageWidget").remove();var f=new Image();f.src=m;var f=new Image();var e=new Image();f.src=m;e.src=m;c.append(f);c.find("img").addClass("page-preview");$("#scaled-"+b).get(0).innerHTML="";$("#scaled-"+b).append(e);return}if(!k){return}else{if(k.widgets.length===0){$("#scaled-"+b).empty();return}}var h=this.renderer.renderPage(k);group.erase();j.find(".page-preview").remove();if(h.length){var d;if(h[0].$shapeRendition){d=h[0].$shapeRendition}else{if(h[0].$textRendition){d=h[0].$textRendition}else{if(h.length&&h[0].segments){d=h[0].segments[0].$shapeRendition}}}if(d){d.addClass("page-preview");c.append(d)}}},calculateWdgPositions:function(d){if(!this.renderer){this.renderer=new fluid.wdgRenderer()}var a=storage.get(d);if(a.widgets&&a.widgets.length>0){var c={};for(var b=0;b<a.widgets.length;b++){c[a.widgets[b]]=widget.get(a.widgets[b])}}a.widgets=c||[];a.id=d;this.renderer.canvasSize=[a.width,a.height];return a},drawDetailed:function(h,f,d){page.calculateWdgPositions(h);var c=$.extend({},storage.get(h));if(!c){return false}var a=$();var b=$("#"+h);if(b.length===0){page.template(c,h,f)}else{a=b.find(".pageWidget")}if(c.widgets.length>0){widget.load(h,c.widgets);updateTLWH()}var e=$("#"+h).find(".page-preview");setTimeout(function(){e.remove()},200);a.remove();if(d&&d.restoreSelection){$("#"+d.restoreSelection).click()}},updateView:function(a,b){var c=true;if(b&&b.zoomedOutOnly){c=false}if(!c&&fluid.zoom.isEditMode()&&$("#"+a).hasClass("active")){page.drawDetailed(a,"init")}else{if(!fluid.zoom.isEditMode()){page.draw(a,"init")}}},move:function(e,a,d){page.update({x:a,y:d},e);var b=$("#"+e);var c=b.position();if(c.left!=a||c.top!=d){b.css({left:a+"px",top:d+"px"});link.update(b)}},update:function(b,d){var a=storage.get(d,{getAll:true});if(!a){return}for(var c in b){a[c]=b[c]}storage.set(d,a)},orderWidgets:function(d){var b=$(d).parents("li.canvasObject").attr("id");var c=$(d).find(".pageWidget");var a=[];c.each(function(){a.push($(this).attr("id"))});page.update({widgets:a},b)},addWidget:function(b,d,a){var c=storage.get(b,{getAll:true});if(a&&a.st&&a.st==="b"){c.widgets.unshift(d)}else{c.widgets.push(d)}storage.set(b,c)},removeWidget:function(a,d){var c=storage.get(a);if(!c){return}var b=$.inArray(d,c.widgets);c.widgets.splice(b,1);storage.set(a,c)},enableSelectableWidgetHolder:function(a){if($(".selectArea").data("selectable")){var c=$(".selectArea").selectable("option","cancel").split(/\s*,\s*/);var b=c.indexOf(".widgetHolder");if(a||a===undefined){if(b>-1){c.splice(b,1);$(".selectArea").selectable("option","cancel",c.join(","))}}else{if(b==-1){c.push(".widgetHolder");$(".selectArea").selectable("option","cancel",c.join(","))}}}},isLinked:function(b,f){var d=fluid.main.project.links.toJSON();var a=page.get(b,"widgets");var e;for(var c=0;c<a.length;c++){e=d.linkOrigin.indexOf(a[c]);if(e!=-1){if(d.linkDest[e]==f){return d.linkCanvId[e]}}}return false},checkIntegrity:function(b){if(b){var c=page.get(b,"widgets");if(c){var a=storage.get(b);$.each(c,function(d,e){if(!widget.checkIntegrity(e,a)){return false}})}}},autoWidth:function(h){var c=$(h).children(".page");var e=$(h).attr("id");var i=c.children(".widgetHolder");var d=i.children(".rootWidget");for(var f=0;f<d.length;f++){var l=$(d[f]);var b=l.attr("id");var k=storage.get(b);if((typeof(k.tlwh[0])==="string")||(typeof(k.tlwh[1])==="string")||(typeof(k.tlwh[2])==="string")||(typeof(k.tlwh[3])==="string")){var a=widget._setTMPLVars(b,k,[0,0,c.width(),c.height()]);l.css({top:a.absTLWH[0],left:a.absTLWH[1],width:a.absTLWH[2],height:a.absTLWH[3]});widget._resize(l,e,a.tlwh)}}link.update($(h))},duplicate:function(e){var a=$("#"+e);var d=$(".page",a);var c=page.get(e,"orientation");var b={top:parseFloat(a.css("top")),left:parseFloat(a.css("left"))+parseFloat(d.css("width"))+100};var f={width:parseFloat(d.css("width")),height:parseFloat(d.css("height"))};var k=page.get(e,"name");var h=k==undefined||k==""?"":k+" - Copy";var j=page.create(b.top,b.left,"init");if(j){var l=$("#"+j);page.update({orientation:c},j);page.update({name:h},j);page.resize(j,f.width,f.height);var m=$.extend(true,{},widget._copies);widget.resetSelection();var i=storage.get(e,{returnModel:true}).get("widgets");widget._copy(null,i,false,e);page.activate(l,false);fluid.zoom.zoomToPage(l);if(widget._copies["oldId"].length>0){widget._paste(null)}widget._copies=$.extend(true,[],m);m=null;widget.resetSelection()}tracker.record("addPageClone",2,j,null);return j},createNew:function(e){var j=$("#canvas");var k=fluid.zoom.getCurrentScale();var b=(e==="button");var i=project.get("pages");var a;e=e||"init";if(fluid.zoom.isEditMode()){var c=$(".screen.active").attr("id");if(!c){if(i.length){c=i[i.length-1]}}if(c){var h=storage.get(c);a={top:h.y,left:h.x+h.width+100}}else{var f=$("#viewport");a={top:Math.abs(parseInt(j.css("top"),10))+Math.round(f.height()/2),left:Math.abs(parseInt(j.css("left"),10))+Math.round(f.width()/2)+450}}}else{var f=$("#viewport");a={top:(f.get(0).scrollTop+Math.round(f.height()/2))/k,left:(f.get(0).scrollLeft+Math.round(f.width()/2))/k};e=""}var d=page.create(a.top,a.left,e,b);if(d){page.postCreate(d)}return d},postCreate:function(c,b){if(!canvas2.isZoomedOut()){var a=$("#"+c);page.activate(a,undefined,b);fluid.zoom.zoomToPage(a);widget.resetSelection()}if(project.get("pages").length==1){fluidMenu.setCanvasFirstPage()}},serialize:function(h){var d=storage.get(h);if(!d){return}var c={id:h};c[h]=d;var f=d.widgets;for(var b=0,a=f.length;b<a;b++){var e=storage.get(f[b]);if(!e){continue}c[f[b]]=e}return JSON.stringify(c)},deserialize:function(i,c){var k=JSON.parse(i);if(k){var a=k.id;var e=k[a];if(!e){return}storage.set(a,e);project.addPage(a);var f=e.widgets;for(var j=0,d=f.length;j<d;j++){var b=f[j];var h=k[b];if(h){storage.set(b,h)}}if(canvas2.isZoomedOut()){page.draw(a,c)}else{page.drawDetailed(a,c)}page.postCreate(a,c)}},navigateWithKeys:function(i){if(canvas2.isZoomedOut()||!canvas2.isEditorVisible()){return true}var j=i!=undefined?utils.getNavigationKeyDirection(i.keyCode):"right";if(j==""){return true}var b=$(".ui-selected").not(".backgroundWidget");if(b.size()>0){return}var c=project.get("pages");if(c<2){return}var f={distance:Number.MAX_VALUE,id:""};var d={distance:0,id:""};var h=$(".screen.active").attr("id");var l={x:page.get(h,"x"),y:page.get(h,"y")};$.each(c,function(m,e){if(h!=e){var o={x:page.get(e,"x"),y:page.get(e,"y")};var n=page._getNavigationDistanceFrom(l,o,j);if((n>=0)&&(n<f.distance)){f={distance:n,id:e}}else{if((n<0)&&(n<d.distance)){d={distance:n,id:e}}}}});var a=f.id!=""?f.id:d.id;if(a!=""){hint.hide();var k=$("#"+a);$(".screen").removeClass("active").filter(k).addClass("active");fluid.zoom.zoomToPage(k);page.activate(k);widget.resetSelection()}},_getNavigationDistanceFrom:function(a,d,c){if(a==d){return -1}var b=0;if((c=="left")||(c=="right")){b=d.x-a.x}else{b=d.y-a.y}if(((c=="left")||(c=="top"))&&(b<0)){return Math.abs(b)}else{if(((c=="right")||(c=="bottom"))&&(b>0)){return b}}return Math.abs(b)*-1},pageMenuClick:function(){$("input","#pageMenus").blur();return false},renderBlurs:function(a){a=a||((a=document.querySelector(".canvasObject.active"))&&a.id);if(!a){return}page.calculateWdgPositions(a);storage.get(a).widgets.forEach(function(b){var c=document.getElementById(b);if(!c){return}if(storage.get(b).blur){widget.blurLayers[b]=widget.renderBlurLayer(b,a);widget.setBlurBG(c)}})},isInViewport:function(c,d){var i=d&&d.mode?d.mode:false;var h=d&&d.withPageFrame?d.withPageFrame:false;var e=fluid.zoom.getCurrentScale();var a=document.getElementById("viewport");var f={left:i==="init"?-project.get("canvasPosX")/e:a.scrollLeft/e,top:i==="init"?-project.get("canvasPosY")/e:a.scrollTop/e,width:window.innerWidth/e,height:window.innerHeight/e};f.right=f.left+f.width;f.bottom=f.top+f.height;if(h&&page.frame&&$(page.frame).parents("#"+c).length){f.left=f.left+50/e;f.right=f.right-50/e;f.bottom=f.bottom-50/e;f.top=f.top+85/e;f.height=f.bottom-f.top;f.width=f.right-f.left}var b=storage.get(c);if(i!=="strict"&&((b.x<=f.right)&&(f.left<=b.x+b.width)&&(b.y<=f.bottom)&&(f.top<=b.y+b.height))){return true}else{if(i==="strict"&&((b.x+b.width<=f.right)&&(f.left<=b.x)&&(b.y+b.height<=f.bottom)&&(f.top<=b.y))){return true}}return false}};