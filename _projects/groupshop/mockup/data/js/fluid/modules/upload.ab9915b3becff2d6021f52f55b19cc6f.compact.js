$(function(){fluid.module.define("fluid.upload",function(e){e.priority={};e.priority.lib=7;e.priority.defaultVal=5;e.priority.pageZoomedOut=3;e.priority.pageZoomedIn=1;var c=6;var a=[];var f=[];var d=document.createElement("canvas"),b=d.getContext("2d");e.get=function(h){if(!h||!h.id){if(!h.callback){return false}else{h.callback({success:false})}}if(!h.priority){h.priority=e.priority.defaultVal}if(h.priority===e.priority.lib){dbStorage.get("uploadThumbs",h.id,function(i,j){if(j.fetched.length){e.onIndexedDBLoad(i,j)}else{dbStorage.get("uploads",i.id,e.onIndexedDBLoad.bind(this,i))}}.bind(this,h))}else{var g=storage.get(h.id,{returnModel:true});if(g&&g.get("imgData")){if(h.image){h.image.onload=function(){h.callback({success:true,id:h.id,priority:h.priority,imgData:g.get("imgData"),image:this})};h.image.src=g.get("imgData")}else{h.callback({success:true,id:h.id,priority:h.priority,imgData:g.get("imgData")})}}else{dbStorage.get("uploads",h.id,e.onIndexedDBLoad.bind(this,h))}}};e.onIndexedDBLoad=function(g,h){if(h.fetched.length){if(!g.image){g.callback({success:true,id:g.id,priority:g.priority,imgData:h.resultsObj[g.id].data})}else{g.image.onload=function(){g.callback({success:true,id:g.id,priority:g.priority,imgData:h.resultsObj[g.id].data,image:this})};g.image.src=h.resultsObj[g.id].data}}else{var i=fluid.util._.findWhere(a,{id:g.id}),j=fluid.util._.findWhere(f,{id:g.id});if(j){j.callback.push(g.callback)}else{if(i){i.callback.push(g.callback);i.priority=Math.min(i.priority,g.priority)}else{a.push({id:g.id,callback:[g.callback],priority:g.priority,image:g.image||null})}}e.startQueue()}};e.startQueue=function(){if(f.length<c&&a.length){a=fluid.util._.sortBy(a,"priority");var h;var g;var i;while(f.length<c&&a.length){i=a.shift();f.push(i);h=f[f.length-1].image||(new Image());g=storage.get(i.id);if(g){h.onload=e.onImageLoad.bind(h,i.id);h.onerror=e.onImageError.bind(h,i.id);if(g.storage==="db"){h.src="data/img/"+i.id}else{h.crossOrigin="Anonymous";h.src=imgCloudUrl+(widgets.summary[i.id].data||i.id)+".png"}f[f.length-1].image=h}}}};e.removeLoadingItem=function(g){f=fluid.util._.filter(f,function(h){if(h.id===g){return false}else{return true}})};e.onImageLoad=function(l,g){var k=fluid.util._.findWhere(f,{id:l});if(k.priority===e.priority.lib){d.height=50;d.width=50;b.fillStyle="#cccccc";b.fillRect(0,0,50,50);if(this.width===0&&this.height===0){b.drawImage(this,0,0)}else{if(this.width<=50&&this.height<=50){b.drawImage(this,25-this.width/2,25-this.height/2-Math.max((34-this.height)/2,0))}else{if(this.width<this.height){b.drawImage(this,0,0,50*this.width/this.height,50)}else{b.drawImage(this,0,0,50,50*this.height/this.width)}}}}else{d.height=this.naturalHeight;d.width=this.naturalWidth;b.clearRect(0,0,this.naturalWidth,this.naturalHeight);b.drawImage(this,0,0)}var j=d.toDataURL("image/png");if(k.callback.length){for(var h=0;h<k.callback.length;h++){k.callback[h]({success:true,image:this,imgData:j,id:k.id})}}if(k.priority===e.priority.lib){dbStorage.set("uploadThumbs",{id:k.id,data:j},function(i){e.removeLoadingItem(l);e.startQueue()})}else{dbStorage.set("uploads",{id:k.id,data:j},function(i){e.removeLoadingItem(l);e.startQueue()})}};e.onImageError=function(k,g){var j=fluid.util._.findWhere(f,{id:k});e.removeLoadingItem(k);if(j.callback.length){for(var h=0;h<j.callback.length;h++){j.callback[h]({success:false,image:this,id:j.id})}}};fluid.event.mixinTo(e)})});